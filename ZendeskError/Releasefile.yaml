# Exported from:        https://release-lipari-devops.group.echonet/
# Release version:      25.1.5-915.934
# Date created:         Fri Dec 19 16:30:02 CET 2025

---
apiVersion: xl-release/v1
kind: Templates
metadata:
  home: AP23882-CARAT-1212/SANDBOX
spec:
  - template: Control-M-AP23882-CARAT-DEPLOY EBX V6
    scheduledStartDate: 2023-07-26T09:00:00+02:00
    dueDate: 2023-07-26T10:00:00+02:00
    phases:
      - phase: prd
        tasks:
          - name: üëâ SET COULOIR
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - ext_chainNum
              - study
          - name: üè≠ SET ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              
              ####get phase name ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              
              ext_env = phase_name[0:3]
              
              ##set env variable from phase_name
              if str(phase_name) == "int":
                  env = "HORSPROD"
                  releaseVariables['api_url_list'] = releaseVariables['api_dev']
                  releaseVariables['hosts'] = releaseVariables['hosts_int']
              if str(phase_name) == "rec":
                  env = "ISOPROD"
                  releaseVariables['api_url_list'] = releaseVariables['api_rec']
                  releaseVariables['hosts'] = releaseVariables['hosts_rec1']
              if str(phase_name) == "ppd":
                  env = "PROD"
                  releaseVariables['api_url_list'] = releaseVariables['api_ppd']
                  releaseVariables['hosts'] = releaseVariables['hosts_ppd']
              if str(phase_name) == "prd":
                  env = "PROD"
                  releaseVariables['api_url_list'] = releaseVariables['api_prd']
                  releaseVariables['hosts'] = releaseVariables['hosts_prd']
              
              releaseVariables['env'] = env
              if ext_env == "prd":
                  releaseVariables['ext_env'] = "prod"
              else:
                  releaseVariables['ext_env'] = ext_env
              
              #Set artifactory file path
              if "SNAPSHOT" in '${version}':
                  type = "SNAPSHOT"
              else:
                  type = "RELEASE"
              
              base_artifact_url = "https://repo.artifactory-dogen.group.echonet/artifactory/"
              artifact_uri = "p-" + '${ext_projectID}' + "-" + '${artifactId}' + "-" + str(type) + "/" + '${artifactPath}' +  "/" + '${moduleName}' + "/" + '${version}' + "/"
              draft_zip_file = '${moduleName}' + "-" + '${version}' + "-" + str(ext_env).upper() + "-C" + '${ext_chainNum}' + ".zip"
              drafts_files_path = str(base_artifact_url) + str(artifact_uri) + str(draft_zip_file)
              releaseVariables['drafts_files_path'] = str(drafts_files_path)
              
              ## Set AAP Inventories
              if not "Rollback" in str(phase_name):
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(env)
                  var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
                  var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
                  releaseVariables[var_inventory_name] = inventory
                  releaseVariables[var_inventory_id] = ""
              
              ## Set other AAP resources if we are in first phase_name
              if releaseVariables['index'] == 0:
                  ## AAP Organization
                  var_orga_id = "AAP-id-" + "organizations"
                  releaseVariables[var_orga_id] = ""
              
                  ## AAP Artifactory credential
                  atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
                  var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
                  var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
                  releaseVariables[var_cred_name] = atifactory_cred
                  releaseVariables[var_cred_id] = ""
              
                  ## AAP Job templates
                  job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
                  var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
                  var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
                  releaseVariables[var_job_template_name] = job_template
                  releaseVariables[var_job_template_id] = ""
              
                  ## AAP Project
                  project = "p-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}'
                  var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
                  var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
                  releaseVariables[var_poject_name] = project
                  releaseVariables[var_poject_id] = ""
              
                  ## AAP Artifactory credentials
                  atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
                  var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
                  var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
                  releaseVariables[var_cred_name] = atifactory_cred
                  releaseVariables[var_cred_id] = ""
              
              
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = str(phase_name) + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: üöß SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES IDs
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                              taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                              taskCheckResource.pythonScript.setProperty("method", 'GET')
                              taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskCheckResource.setTaskFailureHandlerEnabled(True)
                              taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskCheckResource.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskCheckResource)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Set Credential task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + "organizations":
                              organization_id = obj.value
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                              resource_id = obj.value
                              var_name = obj.key
                              resource_type = var_name.split('-')[-1]
                          if obj.key == "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                              resource_name = obj.value
                              credential_type = '24'
                      body = "\"" + "name" + "\"" + ": " + "\"" + str(resource_name) + "\"" + ", " + "\"" + "organization" + "\"" + ": " + str(organization_id) + ", " + "\"" + "credential_type" + "\"" + ": " + str(credential_type) + ", " + "\"" + "inputs" + "\"" + ": { " + "\"" + "artifact_user" + "\"" + ": " + "\"" + "$" + "{" + "user" + "}" + "\"" + ", " + "\"" + "artifact_password" + "\"" + ": " + "\"" + "$" + "{" + "password" + "}" + "\"" + "}"
                      
                      
                      api_put_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                      taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                      taskUpdateResource.pythonScript.setProperty("URL", api_put_url)
                      taskUpdateResource.pythonScript.setProperty("method", 'PUT')
                      taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                      taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                      taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                      taskUpdateResource.title = "Set credential " + " " + str(resource_name)
                      taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      if "Rollback" in str(phase_name):
                          playbook = 'draft_rollback.yaml'
                      else:
                          playbook = 'draft_deploy.yaml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "update " + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
                  from com.xebialabs.xlrelease.api.v1.forms import Variable
                  from com.xebialabs.xlrelease.api.v1 import PhaseApi
                  from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                  
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.sequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  task=0
                  for api_url in ${api_url_list}:
                      deployTask = taskApi.newTask("ansibletower.launchAndWait")
                      if task == 1:
                          deployTask.precondition = "releaseVariables['jobstatus'] == 'Failed'"
                      else:
                          deployTask.variableMapping = {"pythonScript.status" : "$" + "{" + "jobstatus" + "}"}
                          deployTask.setTaskFailureHandlerEnabled(True)
                          deployTask.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                      task += 1
                      extra_vars = ${extra_vars}
                      extra_vars["base_url"] = api_url
                  
                      ##Create task
                      deployTask.title = 'deploy Draft Control-M' + " " + 'on ' + '${ext_env}' + '${ext_chainNum}'
                      deployTask.pythonScript.setProperty("ansibletower", aap_server_config)
                      deployTask.pythonScript.setProperty("job_template_id",job_template_id)
                      deployTask.pythonScript.setProperty("inventory",inventory_id)
                      deployTask.pythonScript.setProperty("extra_vars", extra_vars)
                      deployTask.pythonScript.setProperty("credentials", credential_id)
                  
                  
                      ##Add task in sequential group
                      taskApi.addTask(sequentialGroupId, deployTask)
              - name: üöß DEPLOY GROUP
                type: xlrelease.SequentialGroup
          - name: üõÉVALIDATION
            type: xlrelease.GateTask
            failureHandler: |-
              index = '${index}'
              
              ##Create rollback phase
              index = int(index) + 1
              current_phase = getCurrentPhase()
              newphase = phaseApi.copyPhase(current_phase.id, int(index))
              
              ##update rollback phase title
              newphase.title = phase.title + ' Rollback'
              phaseApi.updatePhase(newphase)
              
              ##Get current phase tasks to skip
              ListOfCurrentPhaseTasksToSkip = []
              for task in current_phase.tasks:
                  if task.status == "PLANNED":
                      ListOfCurrentPhaseTasksToSkip.append(task)
                  if task.status == "FAILURE_HANDLER_IN_PROGRESS":
                      LastTaskToSkip = task
              
              ##Get new phase tasks to skip
              ListOfNewPhaseTasks = []
              for task in newphase.tasks:
                  ListOfNewPhaseTasks.append(task)
              ListOfNewPhaseTasksToSkip = ListOfNewPhaseTasks[0:2]
              
              ##Delete remain phases
              ListOfPhases = []
              for phase in release.phases[int(index):]:
                  ListOfPhases.append(phase)
                  phaseApi.deletePhase(phase.id)
              
              ##Skip tasks (current + new phase)
              ListOfNewPhaseTasksToSkip.reverse()
              ListOfCurrentPhaseTasksToSkip.reverse()
              ListOftasksToSkip = ListOfNewPhaseTasksToSkip + ListOfCurrentPhaseTasksToSkip
              
              for task in ListOftasksToSkip:
                  taskApi.assignTask(task.id, releaseVariables['user'])
                  taskApi.skipTask(task.id, "Rollback")
              
              time.sleep(10)
              
              ##Skip current task
              taskApi.assignTask(LastTaskToSkip.id, releaseVariables['user'])
              taskApi.skipTask(LastTaskToSkip.id, "Rollback")
            taskFailureHandlerEnabled: true
            taskRecoverOp: RUN_SCRIPT
          - name: üëâ DEPLOY TO ANOTHER COULOIR ?
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - other_couloir
          - name: ‚ùì Next couloir or Next environment
            type: xlrelease.ScriptTask
            script: |-
              phase = getCurrentPhase()
              #current_phase = phaseApi.getPhase(phase.id)
              phase_name = phase.title
              
              if releaseVariables['other_couloir'] == 'yes':
              
              
                newphase = phaseApi.copyPhase(phase.id,releaseVariables['index'] )
              
              
                ##update next phase
                newphase.title = phase_name[0:3]
                phaseApi.updatePhase(newphase)
              
                ##Rename promote task
                list_promote_task = getTasksByTitle('Promote to next environment', phaseTitle = phase_name)
                promote_task = list_promote_task[0]
                promote_task.title = 'Promote to next lane'
                taskApi.updateTask(promote_task)
              
              
              ##
              releaseVariables['ext_chainNum'] = ""
          - name: üëâ Promote to next environment
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
          - name: test
            type: jenkins.Build
            jenkinsServer: devopstc-jenkins
            jobName: p-1212-e0511-carat/job/carat-batch-controlm
            branch: develop
        color: "#3d6c9e"
      - phase: rec
        tasks:
          - name: üëâ SET COULOIR
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - ext_chainNum
              - study
          - name: üè≠ SET ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              
              ####get phase name ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title[0:3]
              
              releaseVariables['ext_env'] = str(phase_name)
              
              ##set env variable from phase_name
              if str(phase_name) == "int":
                  env = "HORSPROD"
                  releaseVariables['base_url'] = releaseVariables['api_dev']
                  releaseVariables['hosts'] = releaseVariables['hosts_int']
              if str(phase_name) == "rec":
                  env = "ISOPROD"
                  releaseVariables['base_url'] = releaseVariables['api_rec']
                  releaseVariables['hosts'] = releaseVariables['hosts_rec1']
              if str(phase_name) == "ppd":
                  env = "PROD"
                  releaseVariables['base_url'] = releaseVariables['api_ppd']
                  releaseVariables['hosts'] = releaseVariables['hosts_ppd']
              if str(phase_name) == "prd":
                  env = "PROD"
                  releaseVariables['base_url'] = releaseVariables['api_prd']
                  releaseVariables['hosts'] = releaseVariables['hosts_prd']
              
              releaseVariables['env'] = env
              
              
              
              ## Set AAP Inventories
              inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(env)
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Set other AAP resources if we are in first phase_name
              if releaseVariables['index'] == 0:
                  ## AAP Organization
                  var_orga_id = "AAP-id-" + "organizations"
                  releaseVariables[var_orga_id] = ""
              
                  ## AAP Artifactory credential
                  atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
                  var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
                  var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
                  releaseVariables[var_cred_name] = atifactory_cred
                  releaseVariables[var_cred_id] = ""
              
                  ## AAP Job templates
                  job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
                  var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
                  var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
                  releaseVariables[var_job_template_name] = job_template
                  releaseVariables[var_job_template_id] = ""
              
                  ## AAP Project
                  project = "p-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}'
                  var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
                  var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
                  releaseVariables[var_poject_name] = project
                  releaseVariables[var_poject_id] = ""
              
                  ## AAP Artifactory credentials
                  atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
                  var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
                  var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
                  releaseVariables[var_cred_name] = atifactory_cred
                  releaseVariables[var_cred_id] = ""
              
              
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = str(phase_name) + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
              
              releaseVariables['index'] = releaseVariables['index'] + 1
          - name: üõí GET AAP RESOURCES IDs
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Get AAP Resources Ids task generator
                type: xlrelease.ScriptTask
                script: |-
                  from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "webhook.JsonWebhook".lower():
                          taskApi.delete(child.id)
                  
                  
                  ## get all release variables into list
                  varList = releaseApi.getVariables(release.id)
                  
                  ##get variabble couloir to insert into user input task
                  for obj in varList:
                      if "AAP-name" in obj.key:
                         resource = obj.value
                         var_name = obj.key
                         type = var_name.split('-')[-1]
                         var_resourceId = var_name.replace("name", "id")
                         if releaseVariables[var_resourceId] == "":
                          api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                          taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                          taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                          taskCheckResource.pythonScript.setProperty("method", 'GET')
                          taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                          taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                          taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                          taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                          taskCheckResource.setTaskFailureHandlerEnabled(True)
                          taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                          taskCheckResource.title = "get " + str(type) + " " + str(resource)
                          taskApi.addTask(sequentialGroupId, taskCheckResource)
              - name: üöÄ GET AAP RESOURCES GROUP
                type: xlrelease.SequentialGroup
          - name: üîê SET AAP ARTIFACTORY CREDENTIAL
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Set Credential task generator
                type: xlrelease.ScriptTask
                script: |-
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "webhook.JsonWebhook".lower():
                          taskApi.delete(child.id)
                  
                  ## get all release variables into list
                  varList = releaseApi.getVariables(release.id)
                  
                  
                  for obj in varList:
                      if obj.key == "AAP-id-" + "organizations":
                          organization_id = obj.value
                      if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                          resource_id = obj.value
                          var_name = obj.key
                          resource_type = var_name.split('-')[-1]
                      if obj.key == "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                          resource_name = obj.value
                          credential_type = '24'
                  body = "\"" + "name" + "\"" + ": " + "\"" + str(resource_name) + "\"" + ", " + "\"" + "organization" + "\"" + ": " + str(organization_id) + ", " + "\"" + "credential_type" + "\"" + ": " + str(credential_type) + ", " + "\"" + "inputs" + "\"" + ": { " + "\"" + "artifact_user" + "\"" + ": " + "\"" + "$" + "{" + "user" + "}" + "\"" + ", " + "\"" + "artifact_password" + "\"" + ": " + "\"" + "$" + "{" + "password" + "}" + "\"" + "}"
                  
                  
                  api_put_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                  taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                  taskUpdateResource.pythonScript.setProperty("URL", api_put_url)
                  taskUpdateResource.pythonScript.setProperty("method", 'PUT')
                  taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                  taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                  taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                  taskUpdateResource.title = "Set credential " + " " + str(resource_name)
                  taskApi.addTask(sequentialGroupId, taskUpdateResource)
              - name: üöÄ SET CREDENTIAL GROUP
                type: xlrelease.SequentialGroup
          - name: ‚úç UPDATE AAP RESOURCES
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Update AAP Resources task generator
                type: xlrelease.ScriptTask
                script: |-
                  ####get phase name ###
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "webhook.JsonWebhook".lower():
                          taskApi.delete(child.id)
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  sequentialGroupId = parenttask.getChildren()[1].id
                  
                  ## Set variables for project update
                  scm_url = 'https://gitlab-dogen.group.echonet/gf/itg_itgp/dass/toolchain_cardif_xlr/draft_control-m.git'
                  scm_branch = '${scm_branch}'
                  
                  ## Set variables for job_templae update
                  if "Rollback" in str(phase_name):
                      playbook = 'draft_rollback.yaml'
                  else:
                      playbook = 'draft_deploy.yaml'
                  
                  ## get all release variables into list
                  varList = releaseApi.getVariables(release.id)
                  
                  
                  for obj in varList:
                      if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                          resource_id = obj.value
                          resource_name = obj.key
                          resource_type = resource_name.split('-')[-1]
                          if "projects" in obj.key:
                              body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\""
                          if "job_templates" in obj.key:
                              body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                  
                          api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                          taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                          taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                          taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                          taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                          taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                          taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                          taskUpdateResource.title = "update " + " " + str(resource_name)
                          taskApi.addTask(sequentialGroupId, taskUpdateResource)
              - name: üöÄ UPDATE AAP RESOURCES GROUP
                type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
                  from com.xebialabs.xlrelease.api.v1.forms import Variable
                  from com.xebialabs.xlrelease.api.v1 import PhaseApi
                  
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  
                  
                  ##Create task
                  taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                  taskUpdateReleaseIds.title = 'deploy Draft Control-M' + " " + 'on ' + '${ext_env}' + '${ext_chainNum}'
                  taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                  taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables['extra_vars'])
                  taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                  ##Add task in sequential group
                  taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöÄ DEPLOY GROUP
                type: xlrelease.SequentialGroup
          - name: üõÉVALIDATION
            type: xlrelease.GateTask
            failureHandler: |-
              releaseId = getCurrentRelease().id
              phase = getCurrentPhase()
              phase_name = phase.title
              
              index = '${index}'
              ListOfPhases = phaseApi.searchPhasesByTitle('*', releaseId)
              print ListOfPhases
              for phase in ListOfPhases()[index:]:
                  PhaseToDeleteId = phase.id
                  print PhaseToDeleteId
                  phaseApi.deletePhase(PhaseToDeleteId)
              
              ##Create rollback phase
              newphase = phaseApi.copyPhase(phase.id,releaseVariables['index'] )
              
              
              ##update next phase title
              newphase.title = phase.title + ' Rollback'
              phaseApi.updatePhase(newphase)
            taskFailureHandlerEnabled: true
            taskRecoverOp: RUN_SCRIPT
        color: "#ff9e49"
      - phase: ppd
        tasks:
          - name: üè≠ Set variables
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              ####get the environement variable : int / rec / pprod/ prod ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title[0:3]
              
              env = '${ext_env}'
              myenv = str(env)[0:3]
              if myenv == "ppd":
                  envc = "x"
              else:
              
              ##set envc variable from envir
                  envc = myenv[0]
              releaseVariables['ext_envc'] = envc
              envd = envc.upper()
              releaseVariables['ext_envd'] = envd
              
              ##set env variable from phase_name
              if str(myenv) == "int":
                  releaseVariables['ext_environnement'] = "Integration"
                  releaseVariables['env'] = "HORSPROD"
              if str(myenv) == "rec":
                  releaseVariables['ext_environnement'] = "Recette"
                  releaseVariables['env'] = "ISOPROD"
              if str(myenv) == "ppd":
                  releaseVariables['ext_environnement'] = "PreProduction"
                  releaseVariables['env'] = "PROD"
              if str(myenv) == "prd":
                  releaseVariables['ext_environnement'] = "Production"
                  releaseVariables['env'] = "PROD"
              
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              
              ## Set AAP Inventories
              environment=""
              
              inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(env).upper()
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = '${ext_env}' + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: üîé Get AAP Resources Ids task generator
            type: xlrelease.ScriptTask
            script: |-
              from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
              
              
              ## get id of sequential group to insert tasks into
              sequentialGroupId = None
              parenttask = getCurrentTask().container
              sequentialGroupId_list = []
              for child in parenttask.getChildren():
                  if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                      sequentialGroupId_list.append( child.id)
              sequentialGroupId = sequentialGroupId_list[0]
              
              ## get all release variables into list
              varList = releaseApi.getVariables(release.id)
              
              ##get variabble couloir to insert into user input task
              for obj in varList:
                  if "AAP-name" in obj.key:
                     resource = obj.value
                     var_name = obj.key
                     type = var_name.split('-')[-1]
                     var_resourceId = var_name.replace("name", "id")
                     api_check = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                     taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                     taskCheckResource.pythonScript.setProperty("URL", api_check)
                     taskCheckResource.pythonScript.setProperty("method", 'GET')
                     taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                     taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                     taskCheckResource.pythonScript.setProperty("username", '${user}')
                     taskCheckResource.pythonScript.setProperty("password", '${password}')
                     taskCheckResource.setTaskFailureHandlerEnabled(True)
                     taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                     taskCheckResource.title = "Check " + str(type) + " " + str(resource)
                     taskApi.addTask(sequentialGroupId, taskCheckResource)
          - name: üöÄ GET AAP RESOURCES
            type: xlrelease.SequentialGroup
          - name: üöß Deploy task generator
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              releaseId = getCurrentRelease().id
              
              listFolder = releaseId.split('/')
              FolderId = listFolder[1]
              ServerName = "devopstc-ansibleAutomation-" + '${env}'
              #JobId= 7
              aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
              
              ##get modules to deploy
              sas_list=releaseVariables['modules_todeploy']
              
              
              ####get the environement variable : int / rec / pprod/ prod ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              
              myenv = '${ext_env}'
              my_env = myenv[0:3]
              if str(my_env) == "int" or str(my_env) == "rec":
                  releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper() + "-" + releaseVariables['ext_chainNum']
              if str(my_env) == "ppd" or str(my_env) == "prod" :
                  releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper()
              
              
              
               ## set isRelease variable dynamically
              if "SNAPSHOT" in '':
                  releaseVariables['ext_isRelease'] = "false"
                  releaseVariables['version'] = "SNAPSHOT"
              else:
                  releaseVariables['ext_isRelease'] = "true"
                  releaseVariables['version'] = "RELEASE"
              
              ## get id of sequential group to insert tasks into
              sequentialGroupId = None
              parenttask = getCurrentTask().container
              sequentialGroupId_list = []
              for child in parenttask.getChildren():
                  if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                      sequentialGroupId_list.append( child.id)
              sequentialGroupId = sequentialGroupId_list[1]
              
              #Set AAP resources Ids
              varList = releaseApi.getVariables(release.id)
              
              for obj in varList:
                  if "AAP-id" in obj.key and "credentials" in obj.key:
                      credential_id = obj.value
                  if "AAP-id" in obj.key and "job_templates" in obj.key:
                      job_template_id = obj.value
                  if "AAP-id" in obj.key and "inventories" in obj.key:
                      inventory_id = obj.value
              
              for component in sas_list:
              
                  ##creation de t?che ansible
                    taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                    taskUpdateReleaseIds.title = 'deploy ' + str(component) + " " + ''
                    extravarsName = str(component) + "_extra_vars"
                    taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                    taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                    taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                    taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables[extravarsName])
                    taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
              
              
                  ##ajout de la task ansible sur le group sequential
                    taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
        color: "#d61f21"
      - phase: prd
        tasks:
          - name: üè≠ Set variables
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              ####get the environement variable : int / rec / pprod/ prod ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title[0:3]
              
              env = '${ext_env}'
              myenv = str(env)[0:3]
              if myenv == "ppd":
                  envc = "x"
              else:
              
              ##set envc variable from envir
                  envc = myenv[0]
              releaseVariables['ext_envc'] = envc
              envd = envc.upper()
              releaseVariables['ext_envd'] = envd
              
              ##set env variable from phase_name
              if str(myenv) == "int":
                  releaseVariables['ext_environnement'] = "Integration"
                  releaseVariables['env'] = "HORSPROD"
              if str(myenv) == "rec":
                  releaseVariables['ext_environnement'] = "Recette"
                  releaseVariables['env'] = "ISOPROD"
              if str(myenv) == "ppd":
                  releaseVariables['ext_environnement'] = "PreProduction"
                  releaseVariables['env'] = "PROD"
              if str(myenv) == "prd":
                  releaseVariables['ext_environnement'] = "Production"
                  releaseVariables['env'] = "PROD"
              
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              
              ## Set AAP Inventories
              environment=""
              
              inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(env).upper()
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = '${ext_env}' + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: üîé Get AAP Resources Ids task generator
            type: xlrelease.ScriptTask
            script: |-
              from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
              
              
              ## get id of sequential group to insert tasks into
              sequentialGroupId = None
              parenttask = getCurrentTask().container
              sequentialGroupId_list = []
              for child in parenttask.getChildren():
                  if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                      sequentialGroupId_list.append( child.id)
              sequentialGroupId = sequentialGroupId_list[0]
              
              ## get all release variables into list
              varList = releaseApi.getVariables(release.id)
              
              ##get variabble couloir to insert into user input task
              for obj in varList:
                  if "AAP-name" in obj.key:
                     resource = obj.value
                     var_name = obj.key
                     type = var_name.split('-')[-1]
                     var_resourceId = var_name.replace("name", "id")
                     api_check = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                     taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                     taskCheckResource.pythonScript.setProperty("URL", api_check)
                     taskCheckResource.pythonScript.setProperty("method", 'GET')
                     taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                     taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                     taskCheckResource.pythonScript.setProperty("username", '${user}')
                     taskCheckResource.pythonScript.setProperty("password", '${password}')
                     taskCheckResource.setTaskFailureHandlerEnabled(True)
                     taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                     taskCheckResource.title = "Check " + str(type) + " " + str(resource)
                     taskApi.addTask(sequentialGroupId, taskCheckResource)
          - name: üöÄ GET AAP RESOURCES
            type: xlrelease.SequentialGroup
          - name: üöß Deploy task generator
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              releaseId = getCurrentRelease().id
              
              listFolder = releaseId.split('/')
              FolderId = listFolder[1]
              ServerName = "devopstc-ansibleAutomation-" + '${env}'
              #JobId= 7
              aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
              
              ##get modules to deploy
              sas_list=releaseVariables['modules_todeploy']
              
              
              ####get the environement variable : int / rec / pprod/ prod ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              
              myenv = '${ext_env}'
              my_env = myenv[0:3]
              if str(my_env) == "int" or str(my_env) == "rec":
                  releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper() + "-" + releaseVariables['ext_chainNum']
              if str(my_env) == "ppd" or str(my_env) == "prod" :
                  releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper()
              
              
              
               ## set isRelease variable dynamically
              if "SNAPSHOT" in '':
                  releaseVariables['ext_isRelease'] = "false"
                  releaseVariables['version'] = "SNAPSHOT"
              else:
                  releaseVariables['ext_isRelease'] = "true"
                  releaseVariables['version'] = "RELEASE"
              
              ## get id of sequential group to insert tasks into
              sequentialGroupId = None
              parenttask = getCurrentTask().container
              sequentialGroupId_list = []
              for child in parenttask.getChildren():
                  if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                      sequentialGroupId_list.append( child.id)
              sequentialGroupId = sequentialGroupId_list[1]
              
              #Set AAP resources Ids
              varList = releaseApi.getVariables(release.id)
              
              for obj in varList:
                  if "AAP-id" in obj.key and "credentials" in obj.key:
                      credential_id = obj.value
                  if "AAP-id" in obj.key and "job_templates" in obj.key:
                      job_template_id = obj.value
                  if "AAP-id" in obj.key and "inventories" in obj.key:
                      inventory_id = obj.value
              
              for component in sas_list:
              
                  ##creation de t?che ansible
                    taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                    taskUpdateReleaseIds.title = 'deploy ' + str(component) + " " + ''
                    extravarsName = str(component) + "_extra_vars"
                    taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                    taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                    taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                    taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables[extravarsName])
                    taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
              
              
                  ##ajout de la task ansible sur le group sequential
                    taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
        color: "#498500"
    variables:
      - type: xlrelease.StringVariable
        key: AAP-name-organizations
        requiresValue: false
        showOnReleaseStart: false
        label: AAP organization
        value: CARDIF_GDA-OPS
      - type: xlrelease.StringVariable
        key: pipeline
        requiresValue: false
        showOnReleaseStart: false
        label: Devops space pipeline
        value: deploy_carat_ctrlm_xlr
      - type: xlrelease.StringVariable
        key: scm_url
        showOnReleaseStart: false
        value: https://gitlab-dogen.group.echonet/gf/itg_itgp/dass/toolchain_cardif_xlr/draft_control-m.git
      - type: xlrelease.StringVariable
        key: scm_branch
        showOnReleaseStart: false
        label: branch
        value: toolchain_v3.2
      - type: xlrelease.StringVariable
        key: ext_chainNum
        showOnReleaseStart: false
        label: couloir
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "01"
            - "02"
      - type: xlrelease.StringVariable
        key: user
        label: UID
      - type: xlrelease.PasswordStringVariable
        key: password
        label: Password
      - type: xlrelease.StringVariable
        key: env
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ext_env
        requiresValue: false
        showOnReleaseStart: false
        label: Environment
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - int
            - rec
            - ppd
            - prd
        value: int
      - type: xlrelease.StringVariable
        key: ap_code
        requiresValue: false
        showOnReleaseStart: false
        value: AP23882
      - type: xlrelease.StringVariable
        key: trigram
        requiresValue: false
        showOnReleaseStart: false
        value: rat
      - type: xlrelease.StringVariable
        key: code5car
        requiresValue: false
        showOnReleaseStart: false
        value: rat00
      - type: xlrelease.StringVariable
        key: ext_projectID
        requiresValue: false
        showOnReleaseStart: false
        value: "1212"
      - type: xlrelease.ListStringVariable
        key: hosts_int
        showOnReleaseStart: false
        value:
          - s02vl9904804
      - type: xlrelease.ListStringVariable
        key: hosts_rec1
        showOnReleaseStart: false
        value:
          - s02vl9904789.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_rec2
        showOnReleaseStart: false
        value:
          - s02vl9904790.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_ppd
        showOnReleaseStart: false
        value:
          - s02vl9904787.fr.net.intra
          - s02vl9904788.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_prd
        showOnReleaseStart: false
        value:
          - s02vl9904792
      - type: xlrelease.StringVariable
        key: drafts_files_path
        requiresValue: false
        showOnReleaseStart: false
        label: control-m draft url
      - type: xlrelease.StringVariable
        key: study_prefix
        showOnReleaseStart: false
        value: ETUDES_
      - type: xlrelease.StringVariable
        key: study
        showOnReleaseStart: false
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "true"
            - "false"
      - type: xlrelease.BooleanVariable
        key: rollback
        showOnReleaseStart: false
      - type: xlrelease.MapStringStringVariable
        key: extra_vars
        showOnReleaseStart: false
        value:
          ext_chainNum: "${ext_chainNum}"
          ext_projectID: "${ext_projectID}"
          base_url: ""
          env: "${env}"
          ap_code: "${ap_code}"
          application_code: "${ap_code}"
          code5car: "${code5car}"
          trigram: "${trigram}"
          ext_env: "${ext_env}"
          study: "${study}"
          hosts: "${hosts}"
          study_prefix: "${study_prefix}"
          drafts_files_path: "${drafts_files_path}"
      - type: xlrelease.StringVariable
        key: base_url
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: other_couloir
        requiresValue: false
        showOnReleaseStart: false
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "yes"
            - "no"
      - type: xlrelease.IntegerVariable
        key: index
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.ListStringVariable
        key: hosts
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: artifactId
        requiresValue: false
        showOnReleaseStart: false
        value: maven
      - type: xlrelease.StringVariable
        key: artifactPath
        requiresValue: false
        showOnReleaseStart: false
        value: com/bnpcardif/carat/controlm
      - type: xlrelease.StringVariable
        key: moduleName
        requiresValue: false
        showOnReleaseStart: false
        value: carat_BATCH_CONTROLM
      - type: xlrelease.StringVariable
        key: version
      - type: xlrelease.ListStringVariable
        key: api_dev
        requiresValue: false
        showOnReleaseStart: false
        value:
          - https://s01vl9913955.fr.net.intra:8443/automation-api
          - https://s01vl9913958.fr.net.intra:8443/automation-api
      - type: xlrelease.ListStringVariable
        key: api_rec
        requiresValue: false
        showOnReleaseStart: false
        value:
          - https://s01vl9913067.fr.net.intra:8443/automation-api
          - https://s01vl9913068.fr.net.intra:8443/automation-api
      - type: xlrelease.ListStringVariable
        key: api_ppd
        requiresValue: false
        showOnReleaseStart: false
        value:
          - https://s01vl9913126.fr.net.intra:8443/automation-api
          - https://s01vl9913127.fr.net.intra:8443/automation-api
      - type: xlrelease.ListStringVariable
        key: api_prd
        requiresValue: false
        showOnReleaseStart: false
        value:
          - https://s01vl9913128.fr.net.intra:8443/automation-api
          - https://s01vl9913130.fr.net.intra:8443/automation-api
      - type: xlrelease.ListStringVariable
        key: api_url_list
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: jobstatus
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: AAP_Execute_Role_id
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: AAP_Inventory_Admin_Role_id
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: AAP_Credentials_Admin_Role_id
        requiresValue: false
        showOnReleaseStart: false
    allowPasswordsInAllFields: true
    scriptUsername: RunAsUser
    variableMapping:
      scriptUserPassword: "${global.RunAsUserPassword}"
    riskProfile: Default risk profile
  - template: Control-M-AP23882-CARAT-DEPLOY EBX V6 (1)
    scheduledStartDate: 2023-07-26T09:00:00+02:00
    dueDate: 2023-07-26T10:00:00+02:00
    phases:
      - phase: prd
        tasks:
          - name: üëâ SET COULOIR
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - ext_chainNum
              - study
          - name: üè≠ SET ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              
              ####get phase name ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              
              ext_env = phase_name[0:3]
              
              ##set env variable from phase_name
              if str(phase_name) == "int":
                  env = "HORSPROD"
                  releaseVariables['api_url_list'] = releaseVariables['api_dev']
                  releaseVariables['hosts'] = releaseVariables['hosts_int']
              if str(phase_name) == "rec":
                  env = "ISOPROD"
                  releaseVariables['api_url_list'] = releaseVariables['api_rec']
                  releaseVariables['hosts'] = releaseVariables['hosts_rec1']
              if str(phase_name) == "ppd":
                  env = "PROD"
                  releaseVariables['api_url_list'] = releaseVariables['api_ppd']
                  releaseVariables['hosts'] = releaseVariables['hosts_ppd']
              if str(phase_name) == "prd":
                  env = "PROD"
                  releaseVariables['api_url_list'] = releaseVariables['api_prd']
                  releaseVariables['hosts'] = releaseVariables['hosts_prd']
              
              releaseVariables['env'] = env
              
              if ext_env == "prd":
                  myenv = "prod"
                  releaseVariables['ext_env'] = myenv
              else:
                  myenv = ext_env
                  releaseVariables['ext_env'] = ext_env
              
              #Set artifactory file path
              if "SNAPSHOT" in '${version}':
                  type = "SNAPSHOT"
              else:
                  type = "RELEASE"
              
              base_artifact_url = "https://repo.artifactory-dogen.group.echonet/artifactory/"
              artifact_uri = "p-" + '${ext_projectID}' + "-" + '${artifactId}' + "-" + str(type) + "/" + '${artifactPath}' +  "/" + '${moduleName}' + "/" + '${version}' + "/"
              draft_zip_file = '${moduleName}' + "-" + '${version}' + "-" + str(myenv).upper() + "-C" + '${ext_chainNum}' + ".zip"
              drafts_files_path = str(base_artifact_url) + str(artifact_uri) + str(draft_zip_file)
              releaseVariables['drafts_files_path'] = str(drafts_files_path)
              
              ## Set AAP Inventories
              if not "Rollback" in str(phase_name):
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(env)
                  var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
                  var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
                  releaseVariables[var_inventory_name] = inventory
                  releaseVariables[var_inventory_id] = ""
              
              ## Set other AAP resources if we are in first phase_name
              if releaseVariables['index'] == 0:
                  ## AAP Organization
                  var_orga_id = "AAP-id-" + "organizations"
                  releaseVariables[var_orga_id] = ""
              
                  ## AAP Artifactory credential
                  atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
                  var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
                  var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
                  releaseVariables[var_cred_name] = atifactory_cred
                  releaseVariables[var_cred_id] = ""
              
                  ## AAP Job templates
                  job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
                  var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
                  var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
                  releaseVariables[var_job_template_name] = job_template
                  releaseVariables[var_job_template_id] = ""
              
                  ## AAP Project
                  project = "p-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}'
                  var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
                  var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
                  releaseVariables[var_poject_name] = project
                  releaseVariables[var_poject_id] = ""
              
                  ## AAP Artifactory credentials
                  atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
                  var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
                  var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
                  releaseVariables[var_cred_name] = atifactory_cred
                  releaseVariables[var_cred_id] = ""
              
              
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = str(phase_name) + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: üöß SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES IDs
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskGetResourceId = taskApi.newTask("webhook.JsonWebhook")
                              taskGetResourceId.pythonScript.setProperty("URL", api_check_url)
                              taskGetResourceId.pythonScript.setProperty("method", 'GET')
                              taskGetResourceId.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskGetResourceId.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskGetResourceId.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskGetResourceId.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskGetResourceId.setTaskFailureHandlerEnabled(True)
                              taskGetResourceId.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskGetResourceId.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskGetResourceId)
                      
                          if "AAP-name" in obj.key and "organizations" in obj.key:
                              resource = obj.value
                              var_name = obj.key
                              type = var_name.split('-')[-1]
                              var_resourceId = var_name.replace("name", "id")
                              if releaseVariables[var_resourceId] == "":
                                  list_roles = ['AAP_Execute_Role_id', 'AAP_Inventory_Admin_Role_id', 'AAP_Credentials_Admin_Role_id']
                                  for role in list_roles:
                                      if role == "AAP_Execute_Role_id":
                                          jsonpath = ".results[0].summary_fields.object_roles.execute_role.id"
                                      if role == "AAP_Inventory_Admin_Role_id":
                                          jsonpath = ".results[0].summary_fields.object_roles.inventory_admin_role.id"
                                      if role == "AAP_Credentials_Admin_Role_id":
                                          jsonpath = ".results[0].summary_fields.object_roles.credential_admin_role.id"
                                      api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                                      taskGetRolesId = taskApi.newTask("webhook.JsonWebhook")
                                      taskGetRolesId.pythonScript.setProperty("URL", api_check_url)
                                      taskGetRolesId.pythonScript.setProperty("method", 'GET')
                                      taskGetRolesId.pythonScript.setProperty("jsonPathExpression", "$" + str(jsonpath))
                                      taskGetRolesId.variableMapping = {"pythonScript.result": "$" + "{" + str(role) + "}"}
                                      taskGetRolesId.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                                      taskGetRolesId.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                                      taskGetRolesId.setTaskFailureHandlerEnabled(True)
                                      taskGetRolesId.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                                      taskGetRolesId.title = "get Role Id " + str(type) + " " + str(resource) + " " + str(role)
                                      taskApi.addTask(sequentialGroupId, taskGetRolesId)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Set Credential task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + "organizations":
                              organization_id = obj.value
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                              resource_id = obj.value
                              var_name = obj.key
                              resource_type = var_name.split('-')[-1]
                          if obj.key == "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                              resource_name = obj.value
                              credential_type = '24'
                      body = "\"" + "name" + "\"" + ": " + "\"" + str(resource_name) + "\"" + ", " + "\"" + "organization" + "\"" + ": " + str(organization_id) + ", " + "\"" + "credential_type" + "\"" + ": " + str(credential_type) + ", " + "\"" + "inputs" + "\"" + ": { " + "\"" + "artifact_user" + "\"" + ": " + "\"" + "$" + "{" + "user" + "}" + "\"" + ", " + "\"" + "artifact_password" + "\"" + ": " + "\"" + "$" + "{" + "password" + "}" + "\"" + "}"
                      
                      
                      api_put_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                      taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                      taskUpdateResource.pythonScript.setProperty("URL", api_put_url)
                      taskUpdateResource.pythonScript.setProperty("method", 'PUT')
                      taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                      taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                      taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                      taskUpdateResource.title = "Set credential " + " " + str(resource_name)
                      taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      if "Rollback" in str(phase_name):
                          playbook = 'draft_rollback.yaml'
                      else:
                          playbook = 'draft_deploy.yaml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "Update" + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                      
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-teams":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              list_roles = ['AAP_Execute_Role_id', 'AAP_Inventory_Admin_Role_id', 'AAP_Credentials_Admin_Role_id']
                              for role in list_roles:
                                  role_id = releaseVariables[role]
                                  body = "\"" + "id" + "\"" + ": " + str(role_id)
                      
                                  api_post_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/" + "roles" + "/"
                                  taskUpdateTeam = taskApi.newTask("webhook.JsonWebhook")
                                  taskUpdateTeam.pythonScript.setProperty("URL", api_post_url)
                                  taskUpdateTeam.pythonScript.setProperty("method", 'POST')
                                  taskUpdateTeam.pythonScript.setProperty("body", "{" + str(body) + "}")
                                  taskUpdateTeam.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                                  taskUpdateTeam.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                                  taskUpdateTeam.title = "Update" + " " + str(resource_type) + str(resource_name) + str(role)
                                  taskApi.addTask(sequentialGroupId, taskUpdateTeam)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
                  from com.xebialabs.xlrelease.api.v1.forms import Variable
                  from com.xebialabs.xlrelease.api.v1 import PhaseApi
                  from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                  
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.sequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  task=0
                  for api_url in ${api_url_list}:
                      deployTask = taskApi.newTask("ansibletower.launchAndWait")
                      if task == 1:
                          deployTask.precondition = "releaseVariables['jobstatus'] == 'Failed'"
                      else:
                          deployTask.variableMapping = {"pythonScript.status" : "$" + "{" + "jobstatus" + "}"}
                          deployTask.setTaskFailureHandlerEnabled(True)
                          deployTask.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                      task += 1
                      extra_vars = ${extra_vars}
                      extra_vars["base_url"] = api_url
                  
                      ##Create task
                      deployTask.title = 'deploy Draft Control-M' + " " + 'on ' + '${ext_env}' + '${ext_chainNum}'
                      deployTask.pythonScript.setProperty("ansibletower", aap_server_config)
                      deployTask.pythonScript.setProperty("job_template_id",job_template_id)
                      deployTask.pythonScript.setProperty("inventory",inventory_id)
                      deployTask.pythonScript.setProperty("extra_vars", extra_vars)
                      deployTask.pythonScript.setProperty("credentials", credential_id)
                  
                  
                      ##Add task in sequential group
                      taskApi.addTask(sequentialGroupId, deployTask)
              - name: üöß DEPLOY GROUP
                type: xlrelease.SequentialGroup
          - name: üõÉVALIDATION
            type: xlrelease.GateTask
            failureHandler: |-
              index = '${index}'
              
              ##Create rollback phase
              index = int(index) + 1
              current_phase = getCurrentPhase()
              newphase = phaseApi.copyPhase(current_phase.id, int(index))
              
              ##update rollback phase title
              newphase.title = phase.title + ' Rollback'
              phaseApi.updatePhase(newphase)
              
              ##Get current phase tasks to skip
              ListOfCurrentPhaseTasksToSkip = []
              for task in current_phase.tasks:
                  if task.status == "PLANNED":
                      ListOfCurrentPhaseTasksToSkip.append(task)
                  if task.status == "FAILURE_HANDLER_IN_PROGRESS":
                      LastTaskToSkip = task
              
              ##Get new phase tasks to skip
              ListOfNewPhaseTasks = []
              for task in newphase.tasks:
                  ListOfNewPhaseTasks.append(task)
              ListOfNewPhaseTasksToSkip = ListOfNewPhaseTasks[0:2]
              
              ##Delete remain phases
              ListOfPhases = []
              for phase in release.phases[int(index):]:
                  ListOfPhases.append(phase)
                  phaseApi.deletePhase(phase.id)
              
              ##Skip tasks (current + new phase)
              ListOfNewPhaseTasksToSkip.reverse()
              ListOfCurrentPhaseTasksToSkip.reverse()
              ListOftasksToSkip = ListOfNewPhaseTasksToSkip + ListOfCurrentPhaseTasksToSkip
              
              for task in ListOftasksToSkip:
                  taskApi.assignTask(task.id, releaseVariables['user'])
                  taskApi.skipTask(task.id, "Rollback")
              
              time.sleep(10)
              
              ##Skip current task
              taskApi.assignTask(LastTaskToSkip.id, releaseVariables['user'])
              taskApi.skipTask(LastTaskToSkip.id, "Rollback")
            taskFailureHandlerEnabled: true
            taskRecoverOp: RUN_SCRIPT
          - name: üëâ DEPLOY TO ANOTHER COULOIR ?
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - other_couloir
          - name: ‚ùì Next couloir or Next environment
            type: xlrelease.ScriptTask
            script: |-
              phase = getCurrentPhase()
              #current_phase = phaseApi.getPhase(phase.id)
              phase_name = phase.title
              
              if releaseVariables['other_couloir'] == 'yes':
              
              
                newphase = phaseApi.copyPhase(phase.id,releaseVariables['index'] )
              
              
                ##update next phase
                newphase.title = phase_name[0:3]
                phaseApi.updatePhase(newphase)
              
                ##Rename promote task
                list_promote_task = getTasksByTitle('Promote to next environment', phaseTitle = phase_name)
                promote_task = list_promote_task[0]
                promote_task.title = 'Promote to next lane'
                taskApi.updateTask(promote_task)
              
              
              ##
              releaseVariables['ext_chainNum'] = ""
          - name: üëâ Promote to next environment
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
          - name: test
            type: jenkins.Build
            jenkinsServer: devopstc-jenkins
            jobName: p-1212-e0511-carat/job/carat-batch-controlm
            branch: develop
        color: "#3d6c9e"
      - phase: rec
        tasks:
          - name: üëâ SET COULOIR
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - ext_chainNum
              - study
          - name: üè≠ SET ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              
              ####get phase name ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title[0:3]
              
              releaseVariables['ext_env'] = str(phase_name)
              
              ##set env variable from phase_name
              if str(phase_name) == "int":
                  env = "HORSPROD"
                  releaseVariables['base_url'] = releaseVariables['api_dev']
                  releaseVariables['hosts'] = releaseVariables['hosts_int']
              if str(phase_name) == "rec":
                  env = "ISOPROD"
                  releaseVariables['base_url'] = releaseVariables['api_rec']
                  releaseVariables['hosts'] = releaseVariables['hosts_rec1']
              if str(phase_name) == "ppd":
                  env = "PROD"
                  releaseVariables['base_url'] = releaseVariables['api_ppd']
                  releaseVariables['hosts'] = releaseVariables['hosts_ppd']
              if str(phase_name) == "prd":
                  env = "PROD"
                  releaseVariables['base_url'] = releaseVariables['api_prd']
                  releaseVariables['hosts'] = releaseVariables['hosts_prd']
              
              releaseVariables['env'] = env
              
              
              
              ## Set AAP Inventories
              inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(env)
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Set other AAP resources if we are in first phase_name
              if releaseVariables['index'] == 0:
                  ## AAP Organization
                  var_orga_id = "AAP-id-" + "organizations"
                  releaseVariables[var_orga_id] = ""
              
                  ## AAP Artifactory credential
                  atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
                  var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
                  var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
                  releaseVariables[var_cred_name] = atifactory_cred
                  releaseVariables[var_cred_id] = ""
              
                  ## AAP Job templates
                  job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
                  var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
                  var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
                  releaseVariables[var_job_template_name] = job_template
                  releaseVariables[var_job_template_id] = ""
              
                  ## AAP Project
                  project = "p-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}'
                  var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
                  var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
                  releaseVariables[var_poject_name] = project
                  releaseVariables[var_poject_id] = ""
              
                  ## AAP Artifactory credentials
                  atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
                  var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
                  var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
                  releaseVariables[var_cred_name] = atifactory_cred
                  releaseVariables[var_cred_id] = ""
              
              
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = str(phase_name) + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
              
              releaseVariables['index'] = releaseVariables['index'] + 1
          - name: üõí GET AAP RESOURCES IDs
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Get AAP Resources Ids task generator
                type: xlrelease.ScriptTask
                script: |-
                  from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "webhook.JsonWebhook".lower():
                          taskApi.delete(child.id)
                  
                  
                  ## get all release variables into list
                  varList = releaseApi.getVariables(release.id)
                  
                  ##get variabble couloir to insert into user input task
                  for obj in varList:
                      if "AAP-name" in obj.key:
                         resource = obj.value
                         var_name = obj.key
                         type = var_name.split('-')[-1]
                         var_resourceId = var_name.replace("name", "id")
                         if releaseVariables[var_resourceId] == "":
                          api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                          taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                          taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                          taskCheckResource.pythonScript.setProperty("method", 'GET')
                          taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                          taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                          taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                          taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                          taskCheckResource.setTaskFailureHandlerEnabled(True)
                          taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                          taskCheckResource.title = "get " + str(type) + " " + str(resource)
                          taskApi.addTask(sequentialGroupId, taskCheckResource)
              - name: üöÄ GET AAP RESOURCES GROUP
                type: xlrelease.SequentialGroup
          - name: üîê SET AAP ARTIFACTORY CREDENTIAL
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Set Credential task generator
                type: xlrelease.ScriptTask
                script: |-
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "webhook.JsonWebhook".lower():
                          taskApi.delete(child.id)
                  
                  ## get all release variables into list
                  varList = releaseApi.getVariables(release.id)
                  
                  
                  for obj in varList:
                      if obj.key == "AAP-id-" + "organizations":
                          organization_id = obj.value
                      if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                          resource_id = obj.value
                          var_name = obj.key
                          resource_type = var_name.split('-')[-1]
                      if obj.key == "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                          resource_name = obj.value
                          credential_type = '24'
                  body = "\"" + "name" + "\"" + ": " + "\"" + str(resource_name) + "\"" + ", " + "\"" + "organization" + "\"" + ": " + str(organization_id) + ", " + "\"" + "credential_type" + "\"" + ": " + str(credential_type) + ", " + "\"" + "inputs" + "\"" + ": { " + "\"" + "artifact_user" + "\"" + ": " + "\"" + "$" + "{" + "user" + "}" + "\"" + ", " + "\"" + "artifact_password" + "\"" + ": " + "\"" + "$" + "{" + "password" + "}" + "\"" + "}"
                  
                  
                  api_put_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                  taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                  taskUpdateResource.pythonScript.setProperty("URL", api_put_url)
                  taskUpdateResource.pythonScript.setProperty("method", 'PUT')
                  taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                  taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                  taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                  taskUpdateResource.title = "Set credential " + " " + str(resource_name)
                  taskApi.addTask(sequentialGroupId, taskUpdateResource)
              - name: üöÄ SET CREDENTIAL GROUP
                type: xlrelease.SequentialGroup
          - name: ‚úç UPDATE AAP RESOURCES
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Update AAP Resources task generator
                type: xlrelease.ScriptTask
                script: |-
                  ####get phase name ###
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "webhook.JsonWebhook".lower():
                          taskApi.delete(child.id)
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  sequentialGroupId = parenttask.getChildren()[1].id
                  
                  ## Set variables for project update
                  scm_url = 'https://gitlab-dogen.group.echonet/gf/itg_itgp/dass/toolchain_cardif_xlr/draft_control-m.git'
                  scm_branch = '${scm_branch}'
                  
                  ## Set variables for job_templae update
                  if "Rollback" in str(phase_name):
                      playbook = 'draft_rollback.yaml'
                  else:
                      playbook = 'draft_deploy.yaml'
                  
                  ## get all release variables into list
                  varList = releaseApi.getVariables(release.id)
                  
                  
                  for obj in varList:
                      if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                          resource_id = obj.value
                          resource_name = obj.key
                          resource_type = resource_name.split('-')[-1]
                          if "projects" in obj.key:
                              body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\""
                          if "job_templates" in obj.key:
                              body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                  
                          api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                          taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                          taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                          taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                          taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                          taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                          taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                          taskUpdateResource.title = "update " + " " + str(resource_name)
                          taskApi.addTask(sequentialGroupId, taskUpdateResource)
              - name: üöÄ UPDATE AAP RESOURCES GROUP
                type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
                  from com.xebialabs.xlrelease.api.v1.forms import Variable
                  from com.xebialabs.xlrelease.api.v1 import PhaseApi
                  
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  
                  
                  ##Create task
                  taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                  taskUpdateReleaseIds.title = 'deploy Draft Control-M' + " " + 'on ' + '${ext_env}' + '${ext_chainNum}'
                  taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                  taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables['extra_vars'])
                  taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                  ##Add task in sequential group
                  taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöÄ DEPLOY GROUP
                type: xlrelease.SequentialGroup
          - name: üõÉVALIDATION
            type: xlrelease.GateTask
            failureHandler: |-
              releaseId = getCurrentRelease().id
              phase = getCurrentPhase()
              phase_name = phase.title
              
              index = '${index}'
              ListOfPhases = phaseApi.searchPhasesByTitle('*', releaseId)
              print ListOfPhases
              for phase in ListOfPhases()[index:]:
                  PhaseToDeleteId = phase.id
                  print PhaseToDeleteId
                  phaseApi.deletePhase(PhaseToDeleteId)
              
              ##Create rollback phase
              newphase = phaseApi.copyPhase(phase.id,releaseVariables['index'] )
              
              
              ##update next phase title
              newphase.title = phase.title + ' Rollback'
              phaseApi.updatePhase(newphase)
            taskFailureHandlerEnabled: true
            taskRecoverOp: RUN_SCRIPT
        color: "#ff9e49"
      - phase: ppd
        tasks:
          - name: üè≠ Set variables
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              ####get the environement variable : int / rec / pprod/ prod ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title[0:3]
              
              env = '${ext_env}'
              myenv = str(env)[0:3]
              if myenv == "ppd":
                  envc = "x"
              else:
              
              ##set envc variable from envir
                  envc = myenv[0]
              releaseVariables['ext_envc'] = envc
              envd = envc.upper()
              releaseVariables['ext_envd'] = envd
              
              ##set env variable from phase_name
              if str(myenv) == "int":
                  releaseVariables['ext_environnement'] = "Integration"
                  releaseVariables['env'] = "HORSPROD"
              if str(myenv) == "rec":
                  releaseVariables['ext_environnement'] = "Recette"
                  releaseVariables['env'] = "ISOPROD"
              if str(myenv) == "ppd":
                  releaseVariables['ext_environnement'] = "PreProduction"
                  releaseVariables['env'] = "PROD"
              if str(myenv) == "prd":
                  releaseVariables['ext_environnement'] = "Production"
                  releaseVariables['env'] = "PROD"
              
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              
              ## Set AAP Inventories
              environment=""
              
              inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(env).upper()
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = '${ext_env}' + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: üîé Get AAP Resources Ids task generator
            type: xlrelease.ScriptTask
            script: |-
              from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
              
              
              ## get id of sequential group to insert tasks into
              sequentialGroupId = None
              parenttask = getCurrentTask().container
              sequentialGroupId_list = []
              for child in parenttask.getChildren():
                  if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                      sequentialGroupId_list.append( child.id)
              sequentialGroupId = sequentialGroupId_list[0]
              
              ## get all release variables into list
              varList = releaseApi.getVariables(release.id)
              
              ##get variabble couloir to insert into user input task
              for obj in varList:
                  if "AAP-name" in obj.key:
                     resource = obj.value
                     var_name = obj.key
                     type = var_name.split('-')[-1]
                     var_resourceId = var_name.replace("name", "id")
                     api_check = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                     taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                     taskCheckResource.pythonScript.setProperty("URL", api_check)
                     taskCheckResource.pythonScript.setProperty("method", 'GET')
                     taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                     taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                     taskCheckResource.pythonScript.setProperty("username", '${user}')
                     taskCheckResource.pythonScript.setProperty("password", '${password}')
                     taskCheckResource.setTaskFailureHandlerEnabled(True)
                     taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                     taskCheckResource.title = "Check " + str(type) + " " + str(resource)
                     taskApi.addTask(sequentialGroupId, taskCheckResource)
          - name: üöÄ GET AAP RESOURCES
            type: xlrelease.SequentialGroup
          - name: üöß Deploy task generator
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              releaseId = getCurrentRelease().id
              
              listFolder = releaseId.split('/')
              FolderId = listFolder[1]
              ServerName = "devopstc-ansibleAutomation-" + '${env}'
              #JobId= 7
              aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
              
              ##get modules to deploy
              sas_list=releaseVariables['modules_todeploy']
              
              
              ####get the environement variable : int / rec / pprod/ prod ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              
              myenv = '${ext_env}'
              my_env = myenv[0:3]
              if str(my_env) == "int" or str(my_env) == "rec":
                  releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper() + "-" + releaseVariables['ext_chainNum']
              if str(my_env) == "ppd" or str(my_env) == "prod" :
                  releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper()
              
              
              
               ## set isRelease variable dynamically
              if "SNAPSHOT" in '':
                  releaseVariables['ext_isRelease'] = "false"
                  releaseVariables['version'] = "SNAPSHOT"
              else:
                  releaseVariables['ext_isRelease'] = "true"
                  releaseVariables['version'] = "RELEASE"
              
              ## get id of sequential group to insert tasks into
              sequentialGroupId = None
              parenttask = getCurrentTask().container
              sequentialGroupId_list = []
              for child in parenttask.getChildren():
                  if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                      sequentialGroupId_list.append( child.id)
              sequentialGroupId = sequentialGroupId_list[1]
              
              #Set AAP resources Ids
              varList = releaseApi.getVariables(release.id)
              
              for obj in varList:
                  if "AAP-id" in obj.key and "credentials" in obj.key:
                      credential_id = obj.value
                  if "AAP-id" in obj.key and "job_templates" in obj.key:
                      job_template_id = obj.value
                  if "AAP-id" in obj.key and "inventories" in obj.key:
                      inventory_id = obj.value
              
              for component in sas_list:
              
                  ##creation de t?che ansible
                    taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                    taskUpdateReleaseIds.title = 'deploy ' + str(component) + " " + ''
                    extravarsName = str(component) + "_extra_vars"
                    taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                    taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                    taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                    taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables[extravarsName])
                    taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
              
              
                  ##ajout de la task ansible sur le group sequential
                    taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
        color: "#d61f21"
      - phase: prd
        tasks:
          - name: üè≠ Set variables
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              ####get the environement variable : int / rec / pprod/ prod ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title[0:3]
              
              env = '${ext_env}'
              myenv = str(env)[0:3]
              if myenv == "ppd":
                  envc = "x"
              else:
              
              ##set envc variable from envir
                  envc = myenv[0]
              releaseVariables['ext_envc'] = envc
              envd = envc.upper()
              releaseVariables['ext_envd'] = envd
              
              ##set env variable from phase_name
              if str(myenv) == "int":
                  releaseVariables['ext_environnement'] = "Integration"
                  releaseVariables['env'] = "HORSPROD"
              if str(myenv) == "rec":
                  releaseVariables['ext_environnement'] = "Recette"
                  releaseVariables['env'] = "ISOPROD"
              if str(myenv) == "ppd":
                  releaseVariables['ext_environnement'] = "PreProduction"
                  releaseVariables['env'] = "PROD"
              if str(myenv) == "prd":
                  releaseVariables['ext_environnement'] = "Production"
                  releaseVariables['env'] = "PROD"
              
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              
              ## Set AAP Inventories
              environment=""
              
              inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(env).upper()
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = '${ext_env}' + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: üîé Get AAP Resources Ids task generator
            type: xlrelease.ScriptTask
            script: |-
              from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
              
              
              ## get id of sequential group to insert tasks into
              sequentialGroupId = None
              parenttask = getCurrentTask().container
              sequentialGroupId_list = []
              for child in parenttask.getChildren():
                  if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                      sequentialGroupId_list.append( child.id)
              sequentialGroupId = sequentialGroupId_list[0]
              
              ## get all release variables into list
              varList = releaseApi.getVariables(release.id)
              
              ##get variabble couloir to insert into user input task
              for obj in varList:
                  if "AAP-name" in obj.key:
                     resource = obj.value
                     var_name = obj.key
                     type = var_name.split('-')[-1]
                     var_resourceId = var_name.replace("name", "id")
                     api_check = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                     taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                     taskCheckResource.pythonScript.setProperty("URL", api_check)
                     taskCheckResource.pythonScript.setProperty("method", 'GET')
                     taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                     taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                     taskCheckResource.pythonScript.setProperty("username", '${user}')
                     taskCheckResource.pythonScript.setProperty("password", '${password}')
                     taskCheckResource.setTaskFailureHandlerEnabled(True)
                     taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                     taskCheckResource.title = "Check " + str(type) + " " + str(resource)
                     taskApi.addTask(sequentialGroupId, taskCheckResource)
          - name: üöÄ GET AAP RESOURCES
            type: xlrelease.SequentialGroup
          - name: üöß Deploy task generator
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              releaseId = getCurrentRelease().id
              
              listFolder = releaseId.split('/')
              FolderId = listFolder[1]
              ServerName = "devopstc-ansibleAutomation-" + '${env}'
              #JobId= 7
              aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
              
              ##get modules to deploy
              sas_list=releaseVariables['modules_todeploy']
              
              
              ####get the environement variable : int / rec / pprod/ prod ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              
              myenv = '${ext_env}'
              my_env = myenv[0:3]
              if str(my_env) == "int" or str(my_env) == "rec":
                  releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper() + "-" + releaseVariables['ext_chainNum']
              if str(my_env) == "ppd" or str(my_env) == "prod" :
                  releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper()
              
              
              
               ## set isRelease variable dynamically
              if "SNAPSHOT" in '':
                  releaseVariables['ext_isRelease'] = "false"
                  releaseVariables['version'] = "SNAPSHOT"
              else:
                  releaseVariables['ext_isRelease'] = "true"
                  releaseVariables['version'] = "RELEASE"
              
              ## get id of sequential group to insert tasks into
              sequentialGroupId = None
              parenttask = getCurrentTask().container
              sequentialGroupId_list = []
              for child in parenttask.getChildren():
                  if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                      sequentialGroupId_list.append( child.id)
              sequentialGroupId = sequentialGroupId_list[1]
              
              #Set AAP resources Ids
              varList = releaseApi.getVariables(release.id)
              
              for obj in varList:
                  if "AAP-id" in obj.key and "credentials" in obj.key:
                      credential_id = obj.value
                  if "AAP-id" in obj.key and "job_templates" in obj.key:
                      job_template_id = obj.value
                  if "AAP-id" in obj.key and "inventories" in obj.key:
                      inventory_id = obj.value
              
              for component in sas_list:
              
                  ##creation de t?che ansible
                    taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                    taskUpdateReleaseIds.title = 'deploy ' + str(component) + " " + ''
                    extravarsName = str(component) + "_extra_vars"
                    taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                    taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                    taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                    taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables[extravarsName])
                    taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
              
              
                  ##ajout de la task ansible sur le group sequential
                    taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
        color: "#498500"
    variables:
      - type: xlrelease.StringVariable
        key: AAP-name-organizations
        requiresValue: false
        showOnReleaseStart: false
        label: AAP organization
        value: CARDIF_GDA-OPS
      - type: xlrelease.StringVariable
        key: pipeline
        requiresValue: false
        showOnReleaseStart: false
        label: Devops space pipeline
        value: deploy_carat_ctrlm_xlr
      - type: xlrelease.StringVariable
        key: scm_url
        showOnReleaseStart: false
        value: https://gitlab-dogen.group.echonet/gf/itg_itgp/dass/toolchain_cardif_xlr/draft_control-m.git
      - type: xlrelease.StringVariable
        key: scm_branch
        showOnReleaseStart: false
        label: branch
        value: toolchain_v3.2
      - type: xlrelease.StringVariable
        key: ext_chainNum
        showOnReleaseStart: false
        label: couloir
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "01"
            - "02"
      - type: xlrelease.StringVariable
        key: user
        label: UID
      - type: xlrelease.PasswordStringVariable
        key: password
        label: Password
      - type: xlrelease.StringVariable
        key: env
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ext_env
        requiresValue: false
        showOnReleaseStart: false
        label: Environment
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - int
            - rec
            - ppd
            - prd
        value: int
      - type: xlrelease.StringVariable
        key: ap_code
        requiresValue: false
        showOnReleaseStart: false
        value: AP23882
      - type: xlrelease.StringVariable
        key: trigram
        requiresValue: false
        showOnReleaseStart: false
        value: rat
      - type: xlrelease.StringVariable
        key: code5car
        requiresValue: false
        showOnReleaseStart: false
        value: rat00
      - type: xlrelease.StringVariable
        key: ext_projectID
        requiresValue: false
        showOnReleaseStart: false
        value: "1212"
      - type: xlrelease.ListStringVariable
        key: hosts_int
        showOnReleaseStart: false
        value:
          - s02vl9904804
      - type: xlrelease.ListStringVariable
        key: hosts_rec1
        showOnReleaseStart: false
        value:
          - s02vl9904789.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_rec2
        showOnReleaseStart: false
        value:
          - s02vl9904790.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_ppd
        showOnReleaseStart: false
        value:
          - s02vl9904787.fr.net.intra
          - s02vl9904788.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_prd
        showOnReleaseStart: false
        value:
          - s02vl9904792
      - type: xlrelease.StringVariable
        key: drafts_files_path
        requiresValue: false
        showOnReleaseStart: false
        label: control-m draft url
      - type: xlrelease.StringVariable
        key: study_prefix
        showOnReleaseStart: false
        value: ETUDES_
      - type: xlrelease.StringVariable
        key: study
        showOnReleaseStart: false
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "true"
            - "false"
      - type: xlrelease.BooleanVariable
        key: rollback
        showOnReleaseStart: false
      - type: xlrelease.MapStringStringVariable
        key: extra_vars
        showOnReleaseStart: false
        value:
          ext_chainNum: "${ext_chainNum}"
          ext_projectID: "${ext_projectID}"
          base_url: ""
          env: "${env}"
          ap_code: "${ap_code}"
          application_code: "${ap_code}"
          code5car: "${code5car}"
          trigram: "${trigram}"
          ext_env: "${ext_env}"
          study: "${study}"
          hosts: "${hosts}"
          study_prefix: "${study_prefix}"
          drafts_files_path: "${drafts_files_path}"
      - type: xlrelease.StringVariable
        key: base_url
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: other_couloir
        requiresValue: false
        showOnReleaseStart: false
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "yes"
            - "no"
      - type: xlrelease.IntegerVariable
        key: index
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.ListStringVariable
        key: hosts
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: artifactId
        requiresValue: false
        showOnReleaseStart: false
        value: maven
      - type: xlrelease.StringVariable
        key: artifactPath
        requiresValue: false
        showOnReleaseStart: false
        value: com/bnpcardif/carat/controlm
      - type: xlrelease.StringVariable
        key: moduleName
        requiresValue: false
        showOnReleaseStart: false
        value: carat_BATCH_CONTROLM
      - type: xlrelease.StringVariable
        key: version
      - type: xlrelease.ListStringVariable
        key: api_dev
        requiresValue: false
        showOnReleaseStart: false
        value:
          - https://s01vl9913955.fr.net.intra:8443/automation-api
          - https://s01vl9913958.fr.net.intra:8443/automation-api
      - type: xlrelease.ListStringVariable
        key: api_rec
        requiresValue: false
        showOnReleaseStart: false
        value:
          - https://s01vl9913067.fr.net.intra:8443/automation-api
          - https://s01vl9913068.fr.net.intra:8443/automation-api
      - type: xlrelease.ListStringVariable
        key: api_ppd
        requiresValue: false
        showOnReleaseStart: false
        value:
          - https://s01vl9913126.fr.net.intra:8443/automation-api
          - https://s01vl9913127.fr.net.intra:8443/automation-api
      - type: xlrelease.ListStringVariable
        key: api_prd
        requiresValue: false
        showOnReleaseStart: false
        value:
          - https://s01vl9913130.fr.net.intra:8443/automation-api
      - type: xlrelease.ListStringVariable
        key: api_url_list
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: jobstatus
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: AAP_Execute_Role_id
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: AAP_Inventory_Admin_Role_id
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: AAP_Credentials_Admin_Role_id
        requiresValue: false
        showOnReleaseStart: false
    allowPasswordsInAllFields: true
    scriptUsername: RunAsUser
    variableMapping:
      scriptUserPassword: "${global.RunAsUserPassword}"
    riskProfile: Default risk profile
  - template: DRAFT-CONTROL-M v3.2
    description: Draft Control-m Offer.
    scheduledStartDate: 2023-10-18T09:00:00+02:00
    dueDate: 2023-10-18T10:00:00+02:00
    phases:
      - phase: int
        tasks:
          - name: Variables settings
            type: xlrelease.SequentialGroup
            tasks:
              - name: Environment variables
                type: xlrelease.ScriptTask
                script: |-
                  #from com.xebialabs.xlrelease.api.v1
                  #import ReleaseApi
                  
                  # get phase name / environment
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  releaseVariables['ext_env'] = phase_name
                  
                  # Attribute phase name to env variable
                  if str(phase_name) == "dev" or str(phase_name) == 'int':
                      releaseVariables['env'] = "HORSPROD"
                  if str(phase_name) == "rec":
                      releaseVariables['env'] = "ISOPROD"
                  if str(phase_name) == 'ppd' or str(phase_name) == 'prod':
                      releaseVariables['env'] = "PROD"
                  
                  #Attribute hosts according to environment
                  if str(phase_name) == "dev":
                    releaseVariables['hosts'] = releaseVariables['hosts_dev']
                  if str(phase_name) == "rec":
                    releaseVariables['hosts'] = releaseVariables['hosts_rec']
                  if str(phase_name) == "int":
                    releaseVariables['hosts'] = releaseVariables['hosts_int']
                  if str(phase_name) == "ppd":
                    releaseVariables['hosts'] = releaseVariables['hosts_ppd']
                  if str(phase_name) == "prd":
                    releaseVariables['hosts'] = releaseVariables['hosts_prd']
              - name: Set Credential
                type: xlrelease.UserInputTask
                description: Please enter the required information below.
                variables:
                  - artifact_user
                  - artifact_password
              - name: Configure Ansible Creds
                type: webhook.JsonWebhook
                URL: https://ansible-devops.group.echonet/api/v2/credentials/8571/
                method: PUT
                body: |-
                  {
                      "name": "cr-AP06578-draft_control-m-3440",
                      "description": "Credential for AP06578-draft_control-m-3440",
                      "organization": 48,
                      "credential_type": 24,
                      "inputs": {
                          "artifact_user": "${artifact_user}",
                          "artifact_password": "${artifact_password}"
                      }
                  }
                username: "${artifact_user}"
                variableMapping:
                  pythonScript.password: "${artifact_password}"
                locked: true
          - name: RUN PLAYBOOK ANSIBLE
            type: ansibletower.launchAndWait
            ansibletower: devopstc-ansibleAutomation-HORSPROD
            job_template_id: j-AP06531-deploy_aple_control-mdev-2559-CARDIF_DDH-DEV
            extra_vars:
              base_url: "${base_url}"
              ext_projectID: "${projectID}"
              env: "${env}"
              ap_code: "${ap_code}"
              application_code: "${ap_code}"
              code5car: "${code5car}"
              ext_chainNum: "${chainNum}"
              trigram: "${trigram}"
              ext_env: "${ext_env}"
              study: "${study}"
              hosts: "${hosts}"
              study_prefix: "${study_prefix}"
              drafts_files_path: "${drafts_files_path}"
            credentials:
              - "${cred_artifactory}"
            locked: true
          - name: Rollback
            type: xlrelease.SequentialGroup
            tasks:
              - name: Do you want a rollback ?
                type: xlrelease.UserInputTask
                description: Please enter the required information below.
                variables:
                  - rollback
              - name: RUN Rollback ANSIBLE
                type: ansibletower.launchAndWait
                ansibletower: devopstc-ansibleAutomation-HORSPROD
                job_template_id: j-AP06531-deploy_aple_control-mdev-2559-CARDIF_DDH-DEVRollBack
                extra_vars:
                  base_url: "${base_url}"
                  ext_projectID: "${projectID}"
                  env: "${env}"
                  ap_code: "${ap_code}"
                  application_code: "${ap_code}"
                  code5car: "${code5car}"
                  ext_chainNum: "${chainNum}"
                  trigram: "${trigram}"
                  ext_env: "${ext_env}"
                  study: "${study}"
                  hosts: "${hosts}"
                  study_prefix: "${study_prefix}"
                  drafts_files_path: "${drafts_files_path}"
                credentials:
                  - "${cred_artifactory}"
                precondition: "releaseVariables['rollback'] == True"
                locked: true
          - name: Empty Ansible Creds
            type: webhook.JsonWebhook
            URL: https://ansible-devops.group.echonet/api/v2/credentials/8571/
            method: PUT
            body: |-
              {
                  "name": "cr-AP06578-draft_control-m-3440",
                  "description": "Credential for AP06578-draft_control-m-3440",
                  "organization": 48,
                  "credential_type": 24,
                  "inputs": {
                      "artifact_user": "empty",
                      "artifact_password": "empty"
                  }
              }
            username: "${artifact_user}"
            variableMapping:
              pythonScript.password: "${artifact_password}"
            locked: true
        color: "#3d6c9e"
    variables:
      - type: xlrelease.ListStringVariable
        key: hosts
        showOnReleaseStart: false
        label: Nom du serveur AGENT
      - type: xlrelease.ListStringVariable
        key: hosts_int
        showOnReleaseStart: false
        label: Nom du serveur AGENT pour l'int
        value:
          - S01VL9980440.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_rec
        showOnReleaseStart: false
        label: Nom du serveur AGENT pour la rec
        value:
          - S01VL9972571.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_ppd
        showOnReleaseStart: false
        label: Nom du serveur AGENT pour la ppd
        value:
          - S01VL9973626.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_prd
        showOnReleaseStart: false
        label: Nom du serveur AGENT pour la prd
      - type: xlrelease.StringVariable
        key: trigram
        showOnReleaseStart: false
        label: Trigram de l'application (variable ctrlm)
        value: apl
      - type: xlrelease.StringVariable
        key: ap_code
        showOnReleaseStart: false
        label: Code ap de l'application
        value: AP06531
      - type: xlrelease.StringVariable
        key: code5car
        showOnReleaseStart: false
        label: Pentagramme de l'application
        value: aple0
      - type: xlrelease.StringVariable
        key: env
        label: Environnement  Ansible
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - ISOPROD
            - HORSPROD
            - PROD
        value: HORSPROD
      - type: xlrelease.StringVariable
        key: ext_env
        showOnReleaseStart: false
        label: Environment
        value: int
      - type: xlrelease.StringVariable
        key: drafts_files_path
        label: Url des drafts dans artifactory
      - type: xlrelease.StringVariable
        key: study_prefix
        showOnReleaseStart: false
        label: Prefix etude
        value: ETUDES_
      - type: xlrelease.StringVariable
        key: study
        label: Validation de l'etude
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "true"
            - "false"
        value: "false"
      - type: xlrelease.StringVariable
        key: projectID
        showOnReleaseStart: false
        label: ID du projet
        value: "2559"
      - type: xlrelease.StringVariable
        key: base_url
        label: Url de l'api controlM
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - https://s01vl9930755.fr.net.intra:8443/automation-api
            - https://s01vl9913955.fr.net.intra:8443/automation-api
            - https://s01vl9913067.fr.net.intra:8443/automation-api
            - https://s01vl9913958.fr.net.intra:8443/automation-api
      - type: xlrelease.StringVariable
        key: cred_artifactory
        showOnReleaseStart: false
        label: Ansible Credential ID
        value: "9835"
      - type: xlrelease.StringVariable
        key: chainNum
        showOnReleaseStart: false
        label: Numero du couloir
        value: "02"
      - type: xlrelease.BooleanVariable
        key: rollback
        showOnReleaseStart: false
        label: Do you want a rollback ?
      - type: xlrelease.StringVariable
        key: artifact_user
        requiresValue: false
        showOnReleaseStart: false
        label: Login de l'Utilisateur
      - type: xlrelease.PasswordStringVariable
        key: artifact_password
        requiresValue: false
        showOnReleaseStart: false
        label: Mot de passe Utilisateur
    allowPasswordsInAllFields: true
    scriptUsername: runasuser
    variableMapping:
      scriptUserPassword: "${global.RunAsUserPassword}"
    riskProfile: Default risk profile
  - template: INFOLIVRE
    description: InfoLivre Offer.
    scheduledStartDate: 2023-10-18T09:00:00+02:00
    dueDate: 2023-10-18T10:00:00+02:00
    phases:
      - phase: INT
        tasks:
          - name: Set Credential
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - artifactory_user
              - artifactory_pwd
          - name: Configure Ansible Creds
            type: webhook.JsonWebhook
            URL: https://ansible-devops.group.echonet/api/v2/credentials/8570/
            method: PUT
            body: |-
              {
                  "name": "cr-AP06578-infolivre-ansiblev2-3440",
                  "description": "Credential for AP06578-infolivre-ansiblev2-3440",
                  "organization": 48,
                  "credential_type": 24,
                  "inputs": {
                      "artifact_user": "${artifact_user}",
                      "artifact_password": "${artifact_pwd}"
                  }
              }
            username: "${artifact_user}"
            variableMapping:
              pythonScript.password: "${artifactory_pwd}"
            locked: true
          - name: RUN PLAYBOOK CREATE COULOIR
            type: ansibletower.launchAndWait
            ansibletower: devopstc-ansibleAutomation-HORSPROD
            job_template_id: j-AP06578-create_couloir-ansiblev2-3440-CARDIF-DEV
            extra_vars:
              ext_repo_user: "${artifactory_user}"
              ext_appAction: "${appAction}"
              ext_projectID: "${projectID}"
              ext_modlib: "${modlib}"
              env: "${env}"
              ext_envc: "${ext_envc}"
              ap_code: "${ap_code}"
              ext_envd: "${ext_envd}"
              ext_serveurs: "${ext_serveurs}"
              code5car: "${code5car}"
              ext_chainNum: "${chainNum}"
              trigram: "${trigram}"
              ext_env: "${ext_env}"
              codeAP: "${ap_code}"
              ext_appFullName: "${appFullName}"
              ext_appName: "${appName}"
              ext_appOptArgs: "${ext_appOptArgs}"
              ext_repo_passwd: ""
          - name: RUN PLAYBOOK INFOLIVRE
            type: ansibletower.launchAndWait
            ansibletower: devopstc-ansibleAutomation-HORSPROD
            job_template_id: j-AP06578-infolivre-ansiblev2-3440-CARDIF-DEV
            extra_vars:
              repo_pwd: "${artifactory_pwd}"
              repo_user: "${artifactory_user}"
          - name: Empty Ansible Creds
            type: webhook.JsonWebhook
            URL: https://ansible-devops.group.echonet/api/v2/credentials/8570/
            method: PUT
            body: |-
              {
                  "name": "cr-AP06578-infolivre-ansiblev2-3440",
                  "description": "Credential for AP06578-infolivre-ansiblev2-3440",
                  "organization": 48,
                  "credential_type": 24,
                  "inputs": {
                      "artifact_user": "empty",
                      "artifact_password": "empty"
                  }
              }
            username: "${artifact_user}"
            variableMapping:
              pythonScript.password: "${artifactory_pwd}"
            locked: true
        color: "#3d6c9e"
    variables:
      - type: xlrelease.StringVariable
        key: env
        label: Environnement  Ansible
        value: HORSPROD
      - type: xlrelease.StringVariable
        key: ap_code
        showOnReleaseStart: false
        label: Code ap de l'application
        value: "23882"
      - type: xlrelease.StringVariable
        key: trigram
        label: Trigram de l'application (variable ctrlm)
        value: cte
      - type: xlrelease.StringVariable
        key: code5car
        label: Pentagramme de l'application
        value: cteam
      - type: xlrelease.StringVariable
        key: ext_binary_url
        label: URL directe du ZIP en cas de CI diforme
        value: NONE
      - type: xlrelease.StringVariable
        key: artifactPath
        label: Chemin de l'artefact
        value: com/bnppa/ic/config
      - type: xlrelease.StringVariable
        key: appFullName
        label: Type d'installation de l'application
        value: socle
      - type: xlrelease.StringVariable
        key: appAction
        label: Action en cour
        value: create_couloir
      - type: xlrelease.StringVariable
        key: ext_serveurs
        label: Serveur inpactes
        value: servers_socle
      - type: xlrelease.StringVariable
        key: chainNum
        label: Numero de couloir
        value: "02"
      - type: xlrelease.StringVariable
        key: ext_appOptArgs
        label: Forcer l'update
        value: force
      - type: xlrelease.StringVariable
        key: projectID
        label: ID du projet
        value: "3440"
      - type: xlrelease.StringVariable
        key: ext_env
        label: Type de couloir
        value: dev
      - type: xlrelease.StringVariable
        key: ext_envc
        label: "Premi?re lettre, minuscule, type de couloir"
        value: d
      - type: xlrelease.StringVariable
        key: ext_envd
        label: "Premi?re lettre, majsucule, type de couloir."
        value: D
      - type: xlrelease.StringVariable
        key: appName
        label: Application Name
        value: ASS_CRDF_ANSIBLE_INT
      - type: xlrelease.StringVariable
        key: ModuleName
        label: Nom du module
        value: maven
      - type: xlrelease.StringVariable
        key: isRelease
        label: Est ce que l'application est une release ?
        value: "false"
      - type: xlrelease.StringVariable
        key: appVersion
        label: Version de l'application
        value: 1.0.0-SNAPSHOT
      - type: xlrelease.StringVariable
        key: modlib
        label: Modlib
        value: cte
      - type: xlrelease.StringVariable
        key: artifactory_user
        label: Utilisateur Artifactory
        value: e40931
      - type: xlrelease.PasswordStringVariable
        key: artifactory_pwd
        label: Mot de passe Artifactory
      - type: xlrelease.StringVariable
        key: ext_nom_tns
        requiresValue: false
        label: Nom TNS Oracle
      - type: xlrelease.StringVariable
        key: artifact_password
      - type: xlrelease.StringVariable
        key: artifact_user
      - type: xlrelease.StringVariable
        key: artifact_pwd
    allowPasswordsInAllFields: true
    riskProfile: Default risk profile
  - template: Infolivre 3.1
    description: The template for the infolivre offer
    scheduledStartDate: 2023-12-26T09:00:00+01:00
    dueDate: 2023-12-26T10:00:00+01:00
    phases:
      - phase: ppd
        tasks:
          - name: Variables settings
            type: xlrelease.SequentialGroup
            tasks:
              - name: Environment variables
                type: xlrelease.ScriptTask
                script: |-
                  #from com.xebialabs.xlrelease.api.v1
                  #import ReleaseApi
                  
                  # get phase name / environment
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  releaseVariables['ext_env'] = phase_name
                  
                  # Attribute phase name to env variable
                  if str(phase_name) == "dev" or str(phase_name) == 'int':
                      releaseVariables['env'] = "HORSPROD"
                  if str(phase_name) == "rec" or str(phase_name) == 'qualif':
                      releaseVariables['env'] = "ISOPROD"
                  if str(phase_name) == 'ppd' or str(phase_name) == 'prod':
                      releaseVariables['env'] = "PROD"
                  
                  #Set if the version is release from url input
                  if "SNAPSHOT" in '${ext_binary_url}':
                      releaseVariables['isRelease'] = "false"
                  else:
                      releaseVariables['isRelease'] = "true"
                  
                  # abort if snapshot in production environment
                  
                  #if (releaseVariables['env'] == "PROD" and releaseVariables['isRelease'] == "false"):
                  #   #comment = "Attention: You are deploying a SNAPSHOT in a PRODUCTION environment, Aborting phase..."
                  #   #task.getRelease().addComment(comment)
                  
                  #  # abort phase
                  #   current_phase = phaseApi.getPhase(phase.id)
                  #   releaseAp.abortCurrentPhase(current_phase, "Attention: You are deploying a SNAPSHOT in a PRODUCTION environment, Aborting phase..."
                  
                  
                  #set ap_code
                  #releaseVariables['ap_code'] = "AP" + releaseVariables['codeAP']######
              - name: Input credentials
                type: xlrelease.UserInputTask
                description: Please enter the required information below.
                variables:
                  - artifact_user
                  - artifact_passwd
              - name: Charge credentials in Ansible
                type: webhook.JsonWebhook
                URL: https://ansible-devops.group.echonet/api/v2/credentials/9289/
                method: PUT
                body: |-
                  {
                      "name": "cr-carat-infolivre-AP23882",
                      "description": "credentials for cr-carat-infolivre-AP23882",
                      "organization": 151,
                      "credential_type": 24,
                      "inputs": {
                          "artifact_user": "${artifact_user}",
                          "artifact_password": "${artifact_passwd}"
                            }
                      }
                username: "${artifact_user}"
                variableMapping:
                  pythonScript.password: "${artifact_passwd}"
          - name: Run Infolivre deployment
            type: ansibletower.launchAndWait
            ansibletower: devopstc-ansibleAutomation-PROD
            job_template_id: j-AP23882-rat00_carat_deply_infolivre_v31-PPD
            extra_vars:
              ext_projectid: "${projectID}"
              ext_serveurs: servers_socle
              replace_and_delete: "${replace_and_delete}"
              env: "${env}"
              ext_binary_url: "${ext_binary_url}"
              ext_ModuleName: maven
              ap_code: "${ap_code}"
              code5car: "${code5car}"
              rollback: "${rollback}"
              ext_chainNum: "${chainNum}"
              trigram: "${trigram}"
              ext_env: "${ext_env}"
              apCode: "${codeAP}"
              ext_nom_tns: '""'
              appName: "${appName}"
              ext_appVersion: NONE
              ext_isRelease: "${isRelease}"
              hosts: "${hosts}"
              artifactPath: com/bnp/core/daas/
          - name: Rollback
            type: xlrelease.SequentialGroup
            tasks:
              - name: Do you want to rollback?
                type: xlrelease.UserInputTask
                description: Please enter the required information below.
                variables:
                  - rollback
              - name: Rollback
                type: ansibletower.launchAndWait
                ansibletower: devopstc-ansibleAutomation-PROD
                job_template_id: j-AP23882-rat00_carat_rollback_infolivre_v31-PPD
                extra_vars:
                  ext_projectid: "${projectID}"
                  ext_serveurs: servers_socle
                  replace_and_delete: "${replace_and_delete}"
                  env: "${env}"
                  ext_binary_url: "${ext_binary_url}"
                  ext_ModuleName: maven
                  ap_code: "${ap_code}"
                  code5car: "${code5car}"
                  rollback: "${rollback}"
                  ext_chainNum: "${chainNum}"
                  trigram: "${trigram}"
                  ext_env: "${ext_env}"
                  ext_isRelease: ""
                  apCode: "${codeAP}"
                  ext_nom_tns: '""'
                  appName: "${appName}"
                  ext_appVersion: NONE
                  hosts: "${hosts}"
                  artifactPath: com/bnp/core/daas/
                precondition: "releaseVariables['rollback'] == True"
          - name: Clear credentials from Ansible
            type: webhook.JsonWebhook
            URL: https://ansible-devops.group.echonet/api/v2/credentials/8570/
            method: PUT
            body: |-
              {
                  "name": "cr-carat-infolivre-AP23882",
                  "description": "credentials for cr-carat-infolivre-AP23882",
                  "organization": 151,
                  "credential_type": 24,
                  "inputs": {
                      "artifact_user": "${artifact_user}",
                      "artifact_password": "${artifact_passwd}"
                        }
                  }
            username: "${artifact_user}"
            variableMapping:
              pythonScript.password: "${artifact_passwd}"
        color: "#3d6c9e"
    variables:
      - type: xlrelease.StringVariable
        key: codeAP
        showOnReleaseStart: false
        label: AP Code of the application
        description: set once
        value: "23882"
      - type: xlrelease.StringVariable
        key: projectID
        requiresValue: false
        showOnReleaseStart: false
        label: Project ID of the devops space
        description: set once
        value: "1212"
      - type: xlrelease.StringVariable
        key: trigram
        showOnReleaseStart: false
        label: Trigram of the application
        description: set once
        value: rat
      - type: xlrelease.StringVariable
        key: code5car
        showOnReleaseStart: false
        label: Pentagram of the application
        description: set once
        value: rat00
      - type: xlrelease.StringVariable
        key: env
        showOnReleaseStart: false
        label: Ansible Environment
        description: set dynamically
      - type: xlrelease.StringVariable
        key: ext_env
        showOnReleaseStart: false
        label: Environment
        description: set dynamically
      - type: xlrelease.StringVariable
        key: ext_binary_url
        label: Zip Url in Artifactory
      - type: xlrelease.StringVariable
        key: chainNum
        label: Lane number
        description: Number of targeted lane
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "01"
            - "02"
            - "03"
            - "04"
            - "05"
            - "06"
            - "07"
            - "08"
            - "09"
      - type: xlrelease.StringVariable
        key: isRelease
        showOnReleaseStart: false
        label: Is the version you are deploying a Release?
        description: set dynamically
      - type: xlrelease.StringVariable
        key: appName
        showOnReleaseStart: false
        label: Application name
        value: carat_DIFFUSION_DEPLOY
      - type: xlrelease.StringVariable
        key: ap_code
        showOnReleaseStart: false
        label: Application code
        value: "23882"
      - type: xlrelease.StringVariable
        key: artifact_user
        showOnReleaseStart: false
        label: Artifactory user
      - type: xlrelease.PasswordStringVariable
        key: artifact_passwd
        showOnReleaseStart: false
        label: Artifactory password
      - type: xlrelease.BooleanVariable
        key: rollback
        showOnReleaseStart: false
        label: Check if you want to perform a rollback
        description: Variable to execute rollback
      - type: xlrelease.BooleanVariable
        key: replace_and_delete
        label: Do you want to perform a full delivery (replace and delete)
        description: Check this parameter if you want to make a full delivery
      - type: xlrelease.StringVariable
        key: appVersion
        label: Application Version
        description: Application Version
      - type: xlrelease.StringVariable
        key: target_server_name
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: target_server_url
        showOnReleaseStart: false
      - type: xlrelease.ListStringVariable
        key: hosts
    allowPasswordsInAllFields: true
    scriptUsername: runasuser
    variableMapping:
      scriptUserPassword: "${global.RunAsUserPassword}"
    riskProfile: Default risk profile
  - template: Infolivre 3.2
    description: The template for the infolivre offer
    scheduledStartDate: 2023-12-26T09:00:00+01:00
    dueDate: 2023-12-26T10:00:00+01:00
    phases:
      - phase: dev
        tasks:
          - name: Variables settings
            type: xlrelease.SequentialGroup
            tasks:
              - name: Choose lane
                type: xlrelease.UserInputTask
                description: "Choose on which lane you want to deploy:"
                variables:
                  - chainNum
              - name: Environment variables
                type: xlrelease.ScriptTask
                script: |-
                  #from com.xebialabs.xlrelease.api.v1
                  #import ReleaseApi
                  
                  # get phase name / environment
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  releaseVariables['ext_env'] = phase_name
                  
                  ##set ap_code
                  releaseVariables['ap_code'] = "AP" + releaseVariables['codeAP']
                  
                  # Attribute phase name to env variable
                  if str(phase_name) == "dev" or str(phase_name) == 'int':
                      releaseVariables['env'] = "HORSPROD"
                  if str(phase_name) == "rec" or str(phase_name) == 'qualif':
                      releaseVariables['env'] = "ISOPROD"
                  if str(phase_name) == 'ppd' or str(phase_name) == 'prod':
                      releaseVariables['env'] = "PROD"
                  
                  #Attribute hosts according to environment
                  if str(phase_name) == "dev":
                    releaseVariables['hosts'] = releaseVariables['hosts_dev']
                  if str(phase_name) == "rec":
                    releaseVariables['hosts'] = releaseVariables['hosts_rec']
                  if str(phase_name) == "int":
                    releaseVariables['hosts'] = releaseVariables['hosts_int']
                  if str(phase_name) == "ppd":
                    releaseVariables['hosts'] = releaseVariables['hosts_ppd']
                  if str(phase_name) == "prd":
                    releaseVariables['hosts'] = releaseVariables['hosts_prd']
                  
                  
                  #Set if the version is release from url input
                  if "SNAPSHOT" in '${binary_url}':
                      releaseVariables['isRelease'] = "false"
                  else:
                      releaseVariables['isRelease'] = "true"
                  
                  # abort if snapshot in production environment
                  
                  #if (releaseVariables['env'] == "PROD" and releaseVariables['isRelease'] == "false"):
                  #   #comment = "Attention: You are deploying a SNAPSHOT in a PRODUCTION environment, Aborting phase..."
                  #   #task.getRelease().addComment(comment)
                  
                  #  # abort phase
                  #   current_phase = phaseApi.getPhase(phase.id)
                  #   releaseAp.abortCurrentPhase(current_phase, "Attention: You are deploying a SNAPSHOT in a PRODUCTION environment, Aborting phase..."
                  
                  ####Set envc /envd variables
                  #envc = phase_name[0].lower()
                  #releaseVariables['ext_envc'] = envc
                  #
                  #envd = phase_name[0].capitalize()
                  #releaseVariables['ext_envd'] = envd
                  #
                  ######>>>>>>
          - name: Deploy Infolivre
            type: ansibletower.launchAndWait
            ansibletower: devopstc-ansibleAutomation-HORSPROD
            job_template_id: j-AP06578-infolivre-HORSPROD
            extra_vars:
              isRelease: "${isRelease}"
              replace_and_delete: "${replace_and_delete}"
              appVersion: "${appVersion}"
              env: "${env}"
              etl: "${etl}"
              ap_code: "${ap_code}"
              projectID: "${projectID}"
              code5car: "${code5car}"
              rollback: "${rollback}"
              binary_url: "${binary_url}"
              ext_appRep: "${ext_appRep}"
              trigram: "${trigram}"
              ext_env: "${ext_env}"
              apCode: "${codeAP}"
              ext_nom_tns: '""'
              appName: "${appName}"
              chainNum: "${chainNum}"
              hosts: "${hosts}"
            credentials:
              - "${cred_artifact}"
          - name: Rollback
            type: xlrelease.SequentialGroup
            tasks:
              - name: Do you want to rollback?
                type: xlrelease.UserInputTask
                description: Please enter the required information below.
                variables:
                  - rollback
              - name: Rollback
                type: ansibletower.launchAndWait
                ansibletower: devopstc-ansibleAutomation-HORSPROD
                job_template_id: j-AP06578-infolivre-rollback-HORSPROD
                extra_vars:
                  isRelease: "${isRelease}"
                  replace_and_delete: "${replace_and_delete}"
                  appVersion: "${appVersion}"
                  env: "${env}"
                  etl: "${etl}"
                  ap_code: "${ap_code}"
                  projectID: "${projectID}"
                  code5car: "${code5car}"
                  rollback: "${rollback}"
                  binary_url: "${binary_url}"
                  ext_appRep: "${ext_appRep}"
                  trigram: "${trigram}"
                  ext_env: "${ext_env}"
                  apCode: "${codeAP}"
                  ext_nom_tns: '""'
                  appName: "${appName}"
                  chainNum: "${chainNum}"
                  hosts: "${hosts}"
                credentials:
                  - "${cred_artifact}"
                precondition: "releaseVariables['rollback'] == True"
        color: "#3d6c9e"
    variables:
      - type: xlrelease.StringVariable
        key: codeAP
        showOnReleaseStart: false
        label: AP Code of the application
        description: set once
        value: "06758"
      - type: xlrelease.StringVariable
        key: projectID
        showOnReleaseStart: false
        label: Project ID of the devops space
        description: set once
        value: "1362"
      - type: xlrelease.StringVariable
        key: trigram
        showOnReleaseStart: false
        label: Trigram of the application
        description: set once
        value: das
      - type: xlrelease.StringVariable
        key: code5car
        showOnReleaseStart: false
        label: Pentagram of the application
        description: set once
        value: das01
      - type: xlrelease.StringVariable
        key: appName
        showOnReleaseStart: false
        label: Application name
        value: DAAS_INFOLIVRE
      - type: xlrelease.StringVariable
        key: cred_artifact
        showOnReleaseStart: false
        label: Credential used to execute the ansible playbook
        value: "7194"
      - type: xlrelease.StringVariable
        key: env
        showOnReleaseStart: false
        label: Ansible Environment
        description: set dynamically
      - type: xlrelease.StringVariable
        key: ext_env
        showOnReleaseStart: false
        label: Environment
        description: set dynamically
      - type: xlrelease.StringVariable
        key: binary_url
        label: Zip Url in Artifactory
      - type: xlrelease.StringVariable
        key: chainNum
        showOnReleaseStart: false
        label: Lane number
        description: Number of targeted lane
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "01"
            - "02"
            - "03"
            - "04"
            - "05"
            - "06"
            - "07"
            - "08"
            - "09"
      - type: xlrelease.StringVariable
        key: isRelease
        showOnReleaseStart: false
        label: Is the version you are deploying a Release?
        description: set dynamically
      - type: xlrelease.BooleanVariable
        key: rollback
        showOnReleaseStart: false
        label: Check if you want to perform a rollback
        description: Variable to execute rollback
      - type: xlrelease.BooleanVariable
        key: replace_and_delete
        label: Do you want to perform a full delivery (replace and delete)
        description: Check this parameter if you want to make a full delivery
      - type: xlrelease.StringVariable
        key: appVersion
        label: Application Version
        description: Application Version
      - type: xlrelease.ListStringVariable
        key: hosts
        showOnReleaseStart: false
        label: List of hosts
        description: Add target host
      - type: xlrelease.ListStringVariable
        key: hosts_dev
        showOnReleaseStart: false
        label: Lists of hosts for dev environment
      - type: xlrelease.ListStringVariable
        key: hosts_int
        showOnReleaseStart: false
        label: List of hosts for int environment
      - type: xlrelease.ListStringVariable
        key: hosts_rec
        showOnReleaseStart: false
        label: Lists of hosts for rec environnement
      - type: xlrelease.ListStringVariable
        key: hosts_ppd
        requiresValue: false
        showOnReleaseStart: false
        label: List of hosts for ppd environment
      - type: xlrelease.ListStringVariable
        key: hosts_prd
        requiresValue: false
        showOnReleaseStart: false
        label: List of hosts for prd environment
      - type: xlrelease.BooleanVariable
        key: etl
        label: Check if ETL
        description: Check if the application is part of ETL
      - type: xlrelease.StringVariable
        key: ext_appRep
        requiresValue: false
        showOnReleaseStart: false
        label: application folder (only if etl)
      - type: xlrelease.StringVariable
        key: ap_code
        label: Extra vars
        description: "A map that represents a JSON or YAML formatted dictionary (with\
      \ escaped parentheses) which includes variables given by the user, including\
      \ answers to survey questions"
    allowPasswordsInAllFields: true
    scriptUsername: runasuser
    variableMapping:
      scriptUserPassword: "${global.RunAsUserPassword}"
    riskProfile: Default risk profile
  - template: Infolivre 3.3
    description: Template for latest 3.3 version of infolivre
    scheduledStartDate: 2023-12-26T09:00:00+01:00
    dueDate: 2023-12-26T10:00:00+01:00
    phases:
      - phase: dev
        tasks:
          - name: Variables settings
            type: xlrelease.SequentialGroup
            tasks:
              - name: Choose lane
                type: xlrelease.UserInputTask
                description: "Choose on which lane you want to deploy:"
                variables:
                  - chainNum
              - name: Environment variables
                type: xlrelease.ScriptTask
                script: |-
                  #from com.xebialabs.xlrelease.api.v1
                  #import ReleaseApi
                  
                  # get phase name / environment
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  releaseVariables['ext_env'] = phase_name
                  
                  ##set ap_code
                  releaseVariables['ap_code'] = releaseVariables['codeAP']
                  
                  # Attribute phase name to env variable
                  if str(phase_name) == "dev" or str(phase_name) == 'int':
                      releaseVariables['env'] = "HORSPROD"
                  if str(phase_name) == "rec" or str(phase_name) == 'qualif':
                      releaseVariables['env'] = "ISOPROD"
                  if str(phase_name) == 'ppd' or str(phase_name) == 'prod':
                      releaseVariables['env'] = "PROD"
                  
                  #Attribute hosts according to environment
                  if str(phase_name) == "dev":
                    releaseVariables['hosts'] = releaseVariables['hosts_dev']
                  if str(phase_name) == "rec":
                    releaseVariables['hosts'] = releaseVariables['hosts_rec']
                  if str(phase_name) == "int":
                    releaseVariables['hosts'] = releaseVariables['hosts_int']
                  if str(phase_name) == "ppd":
                    releaseVariables['hosts'] = releaseVariables['hosts_ppd']
                  if str(phase_name) == "prd":
                    releaseVariables['hosts'] = releaseVariables['hosts_prd']
                  
                  
                  #Set if the version is release from url input
                  if "SNAPSHOT" in '${binary_url}':
                      releaseVariables['isRelease'] = "false"
                  else:
                      releaseVariables['isRelease'] = "true"
                  
                  # abort if snapshot in production environment
                  
                  #if (releaseVariables['env'] == "PROD" and releaseVariables['isRelease'] == "false"):
                  #   #comment = "Attention: You are deploying a SNAPSHOT in a PRODUCTION environment, Aborting phase..."
                  #   #task.getRelease().addComment(comment)
                  
                  #  # abort phase
                  #   current_phase = phaseApi.getPhase(phase.id)
                  #   releaseAp.abortCurrentPhase(current_phase, "Attention: You are deploying a SNAPSHOT in a PRODUCTION environment, Aborting phase..."
                  
                  ####Set envc /envd variables
                  #envc = phase_name[0].lower()
                  #releaseVariables['ext_envc'] = envc
                  #
                  #envd = phase_name[0].capitalize()
                  #releaseVariables['ext_envd'] = envd
                  #
                  ##set ap_code
                  #releaseVariables['ap_code'] = "AP" + releaseVariables['codeAP']######>>>>>>
          - name: Deploy Infolivre
            type: ansibletower.launchAndWait
            ansibletower: devopstc-ansibleAutomation-HORSPROD
            job_template_id: j-AP06578-infolivre-HORSPROD
            extra_vars:
              isRelease: "${isRelease}"
              replace_and_delete: "${replace_and_delete}"
              appVersion: "${appVersion}"
              env: "${env}"
              etl: "${etl}"
              ap_code: "${ap_code}"
              projectID: "${projectID}"
              code5car: "${code5car}"
              rollback: "${rollback}"
              binary_url: "${binary_url}"
              ext_appRep: "${ext_appRep}"
              trigram: "${trigram}"
              ext_env: "${ext_env}"
              apCode: "${codeAP}"
              ext_nom_tns: '""'
              appName: "${appName}"
              chainNum: "${chainNum}"
              hosts: "${hosts}"
          - name: Rollback
            type: xlrelease.SequentialGroup
            tasks:
              - name: Do you want to rollback?
                type: xlrelease.UserInputTask
                description: Please enter the required information below.
                variables:
                  - rollback
              - name: Rollback
                type: ansibletower.launchAndWait
                ansibletower: devopstc-ansibleAutomation-HORSPROD
                job_template_id: j-AP06578-infolivre-rollback-HORSPROD
                extra_vars:
                  isRelease: "${isRelease}"
                  replace_and_delete: "${replace_and_delete}"
                  appVersion: "${appVersion}"
                  env: "${env}"
                  etl: "${etl}"
                  projectID: "${projectID}"
                  code5car: "${code5car}"
                  rollback: "${rollback}"
                  binary_url: "${binary_url}"
                  ext_appRep: "${ext_appRep}"
                  trigram: "${trigram}"
                  ext_env: "${ext_env}"
                  ext_nom_tns: '""'
                  appName: "${appName}"
                  chainNum: "${chainNum}"
                  hosts: "${hosts}"
                  apCode: "${ap_code}"
                credentials:
                  - "${cred_artifact}"
                precondition: "releaseVariables['rollback'] == True"
        color: "#3d6c9e"
    variables:
      - type: xlrelease.StringVariable
        key: codeAP
        showOnReleaseStart: false
        label: AP Code of the application
        description: set once
        value: "06758"
      - type: xlrelease.StringVariable
        key: projectID
        showOnReleaseStart: false
        label: Project ID of the devops space
        description: set once
        value: "1362"
      - type: xlrelease.StringVariable
        key: trigram
        showOnReleaseStart: false
        label: Trigram of the application
        description: set once
        value: das
      - type: xlrelease.StringVariable
        key: code5car
        showOnReleaseStart: false
        label: Pentagram of the application
        description: set once
        value: das01
      - type: xlrelease.StringVariable
        key: appName
        showOnReleaseStart: false
        label: Application name
        value: DAAS_INFOLIVRE
      - type: xlrelease.StringVariable
        key: cred_artifact
        showOnReleaseStart: false
        label: Credential used to execute the ansible playbook
        value: "7194"
      - type: xlrelease.StringVariable
        key: env
        showOnReleaseStart: false
        label: Ansible Environment
        description: set dynamically
      - type: xlrelease.StringVariable
        key: ext_env
        showOnReleaseStart: false
        label: Environment
        description: set dynamically
      - type: xlrelease.StringVariable
        key: binary_url
        label: Zip Url in Artifactory
      - type: xlrelease.StringVariable
        key: chainNum
        showOnReleaseStart: false
        label: Lane number
        description: Number of targeted lane
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "01"
            - "02"
            - "03"
            - "04"
            - "05"
            - "06"
            - "07"
            - "08"
            - "09"
      - type: xlrelease.StringVariable
        key: isRelease
        showOnReleaseStart: false
        label: Is the version you are deploying a Release?
        description: set dynamically
      - type: xlrelease.BooleanVariable
        key: rollback
        showOnReleaseStart: false
        label: Check if you want to perform a rollback
        description: Variable to execute rollback
      - type: xlrelease.BooleanVariable
        key: replace_and_delete
        label: Do you want to perform a full delivery (replace and delete)
        description: Check this parameter if you want to make a full delivery
      - type: xlrelease.StringVariable
        key: appVersion
        label: Application Version
        description: Application Version
      - type: xlrelease.ListStringVariable
        key: hosts
        showOnReleaseStart: false
        label: List of hosts
        description: Add target host
      - type: xlrelease.ListStringVariable
        key: hosts_dev
        showOnReleaseStart: false
        label: Lists of hosts for dev environment
      - type: xlrelease.ListStringVariable
        key: hosts_int
        showOnReleaseStart: false
        label: List of hosts for int environment
      - type: xlrelease.ListStringVariable
        key: hosts_rec
        showOnReleaseStart: false
        label: Lists of hosts for rec environnement
      - type: xlrelease.ListStringVariable
        key: hosts_ppd
        requiresValue: false
        showOnReleaseStart: false
        label: List of hosts for ppd environment
      - type: xlrelease.ListStringVariable
        key: hosts_prd
        requiresValue: false
        showOnReleaseStart: false
        label: List of hosts for prd environment
      - type: xlrelease.BooleanVariable
        key: etl
        label: Check if ETL
        description: Check if the application is part of ETL
      - type: xlrelease.StringVariable
        key: ext_appRep
        requiresValue: false
        showOnReleaseStart: false
        label: application folder (only if etl)
      - type: xlrelease.StringVariable
        key: ap_code
        requiresValue: false
        showOnReleaseStart: false
        label: Extra vars
        description: "A map that represents a JSON or YAML formatted dictionary (with\
      \ escaped parentheses) which includes variables given by the user, including\
      \ answers to survey questions"
    allowPasswordsInAllFields: true
    scriptUsername: runasuser
    variableMapping:
      scriptUserPassword: "${global.RunAsUserPassword}"
    riskProfile: Default risk profile
  - template: LibertyCore-AP23882-CARAT-DEPLOY EBX V6 multi env - Brouillon
    scheduledStartDate: 2023-07-26T09:00:00+02:00
    dueDate: 2023-07-26T10:00:00+02:00
    phases:
      - phase: rec1
        tasks:
          - name: üè≠ Set variables
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              ####get the environement variable : int / rec / pprod/ prod ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title[0:3]
              
              env = '${ext_env}'
              myenv = str(env)[0:3]
              if myenv == "ppd":
                  envc = "x"
              else:
              
              ##set envc variable from envir
                  envc = myenv[0]
              releaseVariables['ext_envc'] = envc
              envd = envc.upper()
              releaseVariables['ext_envd'] = envd
              
              ##set env variable from phase_name
              if str(myenv) == "int":
                  releaseVariables['ext_environnement'] = "Integration"
                  releaseVariables['env'] = "HORSPROD"
              if str(myenv) == "rec":
                  releaseVariables['ext_environnement'] = "Recette"
                  releaseVariables['env'] = "ISOPROD"
              if str(myenv) == "ppd":
                  releaseVariables['ext_environnement'] = "PreProduction"
                  releaseVariables['env'] = "PROD"
              if str(myenv) == "prd":
                  releaseVariables['ext_environnement'] = "Production"
                  releaseVariables['env'] = "PROD"
              
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              
              ## Set AAP Inventories
              environment=""
              
              inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(env).upper()
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = '${ext_env}' + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: üîé Get AAP Resources Ids task generator
            type: xlrelease.ScriptTask
            script: |-
              from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
              
              
              ## get id of sequential group to insert tasks into
              sequentialGroupId = None
              parenttask = getCurrentTask().container
              sequentialGroupId_list = []
              for child in parenttask.getChildren():
                  if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                      sequentialGroupId_list.append( child.id)
              sequentialGroupId = sequentialGroupId_list[0]
              
              ## get all release variables into list
              varList = releaseApi.getVariables(release.id)
              
              ##get variabble couloir to insert into user input task
              for obj in varList:
                  if "AAP-name" in obj.key:
                     resource = obj.value
                     var_name = obj.key
                     type = var_name.split('-')[-1]
                     var_resourceId = var_name.replace("name", "id")
                     api_check = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                     taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                     taskCheckResource.pythonScript.setProperty("URL", api_check)
                     taskCheckResource.pythonScript.setProperty("method", 'GET')
                     taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                     taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                     taskCheckResource.pythonScript.setProperty("username", '${artifact_user}')
                     taskCheckResource.pythonScript.setProperty("password", '${artifact_passwd}')
                     taskCheckResource.setTaskFailureHandlerEnabled(True)
                     taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                     taskCheckResource.title = "Check " + str(type) + " " + str(resource)
                     taskApi.addTask(sequentialGroupId, taskCheckResource)
          - name: üöÄ GET AAP RESOURCES
            type: xlrelease.SequentialGroup
          - name: üöß Deploy task generator
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              releaseId = getCurrentRelease().id
              
              listFolder = releaseId.split('/')
              FolderId = listFolder[1]
              ServerName = "devopstc-ansibleAutomation-" + '${env}'
              #JobId= 7
              aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
              
              ##get modules to deploy
              sas_list=releaseVariables['modules_todeploy']
              
              
              ####get the environement variable : int / rec / pprod/ prod ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              
              myenv = '${ext_env}'
              my_env = myenv[0:3]
              if str(my_env) == "int" or str(my_env) == "rec":
                  releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper() + "-" + releaseVariables['ext_chainNum']
              if str(my_env) == "ppd" or str(my_env) == "prod" :
                  releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper()
              
              
              
               ## set isRelease variable dynamically
              if "SNAPSHOT" in '${release_version}':
                  releaseVariables['ext_isRelease'] = "false"
                  releaseVariables['version'] = "SNAPSHOT"
              else:
                  releaseVariables['ext_isRelease'] = "true"
                  releaseVariables['version'] = "RELEASE"
              
              ## get id of sequential group to insert tasks into
              sequentialGroupId = None
              parenttask = getCurrentTask().container
              sequentialGroupId_list = []
              for child in parenttask.getChildren():
                  if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                      sequentialGroupId_list.append( child.id)
              sequentialGroupId = sequentialGroupId_list[1]
              
              #Set AAP resources Ids
              varList = releaseApi.getVariables(release.id)
              
              for obj in varList:
                  if "AAP-id" in obj.key and "credentials" in obj.key:
                      credential_id = obj.value
                  if "AAP-id" in obj.key and "job_templates" in obj.key:
                      job_template_id = obj.value
                  if "AAP-id" in obj.key and "inventories" in obj.key:
                      inventory_id = obj.value
              
              for component in sas_list:
              
                  ##creation de t?che ansible
                    taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                    taskUpdateReleaseIds.title = 'deploy ' + str(component) + " " + '${release_version}'
                    extravarsName = str(component) + "_extra_vars"
                    taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                    taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                    taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                    taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables[extravarsName])
                    taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
              
              
                  ##ajout de la task ansible sur le group sequential
                    taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
          - name: üõÉValidation
            type: xlrelease.GateTask
            failureHandler: |-
              releaseId = getCurrentRelease().id
              phase = getCurrentPhase()
              phase_name = phase.title
              
              ##Create rollback phase
              newphase = phaseApi.copyPhase(phase.id,releaseVariables['index'] )
              
              
              ##update next phase title
              newphase.title = 'Rollback ' + phase.title
              phaseApi.updatePhase(newphase)
              
              
              ## get all release variables into list
              varList = releaseApi.getVariables(release.id)
              
              ##rollback version
              releaseVariables['release_version'] = ""
              
              for obj in varList:
                  if obj.key == 'release_version':
                      varForUserInputTask = obj
              
              ##New user input task
              RollbackUserInputTask = taskApi.newTask("xlrelease.UserInputTask")
              RollbackUserInputTask.title = "Rollback Version"
              RollbackUserInputTask.setVariables([varForUserInputTask])
              
              taskApi.addTask(newphase.id, 0)
            taskFailureHandlerEnabled: true
            taskRecoverOp: RUN_SCRIPT
        color: "#3d6c9e"
      - phase: rec1
        tasks:
          - name: üè≠ Set variables
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              ####get the environement variable : int / rec / pprod/ prod ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title[0:3]
              
              env = '${ext_env}'
              myenv = str(env)[0:3]
              if myenv == "ppd":
                  envc = "x"
              else:
              
              ##set envc variable from envir
                  envc = myenv[0]
              releaseVariables['ext_envc'] = envc
              envd = envc.upper()
              releaseVariables['ext_envd'] = envd
              
              ##set env variable from phase_name
              if str(myenv) == "int":
                  releaseVariables['ext_environnement'] = "Integration"
                  releaseVariables['env'] = "HORSPROD"
              if str(myenv) == "rec":
                  releaseVariables['ext_environnement'] = "Recette"
                  releaseVariables['env'] = "ISOPROD"
              if str(myenv) == "ppd":
                  releaseVariables['ext_environnement'] = "PreProduction"
                  releaseVariables['env'] = "PROD"
              if str(myenv) == "prd":
                  releaseVariables['ext_environnement'] = "Production"
                  releaseVariables['env'] = "PROD"
              
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              
              ## Set AAP Inventories
              environment=""
              
              inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(env).upper()
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = '${ext_env}' + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: üîé Get AAP Resources Ids task generator
            type: xlrelease.ScriptTask
            script: |-
              from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
              
              
              ## get id of sequential group to insert tasks into
              sequentialGroupId = None
              parenttask = getCurrentTask().container
              sequentialGroupId_list = []
              for child in parenttask.getChildren():
                  if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                      sequentialGroupId_list.append( child.id)
              sequentialGroupId = sequentialGroupId_list[0]
              
              ## get all release variables into list
              varList = releaseApi.getVariables(release.id)
              
              ##get variabble couloir to insert into user input task
              for obj in varList:
                  if "AAP-name" in obj.key:
                     resource = obj.value
                     var_name = obj.key
                     type = var_name.split('-')[-1]
                     var_resourceId = var_name.replace("name", "id")
                     api_check = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                     taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                     taskCheckResource.pythonScript.setProperty("URL", api_check)
                     taskCheckResource.pythonScript.setProperty("method", 'GET')
                     taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                     taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                     taskCheckResource.pythonScript.setProperty("username", '${artifact_user}')
                     taskCheckResource.pythonScript.setProperty("password", '${artifact_passwd}')
                     taskCheckResource.setTaskFailureHandlerEnabled(True)
                     taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                     taskCheckResource.title = "Check " + str(type) + " " + str(resource)
                     taskApi.addTask(sequentialGroupId, taskCheckResource)
          - name: üöÄ GET AAP RESOURCES
            type: xlrelease.SequentialGroup
          - name: üöß Deploy task generator
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              releaseId = getCurrentRelease().id
              
              listFolder = releaseId.split('/')
              FolderId = listFolder[1]
              ServerName = "devopstc-ansibleAutomation-" + '${env}'
              #JobId= 7
              aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
              
              ##get modules to deploy
              sas_list=releaseVariables['modules_todeploy']
              
              
              ####get the environement variable : int / rec / pprod/ prod ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              
              myenv = '${ext_env}'
              my_env = myenv[0:3]
              if str(my_env) == "int" or str(my_env) == "rec":
                  releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper() + "-" + releaseVariables['ext_chainNum']
              if str(my_env) == "ppd" or str(my_env) == "prod" :
                  releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper()
              
              
              
               ## set isRelease variable dynamically
              if "SNAPSHOT" in '${release_version}':
                  releaseVariables['ext_isRelease'] = "false"
                  releaseVariables['version'] = "SNAPSHOT"
              else:
                  releaseVariables['ext_isRelease'] = "true"
                  releaseVariables['version'] = "RELEASE"
              
              ## get id of sequential group to insert tasks into
              sequentialGroupId = None
              parenttask = getCurrentTask().container
              sequentialGroupId_list = []
              for child in parenttask.getChildren():
                  if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                      sequentialGroupId_list.append( child.id)
              sequentialGroupId = sequentialGroupId_list[1]
              
              #Set AAP resources Ids
              varList = releaseApi.getVariables(release.id)
              
              for obj in varList:
                  if "AAP-id" in obj.key and "credentials" in obj.key:
                      credential_id = obj.value
                  if "AAP-id" in obj.key and "job_templates" in obj.key:
                      job_template_id = obj.value
                  if "AAP-id" in obj.key and "inventories" in obj.key:
                      inventory_id = obj.value
              
              for component in sas_list:
              
                  ##creation de t?che ansible
                    taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                    taskUpdateReleaseIds.title = 'deploy ' + str(component) + " " + '${release_version}'
                    extravarsName = str(component) + "_extra_vars"
                    taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                    taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                    taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                    taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables[extravarsName])
                    taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
              
              
                  ##ajout de la task ansible sur le group sequential
                    taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
        color: "#ff9e49"
      - phase: rec2
        tasks:
          - name: üè≠ Set variables
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              ####get the environement variable : int / rec / pprod/ prod ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title[0:3]
              
              env = '${ext_env}'
              myenv = str(env)[0:3]
              if myenv == "ppd":
                  envc = "x"
              else:
              
              ##set envc variable from envir
                  envc = myenv[0]
              releaseVariables['ext_envc'] = envc
              envd = envc.upper()
              releaseVariables['ext_envd'] = envd
              
              ##set env variable from phase_name
              if str(myenv) == "int":
                  releaseVariables['ext_environnement'] = "Integration"
                  releaseVariables['env'] = "HORSPROD"
              if str(myenv) == "rec":
                  releaseVariables['ext_environnement'] = "Recette"
                  releaseVariables['env'] = "ISOPROD"
              if str(myenv) == "ppd":
                  releaseVariables['ext_environnement'] = "PreProduction"
                  releaseVariables['env'] = "PROD"
              if str(myenv) == "prd":
                  releaseVariables['ext_environnement'] = "Production"
                  releaseVariables['env'] = "PROD"
              
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              
              ## Set AAP Inventories
              environment=""
              
              inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(env).upper()
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = '${ext_env}' + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: üîé Get AAP Resources Ids task generator
            type: xlrelease.ScriptTask
            script: |-
              from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
              
              
              ## get id of sequential group to insert tasks into
              sequentialGroupId = None
              parenttask = getCurrentTask().container
              sequentialGroupId_list = []
              for child in parenttask.getChildren():
                  if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                      sequentialGroupId_list.append( child.id)
              sequentialGroupId = sequentialGroupId_list[0]
              
              ## get all release variables into list
              varList = releaseApi.getVariables(release.id)
              
              ##get variabble couloir to insert into user input task
              for obj in varList:
                  if "AAP-name" in obj.key:
                     resource = obj.value
                     var_name = obj.key
                     type = var_name.split('-')[-1]
                     var_resourceId = var_name.replace("name", "id")
                     api_check = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                     taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                     taskCheckResource.pythonScript.setProperty("URL", api_check)
                     taskCheckResource.pythonScript.setProperty("method", 'GET')
                     taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                     taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                     taskCheckResource.pythonScript.setProperty("username", '${artifact_user}')
                     taskCheckResource.pythonScript.setProperty("password", '${artifact_passwd}')
                     taskCheckResource.setTaskFailureHandlerEnabled(True)
                     taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                     taskCheckResource.title = "Check " + str(type) + " " + str(resource)
                     taskApi.addTask(sequentialGroupId, taskCheckResource)
          - name: üöÄ GET AAP RESOURCES
            type: xlrelease.SequentialGroup
          - name: üöß Deploy task generator
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              releaseId = getCurrentRelease().id
              
              listFolder = releaseId.split('/')
              FolderId = listFolder[1]
              ServerName = "devopstc-ansibleAutomation-" + '${env}'
              #JobId= 7
              aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
              
              ##get modules to deploy
              sas_list=releaseVariables['modules_todeploy']
              
              
              ####get the environement variable : int / rec / pprod/ prod ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              
              myenv = '${ext_env}'
              my_env = myenv[0:3]
              if str(my_env) == "int" or str(my_env) == "rec":
                  releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper() + "-" + releaseVariables['ext_chainNum']
              if str(my_env) == "ppd" or str(my_env) == "prod" :
                  releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper()
              
              
              
               ## set isRelease variable dynamically
              if "SNAPSHOT" in '${release_version}':
                  releaseVariables['ext_isRelease'] = "false"
                  releaseVariables['version'] = "SNAPSHOT"
              else:
                  releaseVariables['ext_isRelease'] = "true"
                  releaseVariables['version'] = "RELEASE"
              
              ## get id of sequential group to insert tasks into
              sequentialGroupId = None
              parenttask = getCurrentTask().container
              sequentialGroupId_list = []
              for child in parenttask.getChildren():
                  if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                      sequentialGroupId_list.append( child.id)
              sequentialGroupId = sequentialGroupId_list[1]
              
              #Set AAP resources Ids
              varList = releaseApi.getVariables(release.id)
              
              for obj in varList:
                  if "AAP-id" in obj.key and "credentials" in obj.key:
                      credential_id = obj.value
                  if "AAP-id" in obj.key and "job_templates" in obj.key:
                      job_template_id = obj.value
                  if "AAP-id" in obj.key and "inventories" in obj.key:
                      inventory_id = obj.value
              
              for component in sas_list:
              
                  ##creation de t?che ansible
                    taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                    taskUpdateReleaseIds.title = 'deploy ' + str(component) + " " + '${release_version}'
                    extravarsName = str(component) + "_extra_vars"
                    taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                    taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                    taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                    taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables[extravarsName])
                    taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
              
              
                  ##ajout de la task ansible sur le group sequential
                    taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
        color: "#667385"
      - phase: ppd
        tasks:
          - name: üè≠ Set variables
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              ####get the environement variable : int / rec / pprod/ prod ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title[0:3]
              
              env = '${ext_env}'
              myenv = str(env)[0:3]
              if myenv == "ppd":
                  envc = "x"
              else:
              
              ##set envc variable from envir
                  envc = myenv[0]
              releaseVariables['ext_envc'] = envc
              envd = envc.upper()
              releaseVariables['ext_envd'] = envd
              
              ##set env variable from phase_name
              if str(myenv) == "int":
                  releaseVariables['ext_environnement'] = "Integration"
                  releaseVariables['env'] = "HORSPROD"
              if str(myenv) == "rec":
                  releaseVariables['ext_environnement'] = "Recette"
                  releaseVariables['env'] = "ISOPROD"
              if str(myenv) == "ppd":
                  releaseVariables['ext_environnement'] = "PreProduction"
                  releaseVariables['env'] = "PROD"
              if str(myenv) == "prd":
                  releaseVariables['ext_environnement'] = "Production"
                  releaseVariables['env'] = "PROD"
              
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              
              ## Set AAP Inventories
              environment=""
              
              inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(env).upper()
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = '${ext_env}' + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: üîé Get AAP Resources Ids task generator
            type: xlrelease.ScriptTask
            script: |-
              from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
              
              
              ## get id of sequential group to insert tasks into
              sequentialGroupId = None
              parenttask = getCurrentTask().container
              sequentialGroupId_list = []
              for child in parenttask.getChildren():
                  if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                      sequentialGroupId_list.append( child.id)
              sequentialGroupId = sequentialGroupId_list[0]
              
              ## get all release variables into list
              varList = releaseApi.getVariables(release.id)
              
              ##get variabble couloir to insert into user input task
              for obj in varList:
                  if "AAP-name" in obj.key:
                     resource = obj.value
                     var_name = obj.key
                     type = var_name.split('-')[-1]
                     var_resourceId = var_name.replace("name", "id")
                     api_check = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                     taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                     taskCheckResource.pythonScript.setProperty("URL", api_check)
                     taskCheckResource.pythonScript.setProperty("method", 'GET')
                     taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                     taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                     taskCheckResource.pythonScript.setProperty("username", '${artifact_user}')
                     taskCheckResource.pythonScript.setProperty("password", '${artifact_passwd}')
                     taskCheckResource.setTaskFailureHandlerEnabled(True)
                     taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                     taskCheckResource.title = "Check " + str(type) + " " + str(resource)
                     taskApi.addTask(sequentialGroupId, taskCheckResource)
          - name: üöÄ GET AAP RESOURCES
            type: xlrelease.SequentialGroup
          - name: üöß Deploy task generator
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              releaseId = getCurrentRelease().id
              
              listFolder = releaseId.split('/')
              FolderId = listFolder[1]
              ServerName = "devopstc-ansibleAutomation-" + '${env}'
              #JobId= 7
              aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
              
              ##get modules to deploy
              sas_list=releaseVariables['modules_todeploy']
              
              
              ####get the environement variable : int / rec / pprod/ prod ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              
              myenv = '${ext_env}'
              my_env = myenv[0:3]
              if str(my_env) == "int" or str(my_env) == "rec":
                  releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper() + "-" + releaseVariables['ext_chainNum']
              if str(my_env) == "ppd" or str(my_env) == "prod" :
                  releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper()
              
              
              
               ## set isRelease variable dynamically
              if "SNAPSHOT" in '${release_version}':
                  releaseVariables['ext_isRelease'] = "false"
                  releaseVariables['version'] = "SNAPSHOT"
              else:
                  releaseVariables['ext_isRelease'] = "true"
                  releaseVariables['version'] = "RELEASE"
              
              ## get id of sequential group to insert tasks into
              sequentialGroupId = None
              parenttask = getCurrentTask().container
              sequentialGroupId_list = []
              for child in parenttask.getChildren():
                  if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                      sequentialGroupId_list.append( child.id)
              sequentialGroupId = sequentialGroupId_list[1]
              
              #Set AAP resources Ids
              varList = releaseApi.getVariables(release.id)
              
              for obj in varList:
                  if "AAP-id" in obj.key and "credentials" in obj.key:
                      credential_id = obj.value
                  if "AAP-id" in obj.key and "job_templates" in obj.key:
                      job_template_id = obj.value
                  if "AAP-id" in obj.key and "inventories" in obj.key:
                      inventory_id = obj.value
              
              for component in sas_list:
              
                  ##creation de t?che ansible
                    taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                    taskUpdateReleaseIds.title = 'deploy ' + str(component) + " " + '${release_version}'
                    extravarsName = str(component) + "_extra_vars"
                    taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                    taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                    taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                    taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables[extravarsName])
                    taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
              
              
                  ##ajout de la task ansible sur le group sequential
                    taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
        color: "#d61f21"
      - phase: prd
        tasks:
          - name: üè≠ Set variables
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              ####get the environement variable : int / rec / pprod/ prod ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title[0:3]
              
              env = '${ext_env}'
              myenv = str(env)[0:3]
              if myenv == "ppd":
                  envc = "x"
              else:
              
              ##set envc variable from envir
                  envc = myenv[0]
              releaseVariables['ext_envc'] = envc
              envd = envc.upper()
              releaseVariables['ext_envd'] = envd
              
              ##set env variable from phase_name
              if str(myenv) == "int":
                  releaseVariables['ext_environnement'] = "Integration"
                  releaseVariables['env'] = "HORSPROD"
              if str(myenv) == "rec":
                  releaseVariables['ext_environnement'] = "Recette"
                  releaseVariables['env'] = "ISOPROD"
              if str(myenv) == "ppd":
                  releaseVariables['ext_environnement'] = "PreProduction"
                  releaseVariables['env'] = "PROD"
              if str(myenv) == "prd":
                  releaseVariables['ext_environnement'] = "Production"
                  releaseVariables['env'] = "PROD"
              
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              
              ## Set AAP Inventories
              environment=""
              
              inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(env).upper()
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(env) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = '${ext_env}' + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: üîé Get AAP Resources Ids task generator
            type: xlrelease.ScriptTask
            script: |-
              from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
              
              
              ## get id of sequential group to insert tasks into
              sequentialGroupId = None
              parenttask = getCurrentTask().container
              sequentialGroupId_list = []
              for child in parenttask.getChildren():
                  if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                      sequentialGroupId_list.append( child.id)
              sequentialGroupId = sequentialGroupId_list[0]
              
              ## get all release variables into list
              varList = releaseApi.getVariables(release.id)
              
              ##get variabble couloir to insert into user input task
              for obj in varList:
                  if "AAP-name" in obj.key:
                     resource = obj.value
                     var_name = obj.key
                     type = var_name.split('-')[-1]
                     var_resourceId = var_name.replace("name", "id")
                     api_check = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                     taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                     taskCheckResource.pythonScript.setProperty("URL", api_check)
                     taskCheckResource.pythonScript.setProperty("method", 'GET')
                     taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                     taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                     taskCheckResource.pythonScript.setProperty("username", '${artifact_user}')
                     taskCheckResource.pythonScript.setProperty("password", '${artifact_passwd}')
                     taskCheckResource.setTaskFailureHandlerEnabled(True)
                     taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                     taskCheckResource.title = "Check " + str(type) + " " + str(resource)
                     taskApi.addTask(sequentialGroupId, taskCheckResource)
          - name: üöÄ GET AAP RESOURCES
            type: xlrelease.SequentialGroup
          - name: üöß Deploy task generator
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              releaseId = getCurrentRelease().id
              
              listFolder = releaseId.split('/')
              FolderId = listFolder[1]
              ServerName = "devopstc-ansibleAutomation-" + '${env}'
              #JobId= 7
              aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
              
              ##get modules to deploy
              sas_list=releaseVariables['modules_todeploy']
              
              
              ####get the environement variable : int / rec / pprod/ prod ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              
              myenv = '${ext_env}'
              my_env = myenv[0:3]
              if str(my_env) == "int" or str(my_env) == "rec":
                  releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper() + "-" + releaseVariables['ext_chainNum']
              if str(my_env) == "ppd" or str(my_env) == "prod" :
                  releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper()
              
              
              
               ## set isRelease variable dynamically
              if "SNAPSHOT" in '${release_version}':
                  releaseVariables['ext_isRelease'] = "false"
                  releaseVariables['version'] = "SNAPSHOT"
              else:
                  releaseVariables['ext_isRelease'] = "true"
                  releaseVariables['version'] = "RELEASE"
              
              ## get id of sequential group to insert tasks into
              sequentialGroupId = None
              parenttask = getCurrentTask().container
              sequentialGroupId_list = []
              for child in parenttask.getChildren():
                  if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                      sequentialGroupId_list.append( child.id)
              sequentialGroupId = sequentialGroupId_list[1]
              
              #Set AAP resources Ids
              varList = releaseApi.getVariables(release.id)
              
              for obj in varList:
                  if "AAP-id" in obj.key and "credentials" in obj.key:
                      credential_id = obj.value
                  if "AAP-id" in obj.key and "job_templates" in obj.key:
                      job_template_id = obj.value
                  if "AAP-id" in obj.key and "inventories" in obj.key:
                      inventory_id = obj.value
              
              for component in sas_list:
              
                  ##creation de t?che ansible
                    taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                    taskUpdateReleaseIds.title = 'deploy ' + str(component) + " " + '${release_version}'
                    extravarsName = str(component) + "_extra_vars"
                    taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                    taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                    taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                    taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables[extravarsName])
                    taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
              
              
                  ##ajout de la task ansible sur le group sequential
                    taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
        color: "#498500"
    variables:
      - type: xlrelease.StringVariable
        key: release_version
        label: Version
      - type: xlrelease.StringVariable
        key: AAP-name-organizations
        requiresValue: false
        showOnReleaseStart: false
        value: CARDIF_GDA-OPS
      - type: xlrelease.StringVariable
        key: pipeline
        requiresValue: false
        showOnReleaseStart: false
        value: cd_wlc_xlr
      - type: xlrelease.StringVariable
        key: ext_chainNum
        label: couloir
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "01"
            - "02"
      - type: xlrelease.StringVariable
        key: artifact_user
        label: UID
      - type: xlrelease.PasswordStringVariable
        key: artifact_passwd
        label: Password
      - type: xlrelease.StringVariable
        key: ext_envc
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: env
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ext_appVersion
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.ListStringVariable
        key: modules_todeploy
        requiresValue: false
        showOnReleaseStart: false
        label: biz and/or prez
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - biz
        value:
          - biz
      - type: xlrelease.StringVariable
        key: ext_env
        requiresValue: false
        showOnReleaseStart: false
        label: Environment
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - int
            - ppd
            - prod
            - rec1
            - rec2
        value: int
      - type: xlrelease.StringVariable
        key: ext_isRelease
        requiresValue: false
        showOnReleaseStart: false
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "true"
            - "false"
      - type: xlrelease.StringVariable
        key: playbook
        showOnReleaseStart: false
        label: create socle or deploy application
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - deploy
        value: deploy
      - type: xlrelease.StringVariable
        key: ext_environnement
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ext_appLayer
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ansible_python_interpreter
        requiresValue: false
        showOnReleaseStart: false
        value: /usr/bin/python3
      - type: xlrelease.StringVariable
        key: ext_appenv
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ap_code
        requiresValue: false
        showOnReleaseStart: false
        value: "AP${codeAP}"
      - type: xlrelease.StringVariable
        key: codeAP
        requiresValue: false
        showOnReleaseStart: false
        value: "23882"
      - type: xlrelease.StringVariable
        key: trigram
        requiresValue: false
        showOnReleaseStart: false
        value: rat
      - type: xlrelease.StringVariable
        key: code5car
        requiresValue: false
        showOnReleaseStart: false
        value: rat00
      - type: xlrelease.StringVariable
        key: ext_projectID
        requiresValue: false
        showOnReleaseStart: false
        value: "1212"
      - type: xlrelease.StringVariable
        key: ext_artifactPath
        requiresValue: false
        showOnReleaseStart: false
        value: com/bnpcardif
      - type: xlrelease.StringVariable
        key: ext_artifactId
        requiresValue: false
        showOnReleaseStart: false
        value: "maven-${version}"
      - type: xlrelease.StringVariable
        key: ext_ear_binary_url
        requiresValue: false
        showOnReleaseStart: false
        value: NONE
      - type: xlrelease.StringVariable
        key: ext_sharedLib_binary_url
        requiresValue: false
        showOnReleaseStart: false
        value: NONE
      - type: xlrelease.StringVariable
        key: ext_sharedLibEnv
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: biz_ModuleName
        requiresValue: false
        showOnReleaseStart: false
        value: carat_SERV_EAR
      - type: xlrelease.StringVariable
        key: biz_sharedModuleName
        requiresValue: false
        showOnReleaseStart: false
        value: carat_SERV_EAR
      - type: xlrelease.StringVariable
        key: biz_modlib
        requiresValue: false
        showOnReleaseStart: false
        value: carat
      - type: xlrelease.StringVariable
        key: biz_contextRoot
        requiresValue: false
        showOnReleaseStart: false
        value: /
      - type: xlrelease.StringVariable
        key: biz_jvmClassLoader
        requiresValue: false
        showOnReleaseStart: false
        value: ParentFirst
      - type: xlrelease.StringVariable
        key: biz_alterconfig
        requiresValue: false
        showOnReleaseStart: false
        value: "yes"
      - type: xlrelease.StringVariable
        key: biz_xcaliaResource
        requiresValue: false
        showOnReleaseStart: false
        value: "no"
      - type: xlrelease.StringVariable
        key: biz_autoExpand
        requiresValue: false
        showOnReleaseStart: false
        value: "false"
      - type: xlrelease.StringVariable
        key: biz_jndiEntry
        requiresValue: false
        showOnReleaseStart: false
        value: "no"
      - type: xlrelease.StringVariable
        key: biz_jndiEntryList
        requiresValue: false
        showOnReleaseStart: false
        value: "[{'name': 'string', 'value': 'string'}, {'name': 'string', 'value': 'string'}]"
      - type: xlrelease.StringVariable
        key: biz_safResource
        requiresValue: false
        showOnReleaseStart: false
        value: "no"
      - type: xlrelease.StringVariable
        key: biz_jvmEnabledFeaturesList
        requiresValue: false
        showOnReleaseStart: false
        value: "[{'name': 'localConnector-1.0'}, {'name': 'el-3.0'}, {'name': 'jdbc-4.1'},\
      \ {'name': 'jsp-2.3'}, {'name': 'jndi-1.0'}, {'name': 'servlet-3.1'}, {'name':\
      \ 'transportSecurity-1.0'}, {'name': 'concurrent-1.0'}, {'name': 'javaMail-1.5'},\
      \ {'name': 'beanValidation-1.1'}]"
      - type: xlrelease.StringVariable
        key: biz_ext_appLayer
        requiresValue: false
        showOnReleaseStart: false
        value: biz
      - type: xlrelease.MapStringStringVariable
        key: biz_extra_vars
        requiresValue: false
        showOnReleaseStart: false
        value:
          ext_artifactId: "${ext_artifactId}"
          biz_jvmClassLoader: "${biz_jvmClassLoader}"
          biz_alterconfig: "${biz_alterconfig}"
          biz_jvmEnabledFeaturesList: "${biz_jvmEnabledFeaturesList}"
          env: "${env}"
          ap_code: "${ap_code}"
          ext_environnement: "${ext_environnement}"
          ext_sharedLib_binary_url: "${ext_sharedLib_binary_url}"
          trigram: "${trigram}"
          ext_isRelease: "${ext_isRelease}"
          ext_ear_binary_url: "${ext_ear_binary_url}"
          ext_appVersion: "${release_version}"
          biz_autoExpand: "${biz_autoExpand}"
          ext_chainNum: "${ext_chainNum}"
          biz_modlib: "${biz_modlib}"
          ext_artifactPath: "${ext_artifactPath}"
          biz_jndiEntryList: "${biz_jndiEntryList}"
          ext_projectID: "${ext_projectID}"
          ext_appenv: "${ext_appenv}"
          ansible_python_interpreter: "${ansible_python_interpreter}"
          biz_jndiEntry: "${biz_jndiEntry}"
          code5car: "${code5car}"
          biz_safResource: "${biz_safResource}"
          ext_sharedLibEnv: "${ext_sharedLibEnv}"
          ext_appLayer: "${biz_ext_appLayer}"
          biz_contextRoot: "${biz_contextRoot}"
          biz_ModuleName: "${biz_ModuleName}"
          biz_xcaliaResource: "${biz_xcaliaResource}"
          biz_sharedModuleName: "${biz_sharedModuleName}"
          codeAP: "${codeAP}"
      - type: xlrelease.StringVariable
        key: version
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.IntegerVariable
        key: index
        requiresValue: false
        showOnReleaseStart: false
    allowPasswordsInAllFields: true
    scriptUsername: RunAsUser
    variableMapping:
      scriptUserPassword: "${global.RunAsUserPassword}"
    riskProfile: Default risk profile
  - template: TEST
    scheduledStartDate: 2025-01-24T09:00:00+01:00
    dueDate: 2025-01-24T10:00:00+01:00
    phases:
      - phase: TEST BUILD
        tasks:
          - name: test
            type: jenkins.Build
          - name: test condition
            type: ansibletower.launchAndWait
            ansibletower: devopstc-ansibleAutomation-HORSPROD
            precondition: "releaseVariables['jobstatus'] == 'Success'"
            variableMapping:
              pythonScript.status: "${jobstatus}"
          - name: test par group
            type: xlrelease.ParallelGroup
        color: "#3d6c9e"
    variables:
      - type: xlrelease.StringVariable
        key: jobstatus
        requiresValue: false
        showOnReleaseStart: false
    riskProfile: Default risk profile
    author: "316062"
  - template: cd-Infolivre-AP23882-CARAT-CREATE COULOIR EBX V6-Multienv-ok
    scheduledStartDate: 2023-12-26T09:00:00+01:00
    dueDate: 2023-12-26T10:00:00+01:00
    phases:
      - phase: rec
        tasks:
          - name: üëâ CHOOSE LANE
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - ext_chainNum
          - name: üè≠ ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              # get phase name / environment
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title[0:3]
              releaseVariables['ext_env'] = phase_name
              releaseVariables['ext_envc'] = str(phase_name)[0]
              releaseVariables['ext_envd'] = str(phase_name)[0].upper()
              
              #set env variable from phase_name
              if str(phase_name) == "int":
                releaseVariables['hosts'] = releaseVariables['hosts_int']
                env = "HORSPROD"
              if str(phase_name) == "rec":
                  rec_chainNum = '${ext_chainNum}'
                  if map(int,str(rec_chainNum))[0] == 0:
                      chainNum = rec_chainNum[1]
                  else:
                      chainNum = rec_chainNum
                  host_var = "hosts_rec" + str(chainNum)
                  releaseVariables['hosts'] = releaseVariables[host_var]
                  env = "ISOPROD"
              if str(phase_name) == "ppd":
                releaseVariables['hosts'] = releaseVariables['hosts_ppd']
                env = "PROD"
              if str(phase_name) == "prd":
                releaseVariables['hosts'] = releaseVariables['hosts_prd']
                env = "PROD"
              
              releaseVariables['env'] = str(env)
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + 'AP${codeAP}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              ## AAP Project
              project = "p-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}'
              var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
              var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
              releaseVariables[var_poject_name] = project
              releaseVariables[var_poject_id] = ""
              
              
              ## Set AAP Inventories
              inventory = "i-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(env)
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = str(phase_name) + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: ‚ö° SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES ID's
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                              taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                              taskCheckResource.pythonScript.setProperty("method", 'GET')
                              taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskCheckResource.setTaskFailureHandlerEnabled(True)
                              taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskCheckResource.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskCheckResource)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Set Credential task generator
                    type: xlrelease.ScriptTask
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      playbook = 'deploy_new_user.yml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\"" + ", " + "\"" + "scm_update_on_launch" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_delete_on_update" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_clean" + "\"" + ": " + "\"" + "True" + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "update " + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  
                  
                  ##Create task
                  taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                  taskUpdateReleaseIds.title = 'deploy Draft Control-M' + " " + 'on ' + '${ext_env}' + '${ext_chainNum}'
                  taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                  taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables['extra_vars'])
                  taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                  ##Add task in sequential group
                  taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöß DEPLOY GROUP
                type: xlrelease.SequentialGroup
          - name: ‚úã VALIDATION
            type: xlrelease.GateTask
        color: "#d61f21"
      - phase: qua
        tasks:
          - name: üëâ CHOOSE LANE
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - ext_chainNum
          - name: üè≠ ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              # get phase name / environment
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              releaseVariables['ext_env'] = phase_name
              
              #set env variable from phase_name
              if str(phase_name) == "int":
                releaseVariables['hosts'] = releaseVariables['hosts_int']
                releaseVariables['env'] = "HORSPROD"
              if str(phase_name) == "rec":
                  rec_chainNum = '${ext_chainNum}'
                  if map(int,str(rec_chainNum))[0] == 0:
                      chainNum = rec_chainNum[1]
                  else:
                      chainNum = rec_chainNum
                  host_var = "hosts_rec" + str(chainNum)
                  releaseVariables['hosts'] = releaseVariables[host_var]
                  releaseVariables['env'] = "ISOPROD"
              if str(phase_name) == "ppd":
                releaseVariables['hosts'] = releaseVariables['hosts_ppd']
                releaseVariables['env'] = "PROD"
              if str(phase_name) == "prd":
                releaseVariables['hosts'] = releaseVariables['hosts_prd']
                releaseVariables['env'] = "PROD"
              
              
              #Set if the version is release from url input
              if "SNAPSHOT" in '':
                  releaseVariables['isRelease'] = "false"
              else:
                  releaseVariables['isRelease'] = "true"
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + 'AP${codeAP}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              ## AAP Project
              project = "p-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}'
              var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
              var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
              releaseVariables[var_poject_name] = project
              releaseVariables[var_poject_id] = ""
              
              
              ## Set AAP Inventories
              if str(phase_name) == "rec":
                  inventory = "i-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(phase_name).upper() + str(chainNum)
              else:
                  inventory = "i-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(phase_name).upper()
              
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = str(phase_name) + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: ‚ö° SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES ID's
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                              taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                              taskCheckResource.pythonScript.setProperty("method", 'GET')
                              taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskCheckResource.setTaskFailureHandlerEnabled(True)
                              taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskCheckResource.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskCheckResource)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Set Credential task generator
                    type: xlrelease.ScriptTask
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      if "Rollback" in str(phase_name):
                          playbook = 'deploy_rollback.yml'
                      else:
                          playbook = 'deploy_infolivre.yml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\"" + ", " + "\"" + "scm_update_on_launch" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_delete_on_update" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_clean" + "\"" + ": " + "\"" + "True" + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "update " + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  
                  
                  ##Create task
                  taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                  taskUpdateReleaseIds.title = 'deploy Draft Control-M' + " " + 'on ' + '${ext_env}' + '${ext_chainNum}'
                  taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                  taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables['extra_vars'])
                  taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                  ##Add task in sequential group
                  taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöß DEPLOY GROUP
                type: xlrelease.SequentialGroup
          - name: ‚úã VALIDATION
            type: xlrelease.GateTask
        color: "#ff9e49"
      - phase: ppd
        tasks:
          - name: üëâ CHOOSE LANE
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - ext_chainNum
          - name: üè≠ ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              # get phase name / environment
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              releaseVariables['ext_env'] = phase_name
              
              #set env variable from phase_name
              if str(phase_name) == "int":
                releaseVariables['hosts'] = releaseVariables['hosts_int']
                releaseVariables['env'] = "HORSPROD"
              if str(phase_name) == "rec":
                  rec_chainNum = '${ext_chainNum}'
                  if map(int,str(rec_chainNum))[0] == 0:
                      chainNum = rec_chainNum[1]
                  else:
                      chainNum = rec_chainNum
                  host_var = "hosts_rec" + str(chainNum)
                  releaseVariables['hosts'] = releaseVariables[host_var]
                  releaseVariables['env'] = "ISOPROD"
              if str(phase_name) == "ppd":
                releaseVariables['hosts'] = releaseVariables['hosts_ppd']
                releaseVariables['env'] = "PROD"
              if str(phase_name) == "prd":
                releaseVariables['hosts'] = releaseVariables['hosts_prd']
                releaseVariables['env'] = "PROD"
              
              
              #Set if the version is release from url input
              if "SNAPSHOT" in '':
                  releaseVariables['isRelease'] = "false"
              else:
                  releaseVariables['isRelease'] = "true"
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + 'AP${codeAP}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              ## AAP Project
              project = "p-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}'
              var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
              var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
              releaseVariables[var_poject_name] = project
              releaseVariables[var_poject_id] = ""
              
              
              ## Set AAP Inventories
              if str(phase_name) == "rec":
                  inventory = "i-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(phase_name).upper() + str(chainNum)
              else:
                  inventory = "i-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(phase_name).upper()
              
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = str(phase_name) + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: ‚ö° SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES ID's
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                              taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                              taskCheckResource.pythonScript.setProperty("method", 'GET')
                              taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskCheckResource.setTaskFailureHandlerEnabled(True)
                              taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskCheckResource.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskCheckResource)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Set Credential task generator
                    type: xlrelease.ScriptTask
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      if "Rollback" in str(phase_name):
                          playbook = 'deploy_rollback.yml'
                      else:
                          playbook = 'deploy_infolivre.yml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\"" + ", " + "\"" + "scm_update_on_launch" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_delete_on_update" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_clean" + "\"" + ": " + "\"" + "True" + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "update " + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  
                  
                  ##Create task
                  taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                  taskUpdateReleaseIds.title = 'deploy Draft Control-M' + " " + 'on ' + '${ext_env}' + '${ext_chainNum}'
                  taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                  taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables['extra_vars'])
                  taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                  ##Add task in sequential group
                  taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöß DEPLOY GROUP
                type: xlrelease.SequentialGroup
          - name: ‚úã VALIDATION
            type: xlrelease.GateTask
        color: "#3d6c9e"
      - phase: prd
        tasks:
          - name: üëâ CHOOSE LANE
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - ext_chainNum
          - name: üè≠ ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              # get phase name / environment
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              releaseVariables['ext_env'] = phase_name
              
              #set env variable from phase_name
              if str(phase_name) == "int":
                releaseVariables['hosts'] = releaseVariables['hosts_int']
                releaseVariables['env'] = "HORSPROD"
              if str(phase_name) == "rec":
                  rec_chainNum = '${ext_chainNum}'
                  if map(int,str(rec_chainNum))[0] == 0:
                      chainNum = rec_chainNum[1]
                  else:
                      chainNum = rec_chainNum
                  host_var = "hosts_rec" + str(chainNum)
                  releaseVariables['hosts'] = releaseVariables[host_var]
                  releaseVariables['env'] = "ISOPROD"
              if str(phase_name) == "ppd":
                releaseVariables['hosts'] = releaseVariables['hosts_ppd']
                releaseVariables['env'] = "PROD"
              if str(phase_name) == "prd":
                releaseVariables['hosts'] = releaseVariables['hosts_prd']
                releaseVariables['env'] = "PROD"
              
              
              #Set if the version is release from url input
              if "SNAPSHOT" in '':
                  releaseVariables['isRelease'] = "false"
              else:
                  releaseVariables['isRelease'] = "true"
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + 'AP${codeAP}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              ## AAP Project
              project = "p-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}'
              var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
              var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
              releaseVariables[var_poject_name] = project
              releaseVariables[var_poject_id] = ""
              
              
              ## Set AAP Inventories
              if str(phase_name) == "rec":
                  inventory = "i-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(phase_name).upper() + str(chainNum)
              else:
                  inventory = "i-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(phase_name).upper()
              
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = str(phase_name) + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: ‚ö° SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES ID's
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                              taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                              taskCheckResource.pythonScript.setProperty("method", 'GET')
                              taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskCheckResource.setTaskFailureHandlerEnabled(True)
                              taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskCheckResource.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskCheckResource)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Set Credential task generator
                    type: xlrelease.ScriptTask
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      if "Rollback" in str(phase_name):
                          playbook = 'deploy_rollback.yml'
                      else:
                          playbook = 'deploy_infolivre.yml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\"" + ", " + "\"" + "scm_update_on_launch" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_delete_on_update" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_clean" + "\"" + ": " + "\"" + "True" + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "update " + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  
                  
                  ##Create task
                  taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                  taskUpdateReleaseIds.title = 'deploy Draft Control-M' + " " + 'on ' + '${ext_env}' + '${ext_chainNum}'
                  taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                  taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables['extra_vars'])
                  taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                  ##Add task in sequential group
                  taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöß DEPLOY GROUP
                type: xlrelease.SequentialGroup
        color: "#498500"
    variables:
      - type: xlrelease.StringVariable
        key: codeAP
        showOnReleaseStart: false
        label: AP Code of the application
        description: set once
        value: "23882"
      - type: xlrelease.StringVariable
        key: ext_projectID
        showOnReleaseStart: false
        label: Project ID of the devops space
        description: set once
        value: "1212"
      - type: xlrelease.StringVariable
        key: trigram
        showOnReleaseStart: false
        label: Trigram of the application
        description: set once
        value: rat
      - type: xlrelease.StringVariable
        key: code5car
        showOnReleaseStart: false
        label: Pentagram of the application
        description: set once
        value: rat00
      - type: xlrelease.ListStringVariable
        key: hosts_int
        showOnReleaseStart: false
        label: List of hosts for int environment
        value:
          - s02vl9904804.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_rec1
        showOnReleaseStart: false
        label: Lists of hosts for rec1 environnement
        value:
          - s02vl9904789.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_rec2
        showOnReleaseStart: false
        label: Lists of hosts for rec2 environnement
        value:
          - s02vl9904790.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_ppd
        requiresValue: false
        showOnReleaseStart: false
        label: List of hosts for ppd environment
        value:
          - s02vl9904787.fr.net.intra
          - s02vl9904788.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_prd
        requiresValue: false
        showOnReleaseStart: false
        label: List of hosts for prd environment
        value:
          - s02vl9904791.fr.net.intra
          - s02vl9904792.fr.net.intra
      - type: xlrelease.StringVariable
        key: pipeline
        showOnReleaseStart: false
        label: devops space pipeline name
        value: cd_create_couloir_xlr
      - type: xlrelease.StringVariable
        key: AAP-name-organizations
        requiresValue: false
        showOnReleaseStart: false
        label: AAP organization name
        value: CARDIF_GDA-OPS
      - type: xlrelease.StringVariable
        key: scm_url
        showOnReleaseStart: false
        label: TO offer git repository
        value: https://gitlab-dogen.group.echonet/Retail/cardif/moe_carat/e0511_carat/cd_create_couloir_xlr.git
      - type: xlrelease.StringVariable
        key: scm_branch
        showOnReleaseStart: false
        label: TO offer git repository branch
        value: develop
      - type: xlrelease.StringVariable
        key: user
        label: UID
      - type: xlrelease.PasswordStringVariable
        key: password
        label: Password
      - type: xlrelease.StringVariable
        key: env
        showOnReleaseStart: false
        label: Ansible Environment
        description: set dynamically
      - type: xlrelease.StringVariable
        key: ext_env
        showOnReleaseStart: false
        label: Environment
        description: set dynamically
      - type: xlrelease.StringVariable
        key: ext_chainNum
        showOnReleaseStart: false
        label: Lane number
        description: Number of targeted lane
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "01"
            - "02"
            - "03"
            - "04"
            - "05"
            - "06"
            - "07"
            - "08"
            - "09"
      - type: xlrelease.ListStringVariable
        key: hosts
        showOnReleaseStart: false
        label: List of hosts
        description: Add target host
      - type: xlrelease.MapStringStringVariable
        key: extra_vars
        requiresValue: false
        showOnReleaseStart: false
        value:
          ext_appAction: "${ext_appAction}"
          ext_chainNum: "${ext_chainNum}"
          ext_projectID: "${ext_projectID}"
          env: "${env}"
          ext_envc: "${ext_envc}"
          ap_code: "${ap_code}"
          ext_envd: "${ext_envd}"
          code5car: "${code5car}"
          ext_modlib: "${ext_modlib}"
          trigram: "${trigram}"
          ext_env: "${ext_env}"
          ext_repo_passwd: "${password}"
          ext_repo_user: "${user}"
          ext_appFullName: "${ext_appFullName}"
          hosts: "${hosts}"
          ext_appOptArgs: "${ext_appOptArgs}"
          codeAP: "${codeAP}"
      - type: xlrelease.IntegerVariable
        key: index
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ext_appAction
        showOnReleaseStart: false
        value: create_couloir
      - type: xlrelease.StringVariable
        key: ext_appOptArgs
        requiresValue: false
        value: force
      - type: xlrelease.StringVariable
        key: ext_appFullName
        showOnReleaseStart: false
        value: socle
      - type: xlrelease.StringVariable
        key: ext_envc
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ext_envd
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ext_modlib
        showOnReleaseStart: false
        value: carat
      - type: xlrelease.StringVariable
        key: ap_code
        requiresValue: false
        showOnReleaseStart: false
        value: "${codeAP}"
    allowPasswordsInAllFields: true
    scriptUsername: runasuser
    variableMapping:
      scriptUserPassword: "${global.RunAsUserPassword}"
    riskProfile: Default risk profile
  - template: cd-Infolivre-AP23882-CARAT-CREATE COULOIR EBX V6-WITH_NAS - ok
    scheduledStartDate: 2023-12-26T09:00:00+01:00
    dueDate: 2023-12-26T10:00:00+01:00
    phases:
      - phase: int
        tasks:
          - name: üëâ CHOOSE LANE
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - ext_chainNum
          - name: üè≠ ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              # get phase name / environment
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              releaseVariables['ext_env'] = phase_name
              
              #set env variable from phase_name
              if str(phase_name) == "int":
                releaseVariables['hosts'] = releaseVariables['hosts_int']
                releaseVariables['env'] = "HORSPROD"
                releaseVariables['ext_envc'] = "i"
                releaseVariables['ext_envd'] = "I"
              
              if str(phase_name) == "rec":
                  rec_chainNum = '${ext_chainNum}'
                  if map(int,str(rec_chainNum))[0] == 0:
                      chainNum = rec_chainNum[1]
                  else:
                      chainNum = rec_chainNum
                  host_var = "hosts_rec" + str(chainNum)
                  releaseVariables['hosts'] = releaseVariables[host_var]
                  releaseVariables['env'] = "ISOPROD"
                  releaseVariables['ext_envc'] = "r"
                  releaseVariables['ext_envd'] = "R"
              
              if str(phase_name) == "ppd":
                releaseVariables['hosts'] = releaseVariables['hosts_ppd']
                releaseVariables['env'] = "PROD"
                releaseVariables['ext_envc'] = "x"
                releaseVariables['ext_envd'] = "X"
              
              if str(phase_name) == "prd":
                releaseVariables['hosts'] = releaseVariables['hosts_prd']
                releaseVariables['env'] = "PROD"
                releaseVariables['ext_envc'] = "p"
                releaseVariables['ext_envd'] = "P"
              
              
              #Set if the version is release from url input
              if "SNAPSHOT" in '':
                  releaseVariables['isRelease'] = "false"
              else:
                  releaseVariables['isRelease'] = "true"
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + 'AP${codeAP}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + 'AP${codeAP}' + "-" + '${pipeline}_v6' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              ## AAP Project
              project = "p-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}'
              var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
              var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
              releaseVariables[var_poject_name] = project
              releaseVariables[var_poject_id] = ""
              
              
              ## Set AAP Inventories
              
              #inventory = "i-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + releaseVariables['env']
              
              if str(phase_name) == "rec":
                  inventory = "i-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(phase_name).upper() + str(chainNum)
              else:
                  inventory = "i-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + releaseVariables['env']
              
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = str(phase_name) + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: ‚ö° SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES ID's
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                              taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                              taskCheckResource.pythonScript.setProperty("method", 'GET')
                              taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskCheckResource.setTaskFailureHandlerEnabled(True)
                              taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskCheckResource.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskCheckResource)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Set Credential task generator
                    type: xlrelease.ScriptTask
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      if releaseVariables['ext_appAction'] == "delete_couloir":
                          playbook = 'delete_couloir.yml'
                      else:
                          playbook = 'deploy_new_user.yml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\"" + ", " + "\"" + "scm_update_on_launch" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_delete_on_update" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_clean" + "\"" + ": " + "\"" + "True" + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "update " + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  
                  
                  ##Create task
                  taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                  taskUpdateReleaseIds.title = 'create couloir' + " " + 'on ' + '${ext_env}' + '${ext_chainNum}'
                  taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                  taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables['extra_vars'])
                  taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                  ##Add task in sequential group
                  taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöß DEPLOY GROUP
                type: xlrelease.SequentialGroup
          - name: ‚úã VALIDATION
            type: xlrelease.GateTask
        color: "#d61f21"
      - phase: rec
        tasks:
          - name: üëâ CHOOSE LANE
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - ext_chainNum
          - name: üè≠ ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              # get phase name / environment
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              releaseVariables['ext_env'] = phase_name
              
              #set env variable from phase_name
              if str(phase_name) == "int":
                releaseVariables['hosts'] = releaseVariables['hosts_int']
                releaseVariables['env'] = "HORSPROD"
                releaseVariables['ext_envc'] = "i"
                releaseVariables['ext_envd'] = "I"
              
              if str(phase_name) == "rec":
                  rec_chainNum = '${ext_chainNum}'
                  if map(int,str(rec_chainNum))[0] == 0:
                      chainNum = rec_chainNum[1]
                  else:
                      chainNum = rec_chainNum
                  host_var = "hosts_rec" + str(chainNum)
                  releaseVariables['hosts'] = releaseVariables[host_var]
                  releaseVariables['env'] = "ISOPROD"
                  releaseVariables['ext_envc'] = "r"
                  releaseVariables['ext_envd'] = "R"
              
              if str(phase_name) == "ppd":
                releaseVariables['hosts'] = releaseVariables['hosts_ppd']
                releaseVariables['env'] = "PROD"
                releaseVariables['ext_envc'] = "x"
                releaseVariables['ext_envd'] = "X"
              
              if str(phase_name) == "prd":
                releaseVariables['hosts'] = releaseVariables['hosts_prd']
                releaseVariables['env'] = "PROD"
                releaseVariables['ext_envc'] = "p"
                releaseVariables['ext_envd'] = "P"
              
              
              #Set if the version is release from url input
              if "SNAPSHOT" in '':
                  releaseVariables['isRelease'] = "false"
              else:
                  releaseVariables['isRelease'] = "true"
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + 'AP${codeAP}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + 'AP${codeAP}' + "-" + '${pipeline}_v6' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              ## AAP Project
              project = "p-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}'
              var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
              var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
              releaseVariables[var_poject_name] = project
              releaseVariables[var_poject_id] = ""
              
              
              ## Set AAP Inventories
              #inventory = "i-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + releaseVariables['env']
              
              if str(phase_name) == "rec":
                  inventory = "i-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(phase_name).upper() + str(chainNum)
              else:
                  inventory = "i-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + releaseVariables['env']
              
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = str(phase_name) + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: ‚ö° SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES ID's
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                              taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                              taskCheckResource.pythonScript.setProperty("method", 'GET')
                              taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskCheckResource.setTaskFailureHandlerEnabled(True)
                              taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskCheckResource.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskCheckResource)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Set Credential task generator
                    type: xlrelease.ScriptTask
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      if releaseVariables['ext_appAction'] == "delete_couloir":
                          playbook = 'delete_couloir.yml'
                      else:
                          playbook = 'deploy_new_user.yml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\"" + ", " + "\"" + "scm_update_on_launch" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_delete_on_update" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_clean" + "\"" + ": " + "\"" + "True" + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "update " + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  
                  
                  ##Create task
                  taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                  taskUpdateReleaseIds.title = 'create couloir' + " " + 'on ' + '${ext_env}' + '${ext_chainNum}'
                  taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                  taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables['extra_vars'])
                  taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                  ##Add task in sequential group
                  taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöß DEPLOY GROUP
                type: xlrelease.SequentialGroup
          - name: ‚úã VALIDATION
            type: xlrelease.GateTask
        color: "#d61f21"
      - phase: ppd
        tasks:
          - name: üëâ CHOOSE LANE
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - ext_chainNum
          - name: üè≠ ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              # get phase name / environment
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              releaseVariables['ext_env'] = phase_name
              
              #set env variable from phase_name
              if str(phase_name) == "int":
                releaseVariables['hosts'] = releaseVariables['hosts_int']
                releaseVariables['env'] = "HORSPROD"
                releaseVariables['ext_envc'] = "i"
                releaseVariables['ext_envd'] = "I"
              
              if str(phase_name) == "rec":
                  rec_chainNum = '${ext_chainNum}'
                  if map(int,str(rec_chainNum))[0] == 0:
                      chainNum = rec_chainNum[1]
                  else:
                      chainNum = rec_chainNum
                  host_var = "hosts_rec" + str(chainNum)
                  releaseVariables['hosts'] = releaseVariables[host_var]
                  releaseVariables['env'] = "ISOPROD"
                  releaseVariables['ext_envc'] = "r"
                  releaseVariables['ext_envd'] = "R"
              
              if str(phase_name) == "ppd":
                releaseVariables['hosts'] = releaseVariables['hosts_ppd']
                releaseVariables['env'] = "PROD"
                releaseVariables['ext_envc'] = "x"
                releaseVariables['ext_envd'] = "X"
              
              if str(phase_name) == "prd":
                releaseVariables['hosts'] = releaseVariables['hosts_prd']
                releaseVariables['env'] = "PROD"
                releaseVariables['ext_envc'] = "p"
                releaseVariables['ext_envd'] = "P"
              
              
              #Set if the version is release from url input
              if "SNAPSHOT" in '':
                  releaseVariables['isRelease'] = "false"
              else:
                  releaseVariables['isRelease'] = "true"
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + 'AP${codeAP}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + 'AP${codeAP}' + "-" + '${pipeline}_v6' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              ## AAP Project
              project = "p-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}'
              var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
              var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
              releaseVariables[var_poject_name] = project
              releaseVariables[var_poject_id] = ""
              
              
              ## Set AAP Inventories
              
              #inventory = "i-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + releaseVariables['env']
              
              if str(phase_name) == "rec":
                  inventory = "i-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(phase_name).upper() + str(chainNum)
              else:
                  inventory = "i-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(phase_name).upper()
              
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = str(phase_name) + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: ‚ö° SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES ID's
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                              taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                              taskCheckResource.pythonScript.setProperty("method", 'GET')
                              taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskCheckResource.setTaskFailureHandlerEnabled(True)
                              taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskCheckResource.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskCheckResource)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Set Credential task generator
                    type: xlrelease.ScriptTask
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      if releaseVariables['ext_appAction'] == "delete_couloir":
                          playbook = 'delete_couloir.yml'
                      else:
                          playbook = 'deploy_new_user.yml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\"" + ", " + "\"" + "scm_update_on_launch" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_delete_on_update" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_clean" + "\"" + ": " + "\"" + "True" + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "update " + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  
                  
                  ##Create task
                  taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                  taskUpdateReleaseIds.title = 'create couloir' + " " + 'on ' + '${ext_env}' + '${ext_chainNum}'
                  taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                  taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables['extra_vars'])
                  taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                  ##Add task in sequential group
                  taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöß DEPLOY GROUP
                type: xlrelease.SequentialGroup
          - name: ‚úã VALIDATION
            type: xlrelease.GateTask
        color: "#3d6c9e"
      - phase: prd
        tasks:
          - name: üëâ CHOOSE LANE
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - ext_chainNum
          - name: üè≠ ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              # get phase name / environment
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              releaseVariables['ext_env'] = phase_name
              
              #set env variable from phase_name
              if str(phase_name) == "int":
                releaseVariables['hosts'] = releaseVariables['hosts_int']
                releaseVariables['env'] = "HORSPROD"
                releaseVariables['ext_envc'] = "i"
                releaseVariables['ext_envd'] = "I"
              
              if str(phase_name) == "rec":
                  rec_chainNum = '${ext_chainNum}'
                  if map(int,str(rec_chainNum))[0] == 0:
                      chainNum = rec_chainNum[1]
                  else:
                      chainNum = rec_chainNum
                  host_var = "hosts_rec" + str(chainNum)
                  releaseVariables['hosts'] = releaseVariables[host_var]
                  releaseVariables['env'] = "ISOPROD"
                  releaseVariables['ext_envc'] = "r"
                  releaseVariables['ext_envd'] = "R"
              
              if str(phase_name) == "ppd":
                releaseVariables['hosts'] = releaseVariables['hosts_ppd']
                releaseVariables['env'] = "PROD"
                releaseVariables['ext_envc'] = "x"
                releaseVariables['ext_envd'] = "X"
              
              if str(phase_name) == "prd":
                releaseVariables['hosts'] = releaseVariables['hosts_prd']
                releaseVariables['env'] = "PROD"
                releaseVariables['ext_envc'] = "p"
                releaseVariables['ext_envd'] = "P"
              
              
              #Set if the version is release from url input
              if "SNAPSHOT" in '':
                  releaseVariables['isRelease'] = "false"
              else:
                  releaseVariables['isRelease'] = "true"
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + 'AP${codeAP}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + 'AP${codeAP}' + "-" + '${pipeline}_v6' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              ## AAP Project
              project = "p-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}'
              var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
              var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
              releaseVariables[var_poject_name] = project
              releaseVariables[var_poject_id] = ""
              
              
              ## Set AAP Inventories
              
              #inventory = "i-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + releaseVariables['env']
              
              if str(phase_name) == "rec":
                  inventory = "i-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(phase_name).upper() + str(chainNum)
              else:
                  inventory = "i-" + 'AP${codeAP}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + releaseVariables['env']
              
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = str(phase_name) + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: ‚ö° SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES ID's
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                              taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                              taskCheckResource.pythonScript.setProperty("method", 'GET')
                              taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskCheckResource.setTaskFailureHandlerEnabled(True)
                              taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskCheckResource.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskCheckResource)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Set Credential task generator
                    type: xlrelease.ScriptTask
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      
                      if releaseVariables['ext_appAction'] == "delete_couloir":
                          playbook = 'delete_couloir.yml'
                      else:
                          playbook = 'deploy_new_user.yml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\"" + ", " + "\"" + "scm_update_on_launch" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_delete_on_update" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_clean" + "\"" + ": " + "\"" + "True" + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "update " + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  
                  
                  ##Create task
                  taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                  taskUpdateReleaseIds.title = 'create couloir' + " " + 'on ' + '${ext_env}' + '${ext_chainNum}'
                  taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                  taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables['extra_vars'])
                  taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                  ##Add task in sequential group
                  taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöß DEPLOY GROUP
                type: xlrelease.SequentialGroup
        color: "#498500"
    variables:
      - type: xlrelease.StringVariable
        key: codeAP
        showOnReleaseStart: false
        label: AP Code of the application
        description: set once
        value: "23882"
      - type: xlrelease.StringVariable
        key: ext_projectID
        showOnReleaseStart: false
        label: Project ID of the devops space
        description: set once
        value: "1212"
      - type: xlrelease.StringVariable
        key: trigram
        showOnReleaseStart: false
        label: Trigram of the application
        description: set once
        value: rat
      - type: xlrelease.StringVariable
        key: code5car
        showOnReleaseStart: false
        label: Pentagram of the application
        description: set once
        value: rat00
      - type: xlrelease.ListStringVariable
        key: hosts_int
        showOnReleaseStart: false
        label: List of hosts for int environment
        value:
          - s02vl9904804.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_rec1
        showOnReleaseStart: false
        label: Lists of hosts for rec1 environnement
        value:
          - s02vl9904789.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_rec2
        showOnReleaseStart: false
        label: Lists of hosts for rec2 environnement
        value:
          - s02vl9904790.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_ppd
        requiresValue: false
        showOnReleaseStart: false
        label: List of hosts for ppd environment
        value:
          - s02vl9904787.fr.net.intra
          - s02vl9904788.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_prd
        requiresValue: false
        showOnReleaseStart: false
        label: List of hosts for prd environment
        value:
          - s02vl9904791.fr.net.intra
          - s02vl9904792.fr.net.intra
      - type: xlrelease.StringVariable
        key: pipeline
        showOnReleaseStart: false
        label: devops space pipeline name
        value: cd_create_couloir_xlr
      - type: xlrelease.StringVariable
        key: AAP-name-organizations
        requiresValue: false
        showOnReleaseStart: false
        label: AAP organization name
        value: CARDIF_GDA-OPS
      - type: xlrelease.StringVariable
        key: scm_url
        showOnReleaseStart: false
        label: TO offer git repository
        value: https://gitlab-dogen.group.echonet/Retail/cardif/moe_carat/e0511_carat/cd_create_couloir_xlr.git
      - type: xlrelease.StringVariable
        key: scm_branch
        showOnReleaseStart: false
        label: TO offer git repository branch
        value: carat_v6_build
      - type: xlrelease.StringVariable
        key: user
        label: UID
      - type: xlrelease.PasswordStringVariable
        key: password
        label: Password
      - type: xlrelease.StringVariable
        key: env
        showOnReleaseStart: false
        label: Ansible Environment
        description: set dynamically
      - type: xlrelease.StringVariable
        key: ext_env
        showOnReleaseStart: false
        label: Environment
        description: set dynamically
      - type: xlrelease.StringVariable
        key: ext_chainNum
        showOnReleaseStart: false
        label: Lane number
        description: Number of targeted lane
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "01"
            - "02"
            - "03"
            - "04"
            - "05"
            - "06"
            - "07"
            - "08"
            - "09"
      - type: xlrelease.ListStringVariable
        key: hosts
        showOnReleaseStart: false
        label: List of hosts
        description: Add target host
      - type: xlrelease.MapStringStringVariable
        key: extra_vars
        requiresValue: false
        showOnReleaseStart: false
        value:
          ext_appAction: "${ext_appAction}"
          ext_chainNum: "${ext_chainNum}"
          ext_projectID: "${ext_projectID}"
          env: "${env}"
          ext_envc: "${ext_envc}"
          ap_code: "${ap_code}"
          ext_envd: "${ext_envd}"
          nas_name: "${nas_name}"
          code5car: "${code5car}"
          ext_modlib: "${ext_modlib}"
          trigram: "${trigram}"
          ext_env: "${ext_env}"
          ext_repo_passwd: "${password}"
          ext_repo_user: "${user}"
          ext_appFullName: "${ext_appFullName}"
          hosts: "${hosts}"
          with_nas: "${with_nas}"
          ext_appOptArgs: "${ext_appOptArgs}"
          codeAP: "${codeAP}"
      - type: xlrelease.IntegerVariable
        key: index
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ext_appOptArgs
        requiresValue: false
        showOnReleaseStart: false
        value: force
      - type: xlrelease.StringVariable
        key: ext_appFullName
        showOnReleaseStart: false
        value: socle
      - type: xlrelease.StringVariable
        key: ext_envc
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ext_envd
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ext_modlib
        showOnReleaseStart: false
        value: carat
      - type: xlrelease.StringVariable
        key: ap_code
        requiresValue: false
        showOnReleaseStart: false
        value: "${codeAP}"
      - type: xlrelease.StringVariable
        key: nas_name
        value: NAS
      - type: xlrelease.StringVariable
        key: with_nas
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "yes"
            - "no"
        value: "yes"
      - type: xlrelease.StringVariable
        key: ext_appAction
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - create_couloir
            - delete_couloir
        value: create_couloir
    allowPasswordsInAllFields: true
    disableNotifications: true
    scriptUsername: runasuser
    variableMapping:
      scriptUserPassword: "${global.RunAsUserPassword}"
    riskProfile: Default risk profile
  - template: cd-Infolivre-AP23882-CARAT-CREATE-COULOIR EBX V6-OneEnv-A_tester
    scheduledStartDate: 2023-07-26T09:00:00+02:00
    dueDate: 2023-07-26T10:00:00+02:00
    phases:
      - phase: "${ext_env}"
        tasks:
          - name: üè≠ Set variables
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              ####get the environement variable : int / rec / pprod/ prod ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title[0:3]
              
              env = '${ext_env}'
              myenv = str(env)[0:3]
              if myenv == "ppd":
                  envc = "x"
              else:
              
              ##set envc variable from envir
                  envc = myenv[0]
              releaseVariables['ext_envc'] = envc
              envd = envc.upper()
              releaseVariables['ext_envd'] = envd
              
              ##set env variable from phase_name
              if str(myenv) == "int":
                  releaseVariables['ext_environnement'] = "Integration"
                  releaseVariables['env'] = "HORSPROD"
              if str(myenv) == "rec":
                  releaseVariables['ext_environnement'] = "Recette"
                  releaseVariables['env'] = "ISOPROD"
              if str(myenv) == "ppd":
                  releaseVariables['ext_environnement'] = "PreProduction"
                  releaseVariables['env'] = "PROD"
              if str(myenv) == "prd":
                  releaseVariables['ext_environnement'] = "Production"
                  releaseVariables['env'] = "PROD"
              
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              
              ## Set AAP Inventories
              if str(myenv) == "rec":
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(myenv).upper() + '${ext_chainNum}'
              else:
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(myenv).upper()
              
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(myenv) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(myenv) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = '' + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: üîé Get AAP Resources Ids task generator
            type: xlrelease.ScriptTask
            script: |-
              from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
              
              
              ## get id of sequential group to insert tasks into
              sequentialGroupId = None
              parenttask = getCurrentTask().container
              sequentialGroupId_list = []
              for child in parenttask.getChildren():
                  if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                      sequentialGroupId_list.append(child.id)
              sequentialGroupId = sequentialGroupId_list[0]
              
              ## get all release variables into list
              varList = releaseApi.getVariables(release.id)
              
              ##get variabble couloir to insert into user input task
              for obj in varList:
                  if "AAP-name" in obj.key:
                     resource = obj.value
                     var_name = obj.key
                     type = var_name.split('-')[-1]
                     var_resourceId = var_name.replace("name", "id")
                     if releaseVariables[var_resourceId] == "":
                        api_check = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                        taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                        taskCheckResource.pythonScript.setProperty("URL", api_check)
                        taskCheckResource.pythonScript.setProperty("method", 'GET')
                        taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                        taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                        taskCheckResource.pythonScript.setProperty("username", '${artifact_user}')
                        taskCheckResource.pythonScript.setProperty("password", '${artifact_passwd}')
                        taskCheckResource.setTaskFailureHandlerEnabled(True)
                        taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                        taskCheckResource.title = "Check " + str(type) + " " + str(resource)
                        taskApi.addTask(sequentialGroupId, taskCheckResource)
          - name: üöÄ GET AAP RESOURCES
            type: xlrelease.SequentialGroup
          - name: üöß Deploy task generator
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              releaseId = getCurrentRelease().id
              
              listFolder = releaseId.split('/')
              FolderId = listFolder[1]
              ServerName = "devopstc-ansibleAutomation-" + '${env}'
              #JobId= 7
              aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
              
              ##get modules to deploy
              sas_list=releaseVariables['modules_todeploy']
              
              
              ####get the environement variable : int / rec / pprod/ prod ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              
              ## get id of sequential group to insert tasks into
              sequentialGroupId = None
              parenttask = getCurrentTask().container
              sequentialGroupId_list = []
              for child in parenttask.getChildren():
                  if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                      sequentialGroupId_list.append( child.id)
              sequentialGroupId = sequentialGroupId_list[1]
              
              #Set AAP resources Ids
              varList = releaseApi.getVariables(release.id)
              
              for obj in varList:
                  if "AAP-id" in obj.key and "credentials" in obj.key:
                      credential_id = obj.value
                  if "AAP-id" in obj.key and "job_templates" in obj.key:
                      job_template_id = obj.value
                  if "AAP-id" in obj.key and "inventories" in obj.key:
                      inventory_id = obj.value
              
              
              ##creation de t?che ansible
              taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
              taskUpdateReleaseIds.title = 'Create Couloir to ' + phase_name
              extravarsName = "extra_vars"
              taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
              taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
              taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
              taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables[extravarsName])
              taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
              
              
              ##ajout de la task ansible sur le group sequential
              taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
          - name: üëâ sanitary check
            type: xlrelease.GateTask
            owner: "${owner_uid}"
            taskFailureHandlerEnabled: true
            taskRecoverOp: RESTART_PHASE
            conditions:
              - name: Version  deployed
                type: xlrelease.GateCondition
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
          - name: ‚ôª New Phase
            type: xlrelease.ScriptTask
            precondition: '"" == "yes"'
            script: |-
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import ReleaseApi
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = '' + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
              #task = getTasksByTitle(test, phaseTitle = int, releaseId = release.id)
              #phaseApi.newPhase(release.id, phase)
              releaseApi.restartPhase(release, True)
        color: "#3d6c9e"
    variables:
      - type: xlrelease.StringVariable
        key: ansible_organization
        requiresValue: false
        showOnReleaseStart: false
        value: CARDIF_GDA-OPS
      - type: xlrelease.StringVariable
        key: trigram
        requiresValue: false
        showOnReleaseStart: false
        value: rat
      - type: xlrelease.StringVariable
        key: code5car
        requiresValue: false
        showOnReleaseStart: false
        value: rat00
      - type: xlrelease.StringVariable
        key: ext_projectID
        requiresValue: false
        showOnReleaseStart: false
        value: "1212"
      - type: xlrelease.StringVariable
        key: ext_modlib
        requiresValue: false
        showOnReleaseStart: false
        value: carat
      - type: xlrelease.StringVariable
        key: pipeline
        requiresValue: false
        showOnReleaseStart: false
        value: cd_infolivre_xlr
      - type: xlrelease.StringVariable
        key: ext_appOptArgs
        requiresValue: false
        showOnReleaseStart: false
        value: force
      - type: xlrelease.StringVariable
        key: ext_envc
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ext_env
        label: Environment
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - int
            - ppd
            - prd
            - rec
      - type: xlrelease.StringVariable
        key: ext_chainNum
        label: couloir
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "1"
            - "2"
            - "3"
            - "4"
      - type: xlrelease.StringVariable
        key: artifact_user
        label: UID
      - type: xlrelease.PasswordStringVariable
        key: artifact_passwd
        label: Password
      - type: xlrelease.StringVariable
        key: ext_envd
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ansible_python_interpreter
        requiresValue: false
        showOnReleaseStart: false
        value: /usr/bin/python3
      - type: xlrelease.StringVariable
        key: ap_code
        requiresValue: false
        showOnReleaseStart: false
        value: AP23882
      - type: xlrelease.StringVariable
        key: owner_uid
        showOnReleaseStart: false
        label: Release Owner
        value: "${artifact_user}"
      - type: xlrelease.StringVariable
        key: ext_appFullName
        requiresValue: false
        showOnReleaseStart: false
        value: socle
      - type: xlrelease.StringVariable
        key: ext_appAction
        requiresValue: false
        showOnReleaseStart: false
        value: create_couloir
      - type: xlrelease.MapStringStringVariable
        key: extra_vars
        requiresValue: false
        showOnReleaseStart: false
        value:
          ext_appAction: "${ext_appAction}"
          ext_chainNum: "${ext_chainNum}"
          ext_projectID: "${ext_projectID}"
          env: "${env}"
          ext_envc: "${ext_envc}"
          ap_code: "${ap_code}"
          ext_envd: "${ext_envd}"
          ansible_python_interpreter: "${ansible_python_interpreter}"
          code5car: "${code5car}"
          ext_modlib: "${ext_modlib}"
          trigram: "${trigram}"
          ext_env: "${ext_env}"
          ext_appFullName: "${ext_appFullName}"
          ext_appOptArgs: "${ext_appOptArgs}"
          codeAP: "${codeAP}"
      - type: xlrelease.StringVariable
        key: AAP-name-organizations
        requiresValue: false
        showOnReleaseStart: false
        value: CARDIF_GDA-OPS
      - type: xlrelease.StringVariable
        key: ext_appName
        requiresValue: false
        showOnReleaseStart: false
        value: ASS_CRDF_ANSIBLE_INT
      - type: xlrelease.StringVariable
        key: env
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: codeAP
        requiresValue: false
        showOnReleaseStart: false
        value: "${ap_code}"
      - type: xlrelease.ListStringVariable
        key: modules_todeploy
        requiresValue: false
        showOnReleaseStart: false
        label: biz and/or prez
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - biz
        value:
          - biz
      - type: xlrelease.StringVariable
        key: scm_branch
        showOnReleaseStart: false
        label: branche git
        description: branche git
        value: del_index
      - type: xlrelease.StringVariable
        key: scm_url
        showOnReleaseStart: false
        label: url git
        value: https://gitlab-dogen.group.echonet/Retail/cardif/moe_carat/e0511_carat/cd_wlc_xlr.git
      - type: xlrelease.StringVariable
        key: deploy
        showOnReleaseStart: false
        label: deploiement
        description: type deploiement
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - socle
            - application
    allowPasswordsInAllFields: true
    scriptUsername: RunAsUser
    variableMapping:
      scriptUserPassword: "${global.RunAsUserPassword}"
    riskProfile: Default risk profile
  - template: cd-Infolivre-AP23882-CARAT-DEPLOY APPLICATION EBX V6
    scheduledStartDate: 2023-12-26T09:00:00+01:00
    dueDate: 2023-12-26T10:00:00+01:00
    phases:
      - phase: int
        tasks:
          - name: üëâ CHOOSE LANE
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - chainNum
          - name: üè≠ ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              # get phase name / environment
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              releaseVariables['ext_env'] = phase_name
              
              #set env variable from phase_name
              if str(phase_name) == "int":
                releaseVariables['hosts'] = releaseVariables['hosts_int']
                releaseVariables['env'] = "HORSPROD"
              if str(phase_name) == "rec":
                  rec_chainNum = '${chainNum}'
                  if map(int,str(rec_chainNum))[0] == 0:
                      chainNum = rec_chainNum[1]
                  else:
                      chainNum = rec_chainNum
                  host_var = "hosts_rec" + str(chainNum)
                  releaseVariables['hosts'] = releaseVariables[host_var]
                  releaseVariables['env'] = "ISOPROD"
              if str(phase_name) == "ppd":
                releaseVariables['hosts'] = releaseVariables['hosts_ppd']
                releaseVariables['env'] = "PROD"
              if str(phase_name) == "prd":
                releaseVariables['hosts'] = releaseVariables['hosts_prd']
                releaseVariables['env'] = "PROD"
              
              
              #Set if the version is release from url input
              if "SNAPSHOT" in '${binary_url}':
                  releaseVariables['isRelease'] = "false"
              else:
                  releaseVariables['isRelease'] = "true"
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              ## AAP Project
              project = "p-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}'
              var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
              var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
              releaseVariables[var_poject_name] = project
              releaseVariables[var_poject_id] = ""
              
              
              ## Set AAP Inventories
              if str(phase_name) == "rec":
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(phase_name).upper() + str(chainNum)
              else:
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(phase_name).upper()
              
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = str(phase_name) + " " + '${chainNum}'
              phaseApi.updatePhase(phase)
          - name: ‚ö° SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES ID's
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                              taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                              taskCheckResource.pythonScript.setProperty("method", 'GET')
                              taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskCheckResource.setTaskFailureHandlerEnabled(True)
                              taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskCheckResource.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskCheckResource)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Set Credential task generator
                    type: xlrelease.ScriptTask
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      if "Rollback" in str(phase_name):
                          playbook = 'deploy_rollback.yml'
                      else:
                          playbook = 'deploy_infolivre.yml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\"" + ", " + "\"" + "scm_update_on_launch" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_delete_on_update" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_clean" + "\"" + ": " + "\"" + "True" + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "update " + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  
                  
                  ##Create task
                  taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                  taskUpdateReleaseIds.title = 'deploy Draft Control-M' + " " + 'on ' + '${ext_env}' + '${chainNum}'
                  taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                  taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables['extra_vars'])
                  taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                  ##Add task in sequential group
                  taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöß DEPLOY GROUP
                type: xlrelease.SequentialGroup
          - name: ‚úã VALIDATION
            type: xlrelease.GateTask
        color: "#d61f21"
      - phase: rec
        tasks:
          - name: üëâ CHOOSE LANE
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - chainNum
          - name: üè≠ ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              # get phase name / environment
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              releaseVariables['ext_env'] = phase_name
              
              #set env variable from phase_name
              if str(phase_name) == "int":
                releaseVariables['hosts'] = releaseVariables['hosts_int']
                releaseVariables['env'] = "HORSPROD"
              if str(phase_name) == "rec":
                  rec_chainNum = '${chainNum}'
                  if map(int,str(rec_chainNum))[0] == 0:
                      chainNum = rec_chainNum[1]
                  else:
                      chainNum = rec_chainNum
                  host_var = "hosts_rec" + str(chainNum)
                  releaseVariables['hosts'] = releaseVariables[host_var]
                  releaseVariables['env'] = "ISOPROD"
              if str(phase_name) == "ppd":
                releaseVariables['hosts'] = releaseVariables['hosts_ppd']
                releaseVariables['env'] = "PROD"
              if str(phase_name) == "prd":
                releaseVariables['hosts'] = releaseVariables['hosts_prd']
                releaseVariables['env'] = "PROD"
              
              
              #Set if the version is release from url input
              if "SNAPSHOT" in '${binary_url}':
                  releaseVariables['isRelease'] = "false"
              else:
                  releaseVariables['isRelease'] = "true"
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              ## AAP Project
              project = "p-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}'
              var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
              var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
              releaseVariables[var_poject_name] = project
              releaseVariables[var_poject_id] = ""
              
              
              ## Set AAP Inventories
              if str(phase_name) == "rec":
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(phase_name).upper() + str(chainNum)
              else:
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(phase_name).upper()
              
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = str(phase_name) + " " + '${chainNum}'
              phaseApi.updatePhase(phase)
          - name: ‚ö° SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES ID's
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                              taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                              taskCheckResource.pythonScript.setProperty("method", 'GET')
                              taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskCheckResource.setTaskFailureHandlerEnabled(True)
                              taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskCheckResource.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskCheckResource)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Set Credential task generator
                    type: xlrelease.ScriptTask
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      if "Rollback" in str(phase_name):
                          playbook = 'deploy_rollback.yml'
                      else:
                          playbook = 'deploy_infolivre.yml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\"" + ", " + "\"" + "scm_update_on_launch" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_delete_on_update" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_clean" + "\"" + ": " + "\"" + "True" + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "update " + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  
                  
                  ##Create task
                  taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                  taskUpdateReleaseIds.title = 'deploy Draft Control-M' + " " + 'on ' + '${ext_env}' + '${chainNum}'
                  taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                  taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables['extra_vars'])
                  taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                  ##Add task in sequential group
                  taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöß DEPLOY GROUP
                type: xlrelease.SequentialGroup
          - name: ‚úã VALIDATION
            type: xlrelease.GateTask
        color: "#ff9e49"
      - phase: ppd
        tasks:
          - name: üëâ CHOOSE LANE
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - chainNum
          - name: üè≠ ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              # get phase name / environment
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              releaseVariables['ext_env'] = phase_name
              
              #set env variable from phase_name
              if str(phase_name) == "int":
                releaseVariables['hosts'] = releaseVariables['hosts_int']
                releaseVariables['env'] = "HORSPROD"
              if str(phase_name) == "rec":
                  rec_chainNum = '${chainNum}'
                  if map(int,str(rec_chainNum))[0] == 0:
                      chainNum = rec_chainNum[1]
                  else:
                      chainNum = rec_chainNum
                  host_var = "hosts_rec" + str(chainNum)
                  releaseVariables['hosts'] = releaseVariables[host_var]
                  releaseVariables['env'] = "ISOPROD"
              if str(phase_name) == "ppd":
                releaseVariables['hosts'] = releaseVariables['hosts_ppd']
                releaseVariables['env'] = "PROD"
              if str(phase_name) == "prd":
                releaseVariables['hosts'] = releaseVariables['hosts_prd']
                releaseVariables['env'] = "PROD"
              
              
              #Set if the version is release from url input
              if "SNAPSHOT" in '${binary_url}':
                  releaseVariables['isRelease'] = "false"
              else:
                  releaseVariables['isRelease'] = "true"
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              ## AAP Project
              project = "p-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}'
              var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
              var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
              releaseVariables[var_poject_name] = project
              releaseVariables[var_poject_id] = ""
              
              
              ## Set AAP Inventories
              if str(phase_name) == "rec":
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(phase_name).upper() + str(chainNum)
              else:
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(phase_name).upper()
              
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = str(phase_name) + " " + '${chainNum}'
              phaseApi.updatePhase(phase)
          - name: ‚ö° SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES ID's
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                              taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                              taskCheckResource.pythonScript.setProperty("method", 'GET')
                              taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskCheckResource.setTaskFailureHandlerEnabled(True)
                              taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskCheckResource.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskCheckResource)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Set Credential task generator
                    type: xlrelease.ScriptTask
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      if "Rollback" in str(phase_name):
                          playbook = 'deploy_rollback.yml'
                      else:
                          playbook = 'deploy_infolivre.yml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\"" + ", " + "\"" + "scm_update_on_launch" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_delete_on_update" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_clean" + "\"" + ": " + "\"" + "True" + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "update " + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  
                  
                  ##Create task
                  taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                  taskUpdateReleaseIds.title = 'deploy Draft Control-M' + " " + 'on ' + '${ext_env}' + '${chainNum}'
                  taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                  taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables['extra_vars'])
                  taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                  ##Add task in sequential group
                  taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöß DEPLOY GROUP
                type: xlrelease.SequentialGroup
          - name: ‚úã VALIDATION
            type: xlrelease.GateTask
        color: "#3d6c9e"
      - phase: prd
        tasks:
          - name: üëâ CHOOSE LANE
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - chainNum
          - name: üè≠ ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              # get phase name / environment
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              releaseVariables['ext_env'] = phase_name
              
              #set env variable from phase_name
              if str(phase_name) == "int":
                releaseVariables['hosts'] = releaseVariables['hosts_int']
                releaseVariables['env'] = "HORSPROD"
              if str(phase_name) == "rec":
                  rec_chainNum = '${chainNum}'
                  if map(int,str(rec_chainNum))[0] == 0:
                      chainNum = rec_chainNum[1]
                  else:
                      chainNum = rec_chainNum
                  host_var = "hosts_rec" + str(chainNum)
                  releaseVariables['hosts'] = releaseVariables[host_var]
                  releaseVariables['env'] = "ISOPROD"
              if str(phase_name) == "ppd":
                releaseVariables['hosts'] = releaseVariables['hosts_ppd']
                releaseVariables['env'] = "PROD"
              if str(phase_name) == "prd":
                releaseVariables['hosts'] = releaseVariables['hosts_prd']
                releaseVariables['env'] = "PROD"
              
              
              #Set if the version is release from url input
              if "SNAPSHOT" in '${binary_url}':
                  releaseVariables['isRelease'] = "false"
              else:
                  releaseVariables['isRelease'] = "true"
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              ## AAP Project
              project = "p-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}'
              var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
              var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
              releaseVariables[var_poject_name] = project
              releaseVariables[var_poject_id] = ""
              
              
              ## Set AAP Inventories
              if str(phase_name) == "rec":
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(phase_name).upper() + str(chainNum)
              else:
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(phase_name).upper()
              
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = str(phase_name) + " " + '${chainNum}'
              phaseApi.updatePhase(phase)
          - name: ‚ö° SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES ID's
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                              taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                              taskCheckResource.pythonScript.setProperty("method", 'GET')
                              taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskCheckResource.setTaskFailureHandlerEnabled(True)
                              taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskCheckResource.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskCheckResource)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Set Credential task generator
                    type: xlrelease.ScriptTask
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      if "Rollback" in str(phase_name):
                          playbook = 'deploy_rollback.yml'
                      else:
                          playbook = 'deploy_infolivre.yml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\"" + ", " + "\"" + "scm_update_on_launch" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_delete_on_update" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_clean" + "\"" + ": " + "\"" + "True" + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "update " + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  
                  
                  ##Create task
                  taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                  taskUpdateReleaseIds.title = 'deploy Draft Control-M' + " " + 'on ' + '${ext_env}' + '${chainNum}'
                  taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                  taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables['extra_vars'])
                  taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                  ##Add task in sequential group
                  taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöß DEPLOY GROUP
                type: xlrelease.SequentialGroup
        color: "#498500"
    variables:
      - type: xlrelease.StringVariable
        key: codeAP
        showOnReleaseStart: false
        label: AP Code of the application
        description: set once
        value: "23882"
      - type: xlrelease.StringVariable
        key: projectID
        showOnReleaseStart: false
        label: Project ID of the devops space
        description: set once
        value: "1212"
      - type: xlrelease.StringVariable
        key: trigram
        showOnReleaseStart: false
        label: Trigram of the application
        description: set once
        value: rat
      - type: xlrelease.StringVariable
        key: code5car
        showOnReleaseStart: false
        label: Pentagram of the application
        description: set once
        value: rat00
      - type: xlrelease.ListStringVariable
        key: appName
        label: Application module
        value:
          - DIFFUSION
          - INTEGRATION
      - type: xlrelease.ListStringVariable
        key: hosts_int
        showOnReleaseStart: false
        label: List of hosts for int environment
        value:
          - s02vl9904804.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_rec1
        showOnReleaseStart: false
        label: Lists of hosts for rec1 environnement
        value:
          - s02vl9904789.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_rec2
        showOnReleaseStart: false
        label: Lists of hosts for rec2 environnement
        value:
          - s02vl9904790.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_ppd
        requiresValue: false
        showOnReleaseStart: false
        label: List of hosts for ppd environment
        value:
          - s02vl9904787.fr.net.intra
          - s02vl9904788.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_prd
        requiresValue: false
        showOnReleaseStart: false
        label: List of hosts for prd environment
        value:
          - s02vl9904791.fr.net.intra
          - s02vl9904792.fr.net.intra
      - type: xlrelease.StringVariable
        key: pipeline
        showOnReleaseStart: false
        label: devops space pipeline name
        value: cd_infolivre_xlr
      - type: xlrelease.StringVariable
        key: AAP-name-organizations
        requiresValue: false
        showOnReleaseStart: false
        label: AAP organization name
        value: CARDIF_GDA-OPS
      - type: xlrelease.StringVariable
        key: scm_url
        showOnReleaseStart: false
        label: TO offer git repository
        value: https://gitlab-dogen.group.echonet/gf/itg_itgp/dass/toolchain_cardif_xlr/infolivre.git
      - type: xlrelease.StringVariable
        key: scm_branch
        showOnReleaseStart: false
        label: TO offer git repository branch
        value: v3.3
      - type: xlrelease.StringVariable
        key: user
        label: UID
      - type: xlrelease.PasswordStringVariable
        key: password
        label: Password
      - type: xlrelease.StringVariable
        key: env
        showOnReleaseStart: false
        label: Ansible Environment
        description: set dynamically
      - type: xlrelease.StringVariable
        key: ext_env
        showOnReleaseStart: false
        label: Environment
        description: set dynamically
      - type: xlrelease.StringVariable
        key: binary_url
        label: Zip Url in Artifactory
      - type: xlrelease.StringVariable
        key: chainNum
        showOnReleaseStart: false
        label: Lane number
        description: Number of targeted lane
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "01"
            - "02"
            - "03"
            - "04"
            - "05"
            - "06"
            - "07"
            - "08"
            - "09"
      - type: xlrelease.StringVariable
        key: isRelease
        showOnReleaseStart: false
        label: Is the version you are deploying a Release?
        description: set dynamically
      - type: xlrelease.BooleanVariable
        key: rollback
        showOnReleaseStart: false
        label: Check if you want to perform a rollback
        description: Variable to execute rollback
      - type: xlrelease.BooleanVariable
        key: replace_and_delete
        label: Do you want to perform a full delivery (replace and delete)
        description: Check this parameter if you want to make a full delivery
      - type: xlrelease.StringVariable
        key: appVersion
        label: Application Version
        description: Application Version
      - type: xlrelease.ListStringVariable
        key: hosts
        showOnReleaseStart: false
        label: List of hosts
        description: Add target host
      - type: xlrelease.ListStringVariable
        key: hosts_dev
        showOnReleaseStart: false
        label: Lists of hosts for dev environment
      - type: xlrelease.BooleanVariable
        key: etl
        showOnReleaseStart: false
        label: Check if ETL
        description: Check if the application is part of ETL
      - type: xlrelease.StringVariable
        key: ext_appRep
        requiresValue: false
        showOnReleaseStart: false
        label: application folder (only if etl)
      - type: xlrelease.StringVariable
        key: ap_code
        requiresValue: false
        showOnReleaseStart: false
        label: code AP
        value: "AP${codeAP}"
      - type: xlrelease.MapStringStringVariable
        key: extra_vars
        requiresValue: false
        showOnReleaseStart: false
        value:
          isRelease: "${isRelease}"
          replace_and_delete: "${replace_and_delete}"
          appVersion: "${appVersion}"
          env: "${env}"
          etl: "${etl}"
          ap_code: "${ap_code}"
          projectID: "${projectID}"
          code5car: "${code5car}"
          rollback: "${rollback}"
          binary_url: "${binary_url}"
          ext_appRep: "${ext_appRep}"
          trigram: "${trigram}"
          ext_env: "${ext_env}"
          apCode: "${codeAP}"
          ext_nom_tns: '""'
          appName: "${appName}"
          chainNum: "${chainNum}"
          hosts: "${hosts}"
      - type: xlrelease.IntegerVariable
        key: index
        requiresValue: false
        showOnReleaseStart: false
    allowPasswordsInAllFields: true
    scriptUsername: runasuser
    variableMapping:
      scriptUserPassword: "${global.RunAsUserPassword}"
    riskProfile: Default risk profile
  - template: cd-Infolivre-AP23882-CARAT-DEPLOY APPLICATION EBX V6 (test inventaires)
    scheduledStartDate: 2023-12-26T09:00:00+01:00
    dueDate: 2023-12-26T10:00:00+01:00
    phases:
      - phase: int
        tasks:
          - name: üëâ CHOOSE LANE
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - chainNum
          - name: üè≠ ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              # get phase name / environment
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              releaseVariables['ext_env'] = phase_name
              
              #set env variable from phase_name
              if str(phase_name) == "int":
                releaseVariables['hosts'] = releaseVariables['hosts_int']
                env = "HORSPROD"
              if str(phase_name) == "rec":
                  rec_chainNum = '${chainNum}'
                  if map(int,str(rec_chainNum))[0] == 0:
                      chainNum = rec_chainNum[1]
                  else:
                      chainNum = rec_chainNum
                  host_rec = "hosts_rec" + str(chainNum)
                  releaseVariables['hosts'] = releaseVariables[host_rec]
                  env = "ISOPROD"
              if str(phase_name) == "ppd":
                releaseVariables['hosts'] = releaseVariables['hosts_ppd']
                env = "PROD"
              if str(phase_name) == "prd":
                releaseVariables['hosts'] = releaseVariables['hosts_prd']
                env = "PROD"
              
              releaseVariables['env'] = str(env)
              
              #Set if the version is release from url input
              if "SNAPSHOT" in '${binary_url}':
                  releaseVariables['isRelease'] = "false"
              else:
                  releaseVariables['isRelease'] = "true"
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              ## AAP Project
              project = "p-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}'
              var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
              var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
              releaseVariables[var_poject_name] = project
              releaseVariables[var_poject_id] = ""
              
              
              ## Set AAP Inventories
              inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(env)
              
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = str(phase_name) + " " + '${chainNum}'
              phaseApi.updatePhase(phase)
          - name: ‚ö° SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES ID's
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                              taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                              taskCheckResource.pythonScript.setProperty("method", 'GET')
                              taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskCheckResource.setTaskFailureHandlerEnabled(True)
                              taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskCheckResource.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskCheckResource)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Set Credential task generator
                    type: xlrelease.ScriptTask
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      if "Rollback" in str(phase_name):
                          playbook = 'deploy_rollback.yml'
                      else:
                          playbook = 'deploy_infolivre.yml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\"" + ", " + "\"" + "scm_update_on_launch" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_delete_on_update" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_clean" + "\"" + ": " + "\"" + "True" + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "update " + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  
                  
                  ##Create task
                  taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                  taskUpdateReleaseIds.title = 'deploy Draft Control-M' + " " + 'on ' + '${ext_env}' + '${chainNum}'
                  taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                  taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables['extra_vars'])
                  taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                  ##Add task in sequential group
                  taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöß DEPLOY GROUP
                type: xlrelease.SequentialGroup
          - name: ‚úã VALIDATION
            type: xlrelease.GateTask
        color: "#d61f21"
      - phase: rec
        tasks:
          - name: üëâ CHOOSE LANE
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - chainNum
          - name: üè≠ ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              # get phase name / environment
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              releaseVariables['ext_env'] = phase_name
              
              #set env variable from phase_name
              if str(phase_name) == "int":
                releaseVariables['hosts'] = releaseVariables['hosts_int']
                releaseVariables['env'] = "HORSPROD"
              if str(phase_name) == "rec":
                  rec_chainNum = '${chainNum}'
                  if map(int,str(rec_chainNum))[0] == 0:
                      chainNum = rec_chainNum[1]
                  else:
                      chainNum = rec_chainNum
                  host_var = "hosts_rec" + str(chainNum)
                  releaseVariables['hosts'] = releaseVariables[host_var]
                  releaseVariables['env'] = "ISOPROD"
              if str(phase_name) == "ppd":
                releaseVariables['hosts'] = releaseVariables['hosts_ppd']
                releaseVariables['env'] = "PROD"
              if str(phase_name) == "prd":
                releaseVariables['hosts'] = releaseVariables['hosts_prd']
                releaseVariables['env'] = "PROD"
              
              
              #Set if the version is release from url input
              if "SNAPSHOT" in '${binary_url}':
                  releaseVariables['isRelease'] = "false"
              else:
                  releaseVariables['isRelease'] = "true"
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              ## AAP Project
              project = "p-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}'
              var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
              var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
              releaseVariables[var_poject_name] = project
              releaseVariables[var_poject_id] = ""
              
              
              ## Set AAP Inventories
              if str(phase_name) == "rec":
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(phase_name).upper() + str(chainNum)
              else:
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(phase_name).upper()
              
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = str(phase_name) + " " + '${chainNum}'
              phaseApi.updatePhase(phase)
          - name: ‚ö° SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES ID's
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                              taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                              taskCheckResource.pythonScript.setProperty("method", 'GET')
                              taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskCheckResource.setTaskFailureHandlerEnabled(True)
                              taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskCheckResource.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskCheckResource)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Set Credential task generator
                    type: xlrelease.ScriptTask
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      if "Rollback" in str(phase_name):
                          playbook = 'deploy_rollback.yml'
                      else:
                          playbook = 'deploy_infolivre.yml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\"" + ", " + "\"" + "scm_update_on_launch" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_delete_on_update" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_clean" + "\"" + ": " + "\"" + "True" + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "update " + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  
                  
                  ##Create task
                  taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                  taskUpdateReleaseIds.title = 'deploy Draft Control-M' + " " + 'on ' + '${ext_env}' + '${chainNum}'
                  taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                  taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables['extra_vars'])
                  taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                  ##Add task in sequential group
                  taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöß DEPLOY GROUP
                type: xlrelease.SequentialGroup
          - name: ‚úã VALIDATION
            type: xlrelease.GateTask
        color: "#ff9e49"
      - phase: ppd
        tasks:
          - name: üëâ CHOOSE LANE
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - chainNum
          - name: üè≠ ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              # get phase name / environment
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              releaseVariables['ext_env'] = phase_name
              
              #set env variable from phase_name
              if str(phase_name) == "int":
                releaseVariables['hosts'] = releaseVariables['hosts_int']
                releaseVariables['env'] = "HORSPROD"
              if str(phase_name) == "rec":
                  rec_chainNum = '${chainNum}'
                  if map(int,str(rec_chainNum))[0] == 0:
                      chainNum = rec_chainNum[1]
                  else:
                      chainNum = rec_chainNum
                  host_var = "hosts_rec" + str(chainNum)
                  releaseVariables['hosts'] = releaseVariables[host_var]
                  releaseVariables['env'] = "ISOPROD"
              if str(phase_name) == "ppd":
                releaseVariables['hosts'] = releaseVariables['hosts_ppd']
                releaseVariables['env'] = "PROD"
              if str(phase_name) == "prd":
                releaseVariables['hosts'] = releaseVariables['hosts_prd']
                releaseVariables['env'] = "PROD"
              
              
              #Set if the version is release from url input
              if "SNAPSHOT" in '${binary_url}':
                  releaseVariables['isRelease'] = "false"
              else:
                  releaseVariables['isRelease'] = "true"
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              ## AAP Project
              project = "p-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}'
              var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
              var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
              releaseVariables[var_poject_name] = project
              releaseVariables[var_poject_id] = ""
              
              
              ## Set AAP Inventories
              if str(phase_name) == "rec":
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(phase_name).upper() + str(chainNum)
              else:
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(phase_name).upper()
              
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = str(phase_name) + " " + '${chainNum}'
              phaseApi.updatePhase(phase)
          - name: ‚ö° SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES ID's
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                              taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                              taskCheckResource.pythonScript.setProperty("method", 'GET')
                              taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskCheckResource.setTaskFailureHandlerEnabled(True)
                              taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskCheckResource.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskCheckResource)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Set Credential task generator
                    type: xlrelease.ScriptTask
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      if "Rollback" in str(phase_name):
                          playbook = 'deploy_rollback.yml'
                      else:
                          playbook = 'deploy_infolivre.yml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\"" + ", " + "\"" + "scm_update_on_launch" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_delete_on_update" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_clean" + "\"" + ": " + "\"" + "True" + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "update " + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  
                  
                  ##Create task
                  taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                  taskUpdateReleaseIds.title = 'deploy Draft Control-M' + " " + 'on ' + '${ext_env}' + '${chainNum}'
                  taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                  taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables['extra_vars'])
                  taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                  ##Add task in sequential group
                  taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöß DEPLOY GROUP
                type: xlrelease.SequentialGroup
          - name: ‚úã VALIDATION
            type: xlrelease.GateTask
        color: "#3d6c9e"
      - phase: prd
        tasks:
          - name: üëâ CHOOSE LANE
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - chainNum
          - name: üè≠ ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              # get phase name / environment
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              releaseVariables['ext_env'] = phase_name
              
              #set env variable from phase_name
              if str(phase_name) == "int":
                releaseVariables['hosts'] = releaseVariables['hosts_int']
                releaseVariables['env'] = "HORSPROD"
              if str(phase_name) == "rec":
                  rec_chainNum = '${chainNum}'
                  if map(int,str(rec_chainNum))[0] == 0:
                      chainNum = rec_chainNum[1]
                  else:
                      chainNum = rec_chainNum
                  host_var = "hosts_rec" + str(chainNum)
                  releaseVariables['hosts'] = releaseVariables[host_var]
                  releaseVariables['env'] = "ISOPROD"
              if str(phase_name) == "ppd":
                releaseVariables['hosts'] = releaseVariables['hosts_ppd']
                releaseVariables['env'] = "PROD"
              if str(phase_name) == "prd":
                releaseVariables['hosts'] = releaseVariables['hosts_prd']
                releaseVariables['env'] = "PROD"
              
              
              #Set if the version is release from url input
              if "SNAPSHOT" in '${binary_url}':
                  releaseVariables['isRelease'] = "false"
              else:
                  releaseVariables['isRelease'] = "true"
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              ## AAP Project
              project = "p-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}'
              var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
              var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
              releaseVariables[var_poject_name] = project
              releaseVariables[var_poject_id] = ""
              
              
              ## Set AAP Inventories
              if str(phase_name) == "rec":
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(phase_name).upper() + str(chainNum)
              else:
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(phase_name).upper()
              
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = str(phase_name) + " " + '${chainNum}'
              phaseApi.updatePhase(phase)
          - name: ‚ö° SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES ID's
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                              taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                              taskCheckResource.pythonScript.setProperty("method", 'GET')
                              taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskCheckResource.setTaskFailureHandlerEnabled(True)
                              taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskCheckResource.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskCheckResource)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Set Credential task generator
                    type: xlrelease.ScriptTask
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      if "Rollback" in str(phase_name):
                          playbook = 'deploy_rollback.yml'
                      else:
                          playbook = 'deploy_infolivre.yml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\"" + ", " + "\"" + "scm_update_on_launch" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_delete_on_update" + "\"" + ": " + "\"" + "True" + "\"" + ", " + "\"" + "scm_clean" + "\"" + ": " + "\"" + "True" + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "update " + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  
                  
                  ##Create task
                  taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                  taskUpdateReleaseIds.title = 'deploy Draft Control-M' + " " + 'on ' + '${ext_env}' + '${chainNum}'
                  taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                  taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                  taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables['extra_vars'])
                  taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                  ##Add task in sequential group
                  taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöß DEPLOY GROUP
                type: xlrelease.SequentialGroup
        color: "#498500"
    variables:
      - type: xlrelease.StringVariable
        key: codeAP
        showOnReleaseStart: false
        label: AP Code of the application
        description: set once
        value: "23882"
      - type: xlrelease.StringVariable
        key: projectID
        showOnReleaseStart: false
        label: Project ID of the devops space
        description: set once
        value: "1212"
      - type: xlrelease.StringVariable
        key: trigram
        showOnReleaseStart: false
        label: Trigram of the application
        description: set once
        value: rat
      - type: xlrelease.StringVariable
        key: code5car
        showOnReleaseStart: false
        label: Pentagram of the application
        description: set once
        value: rat00
      - type: xlrelease.ListStringVariable
        key: appName
        label: Application module
        value:
          - DIFFUSION
      - type: xlrelease.ListStringVariable
        key: hosts_int
        showOnReleaseStart: false
        label: List of hosts for int environment
        value:
          - s02vl9904804.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_rec1
        showOnReleaseStart: false
        label: Lists of hosts for rec1 environnement
        value:
          - s02vl9904789.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_rec2
        showOnReleaseStart: false
        label: Lists of hosts for rec2 environnement
        value:
          - s02vl9904790.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_ppd
        requiresValue: false
        showOnReleaseStart: false
        label: List of hosts for ppd environment
        value:
          - s02vl9904787.fr.net.intra
          - s02vl9904788.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_prd
        requiresValue: false
        showOnReleaseStart: false
        label: List of hosts for prd environment
        value:
          - s02vl9904791.fr.net.intra
          - s02vl9904792.fr.net.intra
      - type: xlrelease.StringVariable
        key: pipeline
        showOnReleaseStart: false
        label: devops space pipeline name
        value: infolivre_xlr
      - type: xlrelease.StringVariable
        key: AAP-name-organizations
        requiresValue: false
        showOnReleaseStart: false
        label: AAP organization name
        value: CARDIF_GDA-OPS
      - type: xlrelease.StringVariable
        key: scm_url
        showOnReleaseStart: false
        label: TO offer git repository
        value: https://gitlab-dogen.group.echonet/gf/itg_itgp/dass/toolchain_cardif_xlr/infolivre.git
      - type: xlrelease.StringVariable
        key: scm_branch
        showOnReleaseStart: false
        label: TO offer git repository branch
        value: v3.3
      - type: xlrelease.StringVariable
        key: user
        label: UID
      - type: xlrelease.PasswordStringVariable
        key: password
        label: Password
      - type: xlrelease.StringVariable
        key: env
        showOnReleaseStart: false
        label: Ansible Environment
        description: set dynamically
      - type: xlrelease.StringVariable
        key: ext_env
        showOnReleaseStart: false
        label: Environment
        description: set dynamically
      - type: xlrelease.StringVariable
        key: binary_url
        label: Zip Url in Artifactory
      - type: xlrelease.StringVariable
        key: chainNum
        showOnReleaseStart: false
        label: Lane number
        description: Number of targeted lane
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "01"
            - "02"
            - "03"
            - "04"
            - "05"
            - "06"
            - "07"
            - "08"
            - "09"
      - type: xlrelease.StringVariable
        key: isRelease
        showOnReleaseStart: false
        label: Is the version you are deploying a Release?
        description: set dynamically
      - type: xlrelease.BooleanVariable
        key: rollback
        showOnReleaseStart: false
        label: Check if you want to perform a rollback
        description: Variable to execute rollback
      - type: xlrelease.BooleanVariable
        key: replace_and_delete
        label: Do you want to perform a full delivery (replace and delete)
        description: Check this parameter if you want to make a full delivery
      - type: xlrelease.StringVariable
        key: appVersion
        label: Application Version
        description: Application Version
      - type: xlrelease.ListStringVariable
        key: hosts
        showOnReleaseStart: false
        label: List of hosts
        description: Add target host
      - type: xlrelease.ListStringVariable
        key: hosts_dev
        showOnReleaseStart: false
        label: Lists of hosts for dev environment
      - type: xlrelease.BooleanVariable
        key: etl
        showOnReleaseStart: false
        label: Check if ETL
        description: Check if the application is part of ETL
      - type: xlrelease.StringVariable
        key: ext_appRep
        requiresValue: false
        showOnReleaseStart: false
        label: application folder (only if etl)
      - type: xlrelease.StringVariable
        key: ap_code
        requiresValue: false
        showOnReleaseStart: false
        label: code AP
        value: "AP${codeAP}"
      - type: xlrelease.MapStringStringVariable
        key: extra_vars
        requiresValue: false
        showOnReleaseStart: false
        value:
          isRelease: "${isRelease}"
          replace_and_delete: "${replace_and_delete}"
          appVersion: "${appVersion}"
          env: "${env}"
          etl: "${etl}"
          ap_code: "${ap_code}"
          projectID: "${projectID}"
          code5car: "${code5car}"
          rollback: "${rollback}"
          binary_url: "${binary_url}"
          ext_appRep: "${ext_appRep}"
          trigram: "${trigram}"
          ext_env: "${ext_env}"
          apCode: "${codeAP}"
          ext_nom_tns: '""'
          appName: "${appName}"
          chainNum: "${chainNum}"
          hosts: "${hosts}"
      - type: xlrelease.IntegerVariable
        key: index
        requiresValue: false
        showOnReleaseStart: false
    allowPasswordsInAllFields: true
    scriptUsername: runasuser
    variableMapping:
      scriptUserPassword: "${global.RunAsUserPassword}"
    riskProfile: Default risk profile
  - template: cd-Infolivre-AP23882-CARAT-DEPLOY APPLICATION EBX V6 - Mi-Brouillon (pas
      test√©)
    scheduledStartDate: 2023-07-26T09:00:00+02:00
    dueDate: 2023-07-26T10:00:00+02:00
    phases:
      - phase: "${ext_env}"
        tasks:
          - name: üëâ SET COULOIR
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - ext_chainNum
          - name: üè≠ SET ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              ####get the environement variable : int / rec / pprod/ prod ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              
              
              myenv = '${ext_env}'
              if myenv == "ppd":
                  envc = "x"
              else:
              
              ##set envc variable from envir
                  envc = myenv[0]
              releaseVariables['ext_envc'] = envc
              
              ##set env variable from phase_name
              if str(myenv) == "int":
                  releaseVariables['env'] = "HORSPROD"
              if str(myenv) == "rec":
                  releaseVariables['env'] = "ISOPROD"
              if str(myenv) == "ppd" or str(myenv) == "prd":
                  releaseVariables['env'] = "PROD"
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              ## AAP Project
              project = "p-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}'
              var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
              var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
              releaseVariables[var_poject_name] = project
              releaseVariables[var_poject_id] = ""
              
              print str(myenv)
              ## Set AAP Inventories
              if str(myenv) == "rec":
                  rec_chainNum = '${ext_chainNum}'
                  if map(int,str(rec_chainNum))[0] == 0:
                      ext_chainNum = rec_chainNum[1]
                  else:
                      ext_chainNum = rec_chainNum
              
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(myenv).upper() + str(ext_chainNum)
              else:
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(myenv).upper()
              
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(myenv) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(myenv) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = str(phase_name) + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: ‚ö° SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES IDs
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                              taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                              taskCheckResource.pythonScript.setProperty("method", 'GET')
                              taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskCheckResource.setTaskFailureHandlerEnabled(True)
                              taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskCheckResource.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskCheckResource)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Set Credential task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + "organizations":
                              organization_id = obj.value
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                              resource_id = obj.value
                              var_name = obj.key
                              resource_type = var_name.split('-')[-1]
                          if obj.key == "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                              resource_name = obj.value
                              credential_type = '24'
                      body = "\"" + "name" + "\"" + ": " + "\"" + str(resource_name) + "\"" + ", " + "\"" + "organization" + "\"" + ": " + str(organization_id) + ", " + "\"" + "credential_type" + "\"" + ": " + str(credential_type) + ", " + "\"" + "inputs" + "\"" + ": { " + "\"" + "artifact_user" + "\"" + ": " + "\"" + "$" + "{" + "user" + "}" + "\"" + ", " + "\"" + "artifact_password" + "\"" + ": " + "\"" + "$" + "{" + "password" + "}" + "\"" + "}"
                      
                      
                      api_put_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                      taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                      taskUpdateResource.pythonScript.setProperty("URL", api_put_url)
                      taskUpdateResource.pythonScript.setProperty("method", 'PUT')
                      taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                      taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                      taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                      taskUpdateResource.title = "Set credential " + " " + str(resource_name)
                      taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      if "Rollback" in str(phase_name):
                          playbook = 'deploy_rollback.yaml'
                      else:
                          playbook = 'deploy_infolivre.yaml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "update " + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
                  from com.xebialabs.xlrelease.api.v1.forms import Variable
                  from com.xebialabs.xlrelease.api.v1 import PhaseApi
                  
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  ##get modules to deploy
                  sas_list=releaseVariables['modules_todeploy']
                  
                  
                  ####get the environement variable : int / rec / pprod/ prod ###
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  myenv = '${ext_env}'
                  my_env = myenv[0:3]
                  
                   ## set isRelease variable dynamically
                  if "SNAPSHOT" in '${release_version}':
                      releaseVariables['ext_isRelease'] = "false"
                      releaseVariables['version'] = "SNAPSHOT"
                  else:
                      releaseVariables['ext_isRelease'] = "true"
                      releaseVariables['version'] = "RELEASE"
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  for component in sas_list:
                      ## Set infolivre variables
                        app = str(component).lower()
                        artifact_path = '${artifact_path}' + str(app)
                        releaseVariables['artifactPath'] = artifact_path
                        appName = '${modlib}' + "_" + str(component) + "_" + "DEPLOY"
                        releaseVariables['ext_appName'] = appName
                  
                      ##creation de tache ansible
                        taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                        taskUpdateReleaseIds.title = 'deploy ' + str(component) + " " + '${release_version}'
                        extravarsName = "extra_vars"
                        taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                        taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                        taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                        taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables[extravarsName])
                        taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                      ##ajout de la task ansible sur le group sequential
                        taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöÄ DEPLOY GROUP
                type: xlrelease.SequentialGroup
          - name: Validation
            type: xlrelease.GateTask
          - name: üîé Get AAP Resources Ids task generator
            type: xlrelease.ScriptTask
            script: |-
              from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
              
              
              ## get id of sequential group to insert tasks into
              sequentialGroupId = None
              parenttask = getCurrentTask().container
              sequentialGroupId_list = []
              for child in parenttask.getChildren():
                  if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                      sequentialGroupId_list.append( child.id)
              sequentialGroupId = sequentialGroupId_list[0]
              
              ## get all release variables into list
              varList = releaseApi.getVariables(release.id)
              
              ##get variabble couloir to insert into user input task
              for obj in varList:
                  if "AAP-name" in obj.key:
                     resource = obj.value
                     var_name = obj.key
                     type = var_name.split('-')[-1]
                     var_resourceId = var_name.replace("name", "id")
                     api_check = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                     taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                     taskCheckResource.pythonScript.setProperty("URL", api_check)
                     taskCheckResource.pythonScript.setProperty("method", 'GET')
                     taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                     taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                     taskCheckResource.pythonScript.setProperty("username", '${user}')
                     taskCheckResource.pythonScript.setProperty("password", '${password}')
                     taskCheckResource.setTaskFailureHandlerEnabled(True)
                     taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                     taskCheckResource.title = "Check " + str(type) + " " + str(resource)
                     taskApi.addTask(sequentialGroupId, taskCheckResource)
          - name: üöÄ GET AAP RESOURCES
            type: xlrelease.SequentialGroup
          - name: üöß Deploy task generator
            type: xlrelease.ScriptTask
            script: |-
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              releaseId = getCurrentRelease().id
              
              ## Set AAP Server env
              listFolder = releaseId.split('/')
              FolderId = listFolder[1]
              ServerName = "devopstc-ansibleAutomation-" + '${env}'
              aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
              
              ##get modules to deploy
              sas_list=releaseVariables['modules_todeploy']
              
              
              ####get the environement variable : int / rec / pprod/ prod ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              
              myenv = '${ext_env}'
              my_env = myenv[0:3]
              
               ## set isRelease variable dynamically
              if "SNAPSHOT" in '${release_version}':
                  releaseVariables['ext_isRelease'] = "false"
                  releaseVariables['version'] = "SNAPSHOT"
              else:
                  releaseVariables['ext_isRelease'] = "true"
                  releaseVariables['version'] = "RELEASE"
              
              ## get id of sequential group to insert tasks into
              sequentialGroupId = None
              parenttask = getCurrentTask().container
              for child in parenttask.getChildren():
                  if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                      sequentialGroupId = child.id
                  if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                      taskApi.delete(child.id)
              
              #Set AAP resources Ids
              varList = releaseApi.getVariables(release.id)
              
              for obj in varList:
                  if "AAP-id" in obj.key and "credentials" in obj.key:
                      credential_id = obj.value
                  if "AAP-id" in obj.key and "job_templates" in obj.key:
                      job_template_id = obj.value
                  if "AAP-id" in obj.key and "inventories" in obj.key:
                      inventory_id = obj.value
              
              for component in sas_list:
                  ## Set infolivre variables
                    app = str(component).lower()
                    artifact_path = '${artifact_path}' + str(app)
                    releaseVariables['artifactPath'] = artifact_path
                    appName = '${modlib}' + "_" + str(component) + "_" + "DEPLOY"
                    releaseVariables['ext_appName'] = appName
              
                  ##creation de tache ansible
                    taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                    taskUpdateReleaseIds.title = 'deploy ' + str(component) + " " + '${release_version}'
                    extravarsName = "extra_vars"
                    taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                    taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                    taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                    taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables[extravarsName])
                    taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
              
              
                  ##ajout de la task ansible sur le group sequential
                    taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
        color: "#3d6c9e"
    variables:
      - type: xlrelease.StringVariable
        key: release_version
        label: Version
      - type: xlrelease.StringVariable
        key: AAP-name-organizations
        requiresValue: false
        showOnReleaseStart: false
        value: CARDIF_GDA-OPS
      - type: xlrelease.StringVariable
        key: pipeline
        requiresValue: false
        showOnReleaseStart: false
        value: cd_infolivre_xlr
      - type: xlrelease.StringVariable
        key: ext_env
        label: Environment
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - int
            - ppd
            - prod
            - rec
      - type: xlrelease.StringVariable
        key: ext_chainNum
        requiresValue: false
        showOnReleaseStart: false
        label: couloir
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "01"
            - "02"
      - type: xlrelease.StringVariable
        key: user
        label: UID
      - type: xlrelease.PasswordStringVariable
        key: password
        label: Password
      - type: xlrelease.StringVariable
        key: ext_envc
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: env
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ext_appVersion
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ext_isRelease
        requiresValue: false
        showOnReleaseStart: false
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "true"
            - "false"
      - type: xlrelease.StringVariable
        key: ext_environnement
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ansible_python_interpreter
        requiresValue: false
        showOnReleaseStart: false
        value: /usr/bin/python3
      - type: xlrelease.StringVariable
        key: ext_appenv
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: codeAP
        requiresValue: false
        showOnReleaseStart: false
        value: "23882"
      - type: xlrelease.StringVariable
        key: trigram
        requiresValue: false
        showOnReleaseStart: false
        value: rat
      - type: xlrelease.StringVariable
        key: code5car
        requiresValue: false
        showOnReleaseStart: false
        value: rat00
      - type: xlrelease.StringVariable
        key: ext_projectid
        requiresValue: false
        showOnReleaseStart: false
        value: "1212"
      - type: xlrelease.StringVariable
        key: ext_ModuleName
        requiresValue: false
        showOnReleaseStart: false
        value: maven
      - type: xlrelease.StringVariable
        key: ext_binary_url
        requiresValue: false
        showOnReleaseStart: false
        value: NONE
      - type: xlrelease.MapStringStringVariable
        key: extra_vars
        requiresValue: false
        showOnReleaseStart: false
        value:
          ext_chainNum: "${ext_chainNum}"
          ext_projectid: "${ext_projectid}"
          ext_binary_url: "${ext_binary_url}"
          ext_envc: "${ext_envc}"
          ansible_python_interpreter: "${ansible_python_interpreter}"
          code5car: "${code5car}"
          trigram: "${trigram}"
          ext_isRelease: "${ext_isRelease}"
          ext_env: "${ext_env}"
          artifactPath: com/bnpcardif/carat
          ext_appName: "${ext_appName}"
          ext_nom_tns: "${ext_nom_tns}"
          ext_ModuleName: "${ext_ModuleName}"
          ext_appVersion: "${release_version}"
          codeAP: "${codeAP}"
      - type: xlrelease.StringVariable
        key: version
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: modules_todeploy
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - DIFFUSION
            - BATCH
      - type: xlrelease.StringVariable
        key: ext_nom_tns
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ext_appName
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: artifact_path
        requiresValue: false
        showOnReleaseStart: false
        value: com/bnpcardif/carat/
      - type: xlrelease.StringVariable
        key: modlib
        requiresValue: false
        showOnReleaseStart: false
        value: carat
      - type: xlrelease.StringVariable
        key: ap_code
        requiresValue: false
        showOnReleaseStart: false
        label: Script
        description: Script
        value: "AP${codeAP}"
      - type: xlrelease.StringVariable
        key: ext_projectID
        requiresValue: false
        showOnReleaseStart: false
        label: Script
        description: Script
        value: "${ext_projectid}"
      - type: xlrelease.StringVariable
        key: scm_url
        requiresValue: false
        showOnReleaseStart: false
        value: https://gitlab-dogen.group.echonet/gf/itg_itgp/dass/toolchain_cardif_xlr/infolivre.git
      - type: xlrelease.StringVariable
        key: scm_branch
        requiresValue: false
        showOnReleaseStart: false
        value: v3.2
    allowPasswordsInAllFields: true
    disableNotifications: true
    scriptUsername: RunAsUser
    variableMapping:
      scriptUserPassword: "${global.RunAsUserPassword}"
    riskProfile: Default risk profile
  - template: cd-LibertyCore-AP08699-LOA-DEPLOY application CARAT
    scheduledStartDate: 2023-07-26T09:00:00+02:00
    dueDate: 2023-07-26T10:00:00+02:00
    phases:
      - phase: Deploy appli
        tasks:
          - name: üë®‚ÄçüöÄ SET COULOIR
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - ext_chainNum
          - name: üè≠ SET ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              # get phase name / environment
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              myenv = '${ext_env}'
              myappli = '${application}'
              
              
              ##set env variable from phase_name
              if str(myenv) == "int":
                  releaseVariables['ext_environnement'] = "Integration"
                  env = "HORSPROD"
              if str(myenv) == "rec":
                  releaseVariables['ext_environnement'] = "Recette"
                  env = "ISOPROD"
              if str(myenv) == "prd":
                  releaseVariables['ext_environnement'] = "Production"
                  env = "PROD"
              if str(myenv) == "prod":
                  releaseVariables['ext_environnement'] = "Production"
                  env = "PROD"
              
              myhost = "hosts" + "_" + str(myenv) + "_" + str(myappli)
              releaseVariables['host'] = releaseVariables[myhost]
              
              
              releaseVariables['env'] = str(env)
              
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              ## AAP Project
              project = "p-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}'
              var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
              var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
              releaseVariables[var_poject_name] = project
              releaseVariables[var_poject_id] = ""
              
              ## AAP Team
              team = "t-" + '${AAP-name-organizations}' + "-" + '${ap_code}' + "-" + '${ext_projectID}'
              var_team_name = "AAP-name-" + '${AAP-name-organizations}' + "-teams"
              var_team_id = "AAP-id-" + '${AAP-name-organizations}' + "-teams"
              releaseVariables[var_team_name] = team
              releaseVariables[var_team_id] = ""
              
              ## Set AAP Inventories
              inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(env)
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = str(phase_name) + " " + str(myappli) + str(myenv) + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: ‚ö° SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES IDs
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskGetResourceId = taskApi.newTask("webhook.JsonWebhook")
                              taskGetResourceId.pythonScript.setProperty("URL", api_check_url)
                              taskGetResourceId.pythonScript.setProperty("method", 'GET')
                              taskGetResourceId.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskGetResourceId.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskGetResourceId.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskGetResourceId.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskGetResourceId.setTaskFailureHandlerEnabled(True)
                              taskGetResourceId.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskGetResourceId.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskGetResourceId)
                      
                          if "AAP-name" in obj.key and "organizations" in obj.key:
                              resource = obj.value
                              var_name = obj.key
                              type = var_name.split('-')[-1]
                              var_resourceId = var_name.replace("name", "id")
                              if releaseVariables[var_resourceId] == "":
                                  list_roles = ['AAP_Execute_Role_id', 'AAP_Inventory_Admin_Role_id', 'AAP_Credentials_Admin_Role_id']
                                  for role in list_roles:
                                      if role == "AAP_Execute_Role_id":
                                          jsonpath = ".results[0].summary_fields.object_roles.execute_role.id"
                                      if role == "AAP_Inventory_Admin_Role_id":
                                          jsonpath = ".results[0].summary_fields.object_roles.inventory_admin_role.id"
                                      if role == "AAP_Credentials_Admin_Role_id":
                                          jsonpath = ".results[0].summary_fields.object_roles.credential_admin_role.id"
                                      api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                                      taskGetRolesId = taskApi.newTask("webhook.JsonWebhook")
                                      taskGetRolesId.pythonScript.setProperty("URL", api_check_url)
                                      taskGetRolesId.pythonScript.setProperty("method", 'GET')
                                      taskGetRolesId.pythonScript.setProperty("jsonPathExpression", "$" + str(jsonpath))
                                      taskGetRolesId.variableMapping = {"pythonScript.result": "$" + "{" + str(role) + "}"}
                                      taskGetRolesId.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                                      taskGetRolesId.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                                      taskGetRolesId.setTaskFailureHandlerEnabled(True)
                                      taskGetRolesId.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                                      taskGetRolesId.title = "get Role Id " + str(type) + " " + str(resource) + " " + str(role)
                                      taskApi.addTask(sequentialGroupId, taskGetRolesId)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Set Credential task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + "organizations":
                              organization_id = obj.value
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                              resource_id = obj.value
                              var_name = obj.key
                              resource_type = var_name.split('-')[-1]
                          if obj.key == "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                              resource_name = obj.value
                              credential_type = '24'
                      body = "\"" + "name" + "\"" + ": " + "\"" + str(resource_name) + "\"" + ", " + "\"" + "organization" + "\"" + ": " + str(organization_id) + ", " + "\"" + "credential_type" + "\"" + ": " + str(credential_type) + ", " + "\"" + "inputs" + "\"" + ": { " + "\"" + "artifact_user" + "\"" + ": " + "\"" + "$" + "{" + "user" + "}" + "\"" + ", " + "\"" + "artifact_password" + "\"" + ": " + "\"" + "$" + "{" + "password" + "}" + "\"" + "}"
                      
                      
                      api_put_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                      taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                      taskUpdateResource.pythonScript.setProperty("URL", api_put_url)
                      taskUpdateResource.pythonScript.setProperty("method", 'PUT')
                      taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                      taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                      taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                      taskUpdateResource.title = "Set credential " + " " + str(resource_name)
                      taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "webhook.JsonWebhook".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      if "socle" in '${deploy}':
                          playbook = 'deploy_wlc_socle_1T.yml'
                      else:
                          playbook = 'deploy_wlc_appli_1T.yml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "Update" + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                      
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-teams":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              list_roles = ['AAP_Execute_Role_id', 'AAP_Inventory_Admin_Role_id', 'AAP_Credentials_Admin_Role_id']
                              for role in list_roles:
                                  role_id = releaseVariables[role]
                                  body = "\"" + "id" + "\"" + ": " + str(role_id)
                      
                                  api_post_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/" + "roles" + "/"
                                  taskUpdateTeam = taskApi.newTask("webhook.JsonWebhook")
                                  taskUpdateTeam.pythonScript.setProperty("URL", api_post_url)
                                  taskUpdateTeam.pythonScript.setProperty("method", 'POST')
                                  taskUpdateTeam.pythonScript.setProperty("body", "{" + str(body) + "}")
                                  taskUpdateTeam.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                                  taskUpdateTeam.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                                  taskUpdateTeam.title = "Update" + " " + str(resource_type) + str(resource_name) + str(role)
                                  taskApi.addTask(sequentialGroupId, taskUpdateTeam)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
                  from com.xebialabs.xlrelease.api.v1.forms import Variable
                  from com.xebialabs.xlrelease.api.v1 import PhaseApi
                  
                  time.sleep(20)
                  
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  ##get modules to deploy
                  sas_list=releaseVariables['modules_todeploy']
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  
                      ## set isRelease variable dynamically
                      if "SNAPSHOT" in '${appVersion}':
                          releaseVariables['isRelease'] = "false"
                          releaseVariables['version'] = "SNAPSHOT"
                      else:
                          releaseVariables['isRelease'] = "true"
                          releaseVariables['version'] = "RELEASE"
                  
                  my_env = '${ext_env}'
                  
                  releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper()
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  for component in sas_list:
                      ##Create task
                      extra_vars = str(component) + "_extra_vars"
                      print releaseVariables[extra_vars]
                      taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                      taskUpdateReleaseIds.title = 'deploy ' + '${deploy}' + " " + 'on ' + '${ext_env}' + '${ext_chainNum}'
                      taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                      taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                      taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                      taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables[extra_vars])
                      taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                      ##Add task in sequential group
                      taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöÄ DEPLOY GROUP
                type: xlrelease.SequentialGroup
        color: "#3d6c9e"
    variables:
      - type: xlrelease.StringVariable
        key: AAP-name-organizations
        requiresValue: false
        showOnReleaseStart: false
        value: CARDIF_GDA-OPS
      - type: xlrelease.StringVariable
        key: pipeline
        requiresValue: false
        showOnReleaseStart: false
        value: deploy_loa
      - type: xlrelease.StringVariable
        key: scm_branch
        showOnReleaseStart: false
        value: develop
      - type: xlrelease.StringVariable
        key: scm_url
        showOnReleaseStart: false
        label: Repo git url
        value: https://gitlab-dogen.group.echonet/Retail/cardif/moe_carat/e0511_carat/deploy_loa.git
      - type: xlrelease.StringVariable
        key: user
        label: UID
      - type: xlrelease.PasswordStringVariable
        key: password
        label: Password
      - type: xlrelease.StringVariable
        key: deploy
        requiresValue: false
        showOnReleaseStart: false
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - socle
            - application
        value: application
      - type: xlrelease.StringVariable
        key: release_version
        showOnReleaseStart: false
        label: Version
      - type: xlrelease.StringVariable
        key: ext_envc
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: appVersion
        requiresValue: false
      - type: xlrelease.ListStringVariable
        key: modules_todeploy
        requiresValue: false
        showOnReleaseStart: false
        label: biz and/or prez
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - biz
        value:
          - biz
      - type: xlrelease.StringVariable
        key: application
        label: Application
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - poarefV5
            - poarefV6
            - starcust
            - caratV5
            - caratV6
      - type: xlrelease.StringVariable
        key: ext_env
        label: Environment
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - int
            - ppd
            - rec
            - prd
            - prod
      - type: xlrelease.StringVariable
        key: ext_chainNum
        showOnReleaseStart: false
        label: couloir
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "01"
            - "02"
      - type: xlrelease.StringVariable
        key: isRelease
        requiresValue: false
        showOnReleaseStart: false
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "true"
            - "false"
      - type: xlrelease.StringVariable
        key: playbook
        showOnReleaseStart: false
        label: create socle or deploy application
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - deploy
        value: deploy
      - type: xlrelease.StringVariable
        key: other_lane
        showOnReleaseStart: false
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "yes"
            - "no"
      - type: xlrelease.StringVariable
        key: ext_environnement
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ext_appLayer
        requiresValue: false
        showOnReleaseStart: false
        value: biz
      - type: xlrelease.StringVariable
        key: ansible_python_interpreter
        requiresValue: false
        showOnReleaseStart: false
        value: /usr/bin/python3
      - type: xlrelease.StringVariable
        key: ext_appenv
        requiresValue: false
        showOnReleaseStart: false
        value: "${ext_env}"
      - type: xlrelease.StringVariable
        key: ap_code
        requiresValue: false
        showOnReleaseStart: false
        value: "AP${codeAP}"
      - type: xlrelease.StringVariable
        key: owner_uid
        showOnReleaseStart: false
        label: Release Owner
        value: "${user}"
      - type: xlrelease.StringVariable
        key: codeAP
        requiresValue: false
        showOnReleaseStart: false
        value: "23882"
      - type: xlrelease.StringVariable
        key: trigram
        requiresValue: false
        showOnReleaseStart: false
        value: loa
      - type: xlrelease.StringVariable
        key: code5car
        requiresValue: false
        showOnReleaseStart: false
        value: loa00
      - type: xlrelease.StringVariable
        key: ext_projectID
        requiresValue: false
        showOnReleaseStart: false
        value: "1212"
      - type: xlrelease.StringVariable
        key: ext_artifactPath
        requiresValue: false
        showOnReleaseStart: false
        value: com/bpc/eif/loa/mod
      - type: xlrelease.StringVariable
        key: ext_artifactId
        requiresValue: false
        showOnReleaseStart: false
        value: maven
      - type: xlrelease.StringVariable
        key: ext_ear_binary_url
        requiresValue: false
        showOnReleaseStart: false
        value: NONE
      - type: xlrelease.StringVariable
        key: ext_sharedLib_binary_url
        requiresValue: false
        showOnReleaseStart: false
        value: NONE
      - type: xlrelease.StringVariable
        key: ext_sharedLibEnv
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: biz_ModuleName
        requiresValue: false
        showOnReleaseStart: false
        value: BPC_LOA_CONSULTLOGS_SERV_EAR
      - type: xlrelease.StringVariable
        key: biz_sharedModuleName
        requiresValue: false
        showOnReleaseStart: false
        value: BPC_LOA_CONSULTLOGS_SERV_EAR
      - type: xlrelease.StringVariable
        key: biz_modlib
        requiresValue: false
        showOnReleaseStart: false
        value: services
      - type: xlrelease.StringVariable
        key: biz_contextRoot
        requiresValue: false
        showOnReleaseStart: false
        value: eif_referentiels
      - type: xlrelease.StringVariable
        key: biz_jvmClassLoader
        requiresValue: false
        showOnReleaseStart: false
        value: ParentFirst
      - type: xlrelease.StringVariable
        key: biz_alterconfig
        requiresValue: false
        showOnReleaseStart: false
        value: "yes"
      - type: xlrelease.StringVariable
        key: biz_xcaliaResource
        requiresValue: false
        showOnReleaseStart: false
        value: "no"
      - type: xlrelease.StringVariable
        key: biz_autoExpand
        requiresValue: false
        showOnReleaseStart: false
        value: "false"
      - type: xlrelease.StringVariable
        key: biz_jndiEntry
        requiresValue: false
        showOnReleaseStart: false
        value: "no"
      - type: xlrelease.StringVariable
        key: biz_jndiEntryList
        requiresValue: false
        showOnReleaseStart: false
        value: "[{'name': 'string', 'value': 'string'}, {'name': 'string', 'value': 'string'}]"
      - type: xlrelease.StringVariable
        key: biz_safResource
        requiresValue: false
        showOnReleaseStart: false
        value: "no"
      - type: xlrelease.StringVariable
        key: biz_jvmEnabledFeaturesList
        requiresValue: false
        showOnReleaseStart: false
        value: "[{'name': 'localConnector-1.0'}, {'name': 'webProfile-8.0'}]"
      - type: xlrelease.StringVariable
        key: biz_ext_appLayer
        requiresValue: false
        showOnReleaseStart: false
        value: biz
      - type: xlrelease.MapStringStringVariable
        key: biz_extra_vars
        requiresValue: false
        showOnReleaseStart: false
        value:
          ext_artifactId: "${ext_artifactId}"
          isRelease: "${isRelease}"
          biz_jvmClassLoader: "${biz_jvmClassLoader}"
          appenv: "${ext_appenv}"
          biz_alterconfig: "${biz_alterconfig}"
          biz_jvmEnabledFeaturesList: "${biz_jvmEnabledFeaturesList}"
          env: "${env}"
          chainNum: "${ext_chainNum}"
          hosts: "${host}"
          ap_code: "${ap_code}"
          ear_binary_url: "${ext_ear_binary_url}"
          trigram: "${trigram}"
          environnement: "${ext_environnement}"
          codeAP: "08699"
          appOptArgs: "${appOptArgs}"
          biz_autoExpand: "${biz_autoExpand}"
          ext_projectID: "${projectID_LOA}"
          biz_modlib: "${biz_modlib}"
          ext_artifactPath: "${ext_artifactPath}"
          biz_jndiEntryList: "${biz_jndiEntryList}"
          sharedLib_binary_url: "${ext_sharedLib_binary_url}"
          appVersion: "${appVersion}"
          ansible_python_interpreter: "${ansible_python_interpreter}"
          biz_jndiEntry: "${biz_jndiEntry}"
          code5car: "${code5car}"
          appLayer: "${biz_ext_appLayer}"
          biz_safResource: "${biz_safResource}"
          ext_sharedLibEnv: "${ext_sharedLibEnv}"
          biz_contextRoot: "${biz_contextRoot}"
          biz_ModuleName: "${biz_ModuleName}"
          biz_xcaliaResource: "${biz_xcaliaResource}"
          biz_sharedModuleName: "${biz_sharedModuleName}"
      - type: xlrelease.StringVariable
        key: version
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: AAP_Execute_Role_id
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: AAP_Inventory_Admin_Role_id
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: AAP_Credentials_Admin_Role_id
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: host
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: env
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: appOptArgs
        showOnReleaseStart: false
        value: force
      - type: xlrelease.ListStringVariable
        key: hosts_int_poarefV6
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s02vl9930258.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_rec_poarefV6
        showOnReleaseStart: false
        value:
          - s02vl9930331.fr.net.intra
          - s02vl9930338.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_prd_poarefV6
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s02vl9930505.fr.net.intra
          - s02vl9930506.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_int_caratV5
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s01vl9901631.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_rec_caratV5
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s01vl9902227.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_prod_caratV5
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s01vl9903018.fr.net.intra
          - s01vl9903025.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_int_starcust
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s02vl9900844.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_rec_starcust
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s02vl9901360.fr.net.intra
          - s02vl9901361.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_prod_starcust
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s02vl9901968.fr.net.intra
          - s02vl9901969.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_int_caratV6
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s02vl9904804.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_rec_caratV6
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s02vl9904789.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_prod_caratV6
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s02vl9904791.fr.net.intra
          - s02vl9904792.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_int_poarefV5
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s00vl9976457.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_rec_poarefV5
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s00vl9975634.fr.net.intra
      - type: xlrelease.StringVariable
        key: projectID_LOA
        showOnReleaseStart: false
        value: "1671"
    allowPasswordsInAllFields: true
    disableNotifications: true
    scriptUsername: RunAsUser
    variableMapping:
      scriptUserPassword: "${global.RunAsUserPassword}"
    riskProfile: Default risk profile
  - template: cd-LibertyCore-AP08699-LOA-DEPLOY socle CARAT
    scheduledStartDate: 2023-07-26T09:00:00+02:00
    dueDate: 2023-07-26T10:00:00+02:00
    phases:
      - phase: Create socle
        tasks:
          - name: üë®‚ÄçüöÄ SET COULOIR
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - ext_chainNum
          - name: üè≠ SET ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              # get phase name / environment
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              myenv = '${ext_env}'
              myappli = '${application}'
              
              
              ##set env variable from phase_name
              if str(myenv) == "int":
                  releaseVariables['ext_environnement'] = "Integration"
                  env = "HORSPROD"
              if str(myenv) == "rec":
                  releaseVariables['ext_environnement'] = "Recette"
                  env = "ISOPROD"
              if str(myenv) == "prod":
                  releaseVariables['ext_environnement'] = "Production"
                  env = "PROD"
              
              myhost = "hosts" + "_" + str(myenv) + "_" + str(myappli)
              releaseVariables['host'] = releaseVariables[myhost]
              
              
              releaseVariables['env'] = str(env)
              
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              ## AAP Project
              project = "p-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}'
              var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
              var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
              releaseVariables[var_poject_name] = project
              releaseVariables[var_poject_id] = ""
              
              ## AAP Team
              team = "t-" + '${AAP-name-organizations}' + "-" + '${ap_code}' + "-" + '${ext_projectID}'
              var_team_name = "AAP-name-" + '${AAP-name-organizations}' + "-teams"
              var_team_id = "AAP-id-" + '${AAP-name-organizations}' + "-teams"
              releaseVariables[var_team_name] = team
              releaseVariables[var_team_id] = ""
              
              ## Set AAP Inventories
              inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(env)
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(phase_name) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = str(phase_name) + " " + str(myappli) + str(myenv) + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: ‚ö° SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES IDs
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskGetResourceId = taskApi.newTask("webhook.JsonWebhook")
                              taskGetResourceId.pythonScript.setProperty("URL", api_check_url)
                              taskGetResourceId.pythonScript.setProperty("method", 'GET')
                              taskGetResourceId.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskGetResourceId.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskGetResourceId.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskGetResourceId.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskGetResourceId.setTaskFailureHandlerEnabled(True)
                              taskGetResourceId.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskGetResourceId.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskGetResourceId)
                      
                          if "AAP-name" in obj.key and "organizations" in obj.key:
                              resource = obj.value
                              var_name = obj.key
                              type = var_name.split('-')[-1]
                              var_resourceId = var_name.replace("name", "id")
                              if releaseVariables[var_resourceId] == "":
                                  list_roles = ['AAP_Execute_Role_id', 'AAP_Inventory_Admin_Role_id', 'AAP_Credentials_Admin_Role_id']
                                  for role in list_roles:
                                      if role == "AAP_Execute_Role_id":
                                          jsonpath = ".results[0].summary_fields.object_roles.execute_role.id"
                                      if role == "AAP_Inventory_Admin_Role_id":
                                          jsonpath = ".results[0].summary_fields.object_roles.inventory_admin_role.id"
                                      if role == "AAP_Credentials_Admin_Role_id":
                                          jsonpath = ".results[0].summary_fields.object_roles.credential_admin_role.id"
                                      api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                                      taskGetRolesId = taskApi.newTask("webhook.JsonWebhook")
                                      taskGetRolesId.pythonScript.setProperty("URL", api_check_url)
                                      taskGetRolesId.pythonScript.setProperty("method", 'GET')
                                      taskGetRolesId.pythonScript.setProperty("jsonPathExpression", "$" + str(jsonpath))
                                      taskGetRolesId.variableMapping = {"pythonScript.result": "$" + "{" + str(role) + "}"}
                                      taskGetRolesId.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                                      taskGetRolesId.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                                      taskGetRolesId.setTaskFailureHandlerEnabled(True)
                                      taskGetRolesId.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                                      taskGetRolesId.title = "get Role Id " + str(type) + " " + str(resource) + " " + str(role)
                                      taskApi.addTask(sequentialGroupId, taskGetRolesId)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Set Credential task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + "organizations":
                              organization_id = obj.value
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                              resource_id = obj.value
                              var_name = obj.key
                              resource_type = var_name.split('-')[-1]
                          if obj.key == "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                              resource_name = obj.value
                              credential_type = '24'
                      body = "\"" + "name" + "\"" + ": " + "\"" + str(resource_name) + "\"" + ", " + "\"" + "organization" + "\"" + ": " + str(organization_id) + ", " + "\"" + "credential_type" + "\"" + ": " + str(credential_type) + ", " + "\"" + "inputs" + "\"" + ": { " + "\"" + "artifact_user" + "\"" + ": " + "\"" + "$" + "{" + "user" + "}" + "\"" + ", " + "\"" + "artifact_password" + "\"" + ": " + "\"" + "$" + "{" + "password" + "}" + "\"" + "}"
                      
                      
                      api_put_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                      taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                      taskUpdateResource.pythonScript.setProperty("URL", api_put_url)
                      taskUpdateResource.pythonScript.setProperty("method", 'PUT')
                      taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                      taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                      taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                      taskUpdateResource.title = "Set credential " + " " + str(resource_name)
                      taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "webhook.JsonWebhook".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      if "socle" in '${deploy}':
                          playbook = 'deploy_wlc_socle_1T.yml'
                      else:
                          playbook = 'deploy_application.yml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "Update" + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                      
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-teams":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              list_roles = ['AAP_Execute_Role_id', 'AAP_Inventory_Admin_Role_id', 'AAP_Credentials_Admin_Role_id']
                              for role in list_roles:
                                  role_id = releaseVariables[role]
                                  body = "\"" + "id" + "\"" + ": " + str(role_id)
                      
                                  api_post_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/" + "roles" + "/"
                                  taskUpdateTeam = taskApi.newTask("webhook.JsonWebhook")
                                  taskUpdateTeam.pythonScript.setProperty("URL", api_post_url)
                                  taskUpdateTeam.pythonScript.setProperty("method", 'POST')
                                  taskUpdateTeam.pythonScript.setProperty("body", "{" + str(body) + "}")
                                  taskUpdateTeam.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                                  taskUpdateTeam.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                                  taskUpdateTeam.title = "Update" + " " + str(resource_type) + str(resource_name) + str(role)
                                  taskApi.addTask(sequentialGroupId, taskUpdateTeam)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
                  from com.xebialabs.xlrelease.api.v1.forms import Variable
                  from com.xebialabs.xlrelease.api.v1 import PhaseApi
                  
                  time.sleep(20)
                  
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  ##get modules to deploy
                  sas_list=releaseVariables['modules_todeploy']
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  for component in sas_list:
                      ##Create task
                      extra_vars = str(component) + "_extra_vars"
                      print releaseVariables[extra_vars]
                      taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                      taskUpdateReleaseIds.title = 'deploy ' + '${deploy}' + " " + 'on ' + '${ext_env}' + '${ext_chainNum}'
                      taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                      taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                      taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                      taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables[extra_vars])
                      taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                      ##Add task in sequential group
                      taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöÄ DEPLOY GROUP
                type: xlrelease.SequentialGroup
        color: "#3d6c9e"
    variables:
      - type: xlrelease.StringVariable
        key: AAP-name-organizations
        requiresValue: false
        showOnReleaseStart: false
        value: CARDIF_GDA-OPS
      - type: xlrelease.StringVariable
        key: pipeline
        requiresValue: false
        showOnReleaseStart: false
        value: deploy_loa
      - type: xlrelease.StringVariable
        key: scm_branch
        showOnReleaseStart: false
        value: develop
      - type: xlrelease.StringVariable
        key: scm_url
        showOnReleaseStart: false
        label: Repo git url
        value: https://gitlab-dogen.group.echonet/Retail/cardif/moe_carat/e0511_carat/deploy_loa.git
      - type: xlrelease.StringVariable
        key: user
        label: UID
      - type: xlrelease.PasswordStringVariable
        key: password
        label: Password
      - type: xlrelease.StringVariable
        key: deploy
        requiresValue: false
        showOnReleaseStart: false
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - socle
            - application
        value: socle
      - type: xlrelease.StringVariable
        key: release_version
        showOnReleaseStart: false
        label: Version
      - type: xlrelease.StringVariable
        key: ext_envc
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ext_appVersion
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.ListStringVariable
        key: modules_todeploy
        requiresValue: false
        showOnReleaseStart: false
        label: biz and/or prez
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - biz
        value:
          - biz
      - type: xlrelease.StringVariable
        key: application
        label: Application
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - poarefV5
            - poarefV6
            - starcust
            - caratV5
            - caratV6
      - type: xlrelease.StringVariable
        key: ext_env
        label: Environment
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - int
            - ppd
            - prod
            - rec
      - type: xlrelease.StringVariable
        key: ext_chainNum
        showOnReleaseStart: false
        label: couloir
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "01"
            - "02"
      - type: xlrelease.StringVariable
        key: ext_isRelease
        requiresValue: false
        showOnReleaseStart: false
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "true"
            - "false"
      - type: xlrelease.StringVariable
        key: playbook
        showOnReleaseStart: false
        label: create socle or deploy application
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - deploy
        value: deploy
      - type: xlrelease.StringVariable
        key: other_lane
        showOnReleaseStart: false
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "yes"
            - "no"
      - type: xlrelease.StringVariable
        key: ext_environnement
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ext_appLayer
        requiresValue: false
        showOnReleaseStart: false
        value: biz
      - type: xlrelease.StringVariable
        key: ansible_python_interpreter
        requiresValue: false
        showOnReleaseStart: false
        value: /usr/bin/python3
      - type: xlrelease.StringVariable
        key: ext_appenv
        requiresValue: false
        showOnReleaseStart: false
        value: "${ext_env}"
      - type: xlrelease.StringVariable
        key: ap_code
        requiresValue: false
        showOnReleaseStart: false
        value: "AP${codeAP}"
      - type: xlrelease.StringVariable
        key: owner_uid
        showOnReleaseStart: false
        label: Release Owner
        value: "${user}"
      - type: xlrelease.StringVariable
        key: codeAP
        requiresValue: false
        showOnReleaseStart: false
        value: "23882"
      - type: xlrelease.StringVariable
        key: trigram
        requiresValue: false
        showOnReleaseStart: false
        value: loa
      - type: xlrelease.StringVariable
        key: code5car
        requiresValue: false
        showOnReleaseStart: false
        value: loa00
      - type: xlrelease.StringVariable
        key: ext_projectID
        requiresValue: false
        showOnReleaseStart: false
        value: "1212"
      - type: xlrelease.StringVariable
        key: ext_artifactPath
        requiresValue: false
        showOnReleaseStart: false
        value: com/bpc/eif/loa/mod
      - type: xlrelease.StringVariable
        key: ext_artifactId
        requiresValue: false
        showOnReleaseStart: false
        value: maven
      - type: xlrelease.StringVariable
        key: ext_ear_binary_url
        requiresValue: false
        showOnReleaseStart: false
        value: NONE
      - type: xlrelease.StringVariable
        key: ext_sharedLib_binary_url
        requiresValue: false
        showOnReleaseStart: false
        value: NONE
      - type: xlrelease.StringVariable
        key: ext_sharedLibEnv
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: biz_ModuleName
        requiresValue: false
        showOnReleaseStart: false
        value: BPC_LOA_CONSULTLOGS_SERV_EAR
      - type: xlrelease.StringVariable
        key: biz_sharedModuleName
        requiresValue: false
        showOnReleaseStart: false
        value: BPC_LOA_CONSULTLOGS_SERV_EAR
      - type: xlrelease.StringVariable
        key: biz_modlib
        requiresValue: false
        showOnReleaseStart: false
        value: services
      - type: xlrelease.StringVariable
        key: biz_contextRoot
        requiresValue: false
        showOnReleaseStart: false
        value: eif_referentiels
      - type: xlrelease.StringVariable
        key: biz_jvmClassLoader
        requiresValue: false
        showOnReleaseStart: false
        value: ParentFirst
      - type: xlrelease.StringVariable
        key: biz_alterconfig
        requiresValue: false
        showOnReleaseStart: false
        value: "yes"
      - type: xlrelease.StringVariable
        key: biz_xcaliaResource
        requiresValue: false
        showOnReleaseStart: false
        value: "no"
      - type: xlrelease.StringVariable
        key: biz_autoExpand
        requiresValue: false
        showOnReleaseStart: false
        value: "false"
      - type: xlrelease.StringVariable
        key: biz_jndiEntry
        requiresValue: false
        showOnReleaseStart: false
        value: "no"
      - type: xlrelease.StringVariable
        key: biz_jndiEntryList
        requiresValue: false
        showOnReleaseStart: false
        value: "[{'name': 'string', 'value': 'string'}, {'name': 'string', 'value': 'string'}]"
      - type: xlrelease.StringVariable
        key: biz_safResource
        requiresValue: false
        showOnReleaseStart: false
        value: "no"
      - type: xlrelease.StringVariable
        key: biz_jvmEnabledFeaturesList
        requiresValue: false
        showOnReleaseStart: false
        value: "[{'name': 'localConnector-1.0'}, {'name': 'el-3.0'}, {'name': 'jdbc-4.1'},\
      \ {'name': 'jsp-2.3'}, {'name': 'jndi-1.0'}, {'name': 'servlet-3.1'}, {'name':\
      \ 'transportSecurity-1.0'}, {'name': 'concurrent-1.0'}, {'name': 'javaMail-1.5'},\
      \ {'name': 'beanValidation-1.1'}]"
      - type: xlrelease.StringVariable
        key: biz_ext_appLayer
        requiresValue: false
        showOnReleaseStart: false
        value: biz
      - type: xlrelease.MapStringStringVariable
        key: biz_extra_vars
        requiresValue: false
        showOnReleaseStart: false
        value:
          biz_jvmClassLoader: "${biz_jvmClassLoader}"
          biz_autoExpand: "${biz_autoExpand}"
          appenv: "${ext_appenv}"
          biz_alterconfig: "${biz_alterconfig}"
          biz_modlib: "${biz_modlib}"
          biz_jndiEntryList: "${biz_jndiEntryList}"
          biz_jvmEnabledFeaturesList: "${biz_jvmEnabledFeaturesList}"
          env: "${env}"
          hosts: "${host}"
          chainNum: "${ext_chainNum}"
          ap_code: "${ap_code}"
          ansible_python_interpreter: "${ansible_python_interpreter}"
          biz_jndiEntry: "${biz_jndiEntry}"
          code5car: "${code5car}"
          appLayer: "${biz_ext_appLayer}"
          biz_safResource: "${biz_safResource}"
          trigram: "${trigram}"
          environnement: "${ext_environnement}"
          codeAP: "08699"
          biz_contextRoot: "${biz_contextRoot}"
          biz_ModuleName: "${biz_ModuleName}"
          biz_xcaliaResource: "${biz_xcaliaResource}"
          biz_sharedModuleName: "${biz_sharedModuleName}"
          appOptArgs: "${appOptArgs}"
      - type: xlrelease.StringVariable
        key: version
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: AAP_Execute_Role_id
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: AAP_Inventory_Admin_Role_id
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: AAP_Credentials_Admin_Role_id
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: host
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: env
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: appOptArgs
        showOnReleaseStart: false
        value: force
      - type: xlrelease.ListStringVariable
        key: hosts_int_poarefV6
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s02vl9930258.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_rec_poarefV6
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s02vl9930331.fr.net.intra
          - s02vl9930338.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_prod_poarefV6
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s02vl9930505.fr.net.intra
          - s02vl9930506.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_int_caratV5
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s01vl9901631.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_rec_caratV5
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s01vl9902227.f.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_prd_caratV5
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s01vl9903018.fr.net.intra
          - s01vl9903025.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_int_starcust
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s02vl9900844.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_rec_starcust
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s02vl9901360.fr.net.intra
          - s02vl9901361.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_prod_starcust
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s02vl9901968.fr.net.intra
          - s02vl9901969.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_int_caratV6
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s02vl9904804.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_rec_caratV6
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s02vl9904789.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_prod_caratV6
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s02vl9904791.fr.net.intra
          - s02vl9904792.fr.net.intra
      - type: xlrelease.ListStringVariable
        key: hosts_int_poarefV5
        requiresValue: false
        showOnReleaseStart: false
        value:
          - s00vl9976457.fr.net.intra
    allowPasswordsInAllFields: true
    disableNotifications: true
    scriptUsername: RunAsUser
    variableMapping:
      scriptUserPassword: "${global.RunAsUserPassword}"
    riskProfile: Default risk profile
  - template: cd-LibertyCore-AP23882-CARAT-DEPLOY EBX V6 deploy application - multienv
    scheduledStartDate: 2023-07-26T09:00:00+02:00
    dueDate: 2023-07-26T10:00:00+02:00
    phases:
      - phase: int
        tasks:
          - name: üë®‚ÄçüöÄ SET COULOIR
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            team: Release User
            variables:
              - ext_chainNum
          - name: SET ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              ####get the environement variable : int / rec / ppd/ prd ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              
              releaseVariables['incrementation'] = releaseVariables['incrementation'] + 1
              
              myenv = phase_name
              
              if myenv == "ppd":
                  envc = "x"
              else:
              
              ##set envc variable from envir
                  envc = myenv[0]
              releaseVariables['ext_envc'] = envc
              envd = envc.upper()
              releaseVariables['ext_envd'] = envd
              
              ##set env variable from phase_name
              if str(myenv) == "int":
                  releaseVariables['ext_environnement'] = "Integration"
                  releaseVariables['env'] = "HORSPROD"
              if str(myenv) == "rec":
                  releaseVariables['ext_environnement'] = "Recette"
                  releaseVariables['env'] = "ISOPROD"
              if str(myenv) == "ppd":
                  releaseVariables['ext_environnement'] = "PreProduction"
                  releaseVariables['env'] = "PROD"
              if str(myenv) == "prd":
                  releaseVariables['ext_environnement'] = "Production"
                  releaseVariables['env'] = "PROD"
              
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              ## AAP Project
              project = "p-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}'
              var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
              var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
              releaseVariables[var_poject_name] = project
              releaseVariables[var_poject_id] = ""
              
              print str(myenv)
              ## Set AAP Inventories
              if str(myenv) == "rec":
                  rec_chainNum = '${ext_chainNum}'
                  if map(int,str(rec_chainNum))[0] == 0:
                      ext_chainNum = rec_chainNum[1]
                  else:
                      ext_chainNum = rec_chainNum
              
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(myenv).upper() + str(ext_chainNum)
              else:
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(myenv).upper()
              
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(myenv) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(myenv) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              my_env = myenv[0:3]
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = my_env
              phaseApi.updatePhase(phase)
          - name: Deletion prod phase if snapshot
            type: xlrelease.ScriptTask
            precondition: "releaseVariables['ext_isRelease'] == 'false'"
            script: |-
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              
              release = getCurrentRelease()
              listofppdphases = phaseApi.searchPhasesByTitle('ppd',release.id)
              listofprodphases = phaseApi.searchPhasesByTitle('prod',release.id)
              
              
              if listofprodphases or listofppdphases :
               ###get the prod and pprod phase ##
               prodphase = listofprodphases[0]
               pprodphase = listofppdphases[0]
              
               ###delete those phases ####
               phaseApi.deletePhase(prodphase.id)
               phaseApi.deletePhase(pprodphase.id)
          - name: ‚ö° SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES IDs
                type: xlrelease.SequentialGroup
                tasks:
                  - name: Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                              taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                              taskCheckResource.pythonScript.setProperty("method", 'GET')
                              taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskCheckResource.setTaskFailureHandlerEnabled(True)
                              taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskCheckResource.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskCheckResource)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: Set Credential task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + "organizations":
                              organization_id = obj.value
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                              resource_id = obj.value
                              var_name = obj.key
                              resource_type = var_name.split('-')[-1]
                          if obj.key == "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                              resource_name = obj.value
                              credential_type = '24'
                      body = "\"" + "name" + "\"" + ": " + "\"" + str(resource_name) + "\"" + ", " + "\"" + "organization" + "\"" + ": " + str(organization_id) + ", " + "\"" + "credential_type" + "\"" + ": " + str(credential_type) + ", " + "\"" + "inputs" + "\"" + ": { " + "\"" + "artifact_user" + "\"" + ": " + "\"" + "$" + "{" + "user" + "}" + "\"" + ", " + "\"" + "artifact_password" + "\"" + ": " + "\"" + "$" + "{" + "password" + "}" + "\"" + "}"
                      
                      
                      api_put_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                      taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                      taskUpdateResource.pythonScript.setProperty("URL", api_put_url)
                      taskUpdateResource.pythonScript.setProperty("method", 'PUT')
                      taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                      taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                      taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                      taskUpdateResource.title = "Set credential " + " " + str(resource_name)
                      taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      if "socle" in '${deploy}':
                          playbook = 'deploy_wlc_socle_1T.yml'
                      else:
                          playbook = 'deploy_wlc_appli_1T.yml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "update " + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
                  from com.xebialabs.xlrelease.api.v1.forms import Variable
                  from com.xebialabs.xlrelease.api.v1 import PhaseApi
                  
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  ##get modules to deploy
                  sas_list=releaseVariables['modules_todeploy']
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  if '${deploy}' == "application":
                      myenv = phase_name
                      my_env = myenv[0:3]
                      if str(my_env) == "int" or str(my_env) == "rec":
                          releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper() + "-" + releaseVariables['ext_chainNum']
                      if str(my_env) == "ppd" :
                          releaseVariables['ext_sharedLibEnv'] = "shared-PPROD"
                      if str(my_env) == "prod" :
                          releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper()
                  
                      ## set isRelease variable dynamically
                      if "SNAPSHOT" in '${release_version}':
                          releaseVariables['ext_isRelease'] = "false"
                          releaseVariables['version'] = "SNAPSHOT"
                      else:
                          releaseVariables['ext_isRelease'] = "true"
                          releaseVariables['version'] = "RELEASE"
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  for component in sas_list:
                      ##Create task
                      extra_vars = str(component) + "_extra_vars"
                      print releaseVariables[extra_vars]
                  
                      myenv = phase_name
                      my_env = myenv[0:3]
                  
                      taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                  
                      ##delete deploy task if we are in a copied phase
                  
                      if ${previous_lane} != 0:
                         taskUpdateReleaseIds.title = 'deploy ' + '${deploy}' + " " + 'on ' + str(my_env) + '0${previous_lane}'
                         TaskToDel_list = getTasksByTitle(taskUpdateReleaseIds.title, phaseTitle = phase_name)
                         TaskToDel = TaskToDel_list[0]
                         taskApi.delete(TaskToDel.id)
                         releaseVariables['previous_lane'] = ${ext_chainNum}
                      else:
                          releaseVariables['previous_lane'] = ${ext_chainNum}
                  
                      #creation of deployment task
                      taskUpdateReleaseIds.title = 'deploy ' + '${deploy}' + " " + 'on ' + str(my_env) + '${ext_chainNum}'
                      taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                      taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                      taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                      taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables[extra_vars])
                      taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                      ##Add task in sequential group
                      taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöÄ DEPLOY GROUP
                type: xlrelease.SequentialGroup
          - name: Wanna do to deploy in other chain ?
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            team: Release User
            variables:
              - deployintonewchain
          - name: Duplicate Phase
            type: xlrelease.ScriptTask
            script: |-
              phase = getCurrentPhase()
              phase_name = phase.title
              
              
              if releaseVariables['deployintonewchain'] == 'yes':
              
                newphase = phaseApi.copyPhase(phase.id,releaseVariables['incrementation'] )
              
              
                listofdynamicsvars = taskApi.searchTasksByTitle('SET ENV & AAP VARIABLES', newphase.title , release.id)
                setVars = listofdynamicsvars[0]
                setVars.setProperty("script", releaseVariables['set_vars_script'])
                taskApi.updateTask(setVars)
              
              
                listofdynamicsvars = taskApi.searchTasksByTitle('Get AAP Resources Ids task generator', newphase.title , release.id)
                setVars = listofdynamicsvars[0]
                setVars.setProperty("script", releaseVariables['get_ressources_script'])
                taskApi.updateTask(setVars)
              
              
                ####get set cred artifacts
                listofsetCreds = taskApi.searchTasksByTitle('Set Credential task generator', newphase.title , release.id)
                setCreds = listofsetCreds[0]
                setCreds.setProperty("script", releaseVariables['set_creds_script'])
                taskApi.updateTask(setCreds)
              
                listofdynamicsvars = taskApi.searchTasksByTitle('Update AAP Resources task generator', newphase.title , release.id)
                setVars = listofdynamicsvars[0]
                setVars.setProperty("script", releaseVariables['update_ressources_script'])
                taskApi.updateTask(setVars)
              
                listofduplicatephase = taskApi.searchTasksByTitle('Deploy task generator', newphase.title , release.id)
                duplicatephase = listofduplicatephase[0]
                duplicatephase.setProperty("script", releaseVariables['deployment_script'])
                taskApi.updateTask(duplicatephase)
              
                ##update next phase
                newphase.title = phase.title
                phaseApi.updatePhase(newphase)
              
              
              
              
              else:
                releaseVariables['previous_lane'] = 0
              
              
              
              #current_phase = phaseApi.getPhase(phase.id)
              #current_phase.title = current_phase.title
              
              
              #  phase.title = phase.title + " " + ext_chainNum
              #phaseApi.updatePhase(current_phase)
              myenv = phase_name
              my_env = myenv[0:3]
              phase.title = my_env + " " + releaseVariables['ext_chainNum']
              phaseApi.updatePhase(phase)
        color: "#3d6c9e"
      - phase: rec
        tasks:
          - name: üë®‚ÄçüöÄ SET COULOIR
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            team: Release User
            variables:
              - ext_chainNum
          - name: SET ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              ####get the environement variable : int / rec / ppd/ prd ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              
              releaseVariables['incrementation'] = releaseVariables['incrementation'] + 1
              
              myenv = phase_name
              
              if myenv == "ppd":
                  envc = "x"
              else:
              
              ##set envc variable from envir
                  envc = myenv[0]
              releaseVariables['ext_envc'] = envc
              envd = envc.upper()
              releaseVariables['ext_envd'] = envd
              
              ##set env variable from phase_name
              if str(myenv) == "int":
                  releaseVariables['ext_environnement'] = "Integration"
                  releaseVariables['env'] = "HORSPROD"
              if str(myenv) == "rec":
                  releaseVariables['ext_environnement'] = "Recette"
                  releaseVariables['env'] = "ISOPROD"
              if str(myenv) == "ppd":
                  releaseVariables['ext_environnement'] = "PreProduction"
                  releaseVariables['env'] = "PROD"
              if str(myenv) == "prd":
                  releaseVariables['ext_environnement'] = "Production"
                  releaseVariables['env'] = "PROD"
              
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              ## AAP Project
              project = "p-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}'
              var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
              var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
              releaseVariables[var_poject_name] = project
              releaseVariables[var_poject_id] = ""
              
              print str(myenv)
              ## Set AAP Inventories
              if str(myenv) == "rec":
                  rec_chainNum = '${ext_chainNum}'
                  if map(int,str(rec_chainNum))[0] == 0:
                      ext_chainNum = rec_chainNum[1]
                  else:
                      ext_chainNum = rec_chainNum
              
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(myenv).upper() + str(ext_chainNum)
              else:
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(myenv).upper()
              
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(myenv) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(myenv) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              my_env = myenv[0:3]
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = my_env
              phaseApi.updatePhase(phase)
          - name: Deletion prod phase if snapshot
            type: xlrelease.ScriptTask
            precondition: "releaseVariables['ext_isRelease'] == 'false'"
            script: |-
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              
              release = getCurrentRelease()
              listofppdphases = phaseApi.searchPhasesByTitle('ppd',release.id)
              listofprodphases = phaseApi.searchPhasesByTitle('prod',release.id)
              
              
              if listofprodphases or listofppdphases :
               ###get the prod and pprod phase ##
               prodphase = listofprodphases[0]
               pprodphase = listofppdphases[0]
              
               ###delete those phases ####
               phaseApi.deletePhase(prodphase.id)
               phaseApi.deletePhase(pprodphase.id)
          - name: ‚ö° SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES IDs
                type: xlrelease.SequentialGroup
                tasks:
                  - name: Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                              taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                              taskCheckResource.pythonScript.setProperty("method", 'GET')
                              taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskCheckResource.setTaskFailureHandlerEnabled(True)
                              taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskCheckResource.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskCheckResource)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: Set Credential task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + "organizations":
                              organization_id = obj.value
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                              resource_id = obj.value
                              var_name = obj.key
                              resource_type = var_name.split('-')[-1]
                          if obj.key == "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                              resource_name = obj.value
                              credential_type = '24'
                      body = "\"" + "name" + "\"" + ": " + "\"" + str(resource_name) + "\"" + ", " + "\"" + "organization" + "\"" + ": " + str(organization_id) + ", " + "\"" + "credential_type" + "\"" + ": " + str(credential_type) + ", " + "\"" + "inputs" + "\"" + ": { " + "\"" + "artifact_user" + "\"" + ": " + "\"" + "$" + "{" + "user" + "}" + "\"" + ", " + "\"" + "artifact_password" + "\"" + ": " + "\"" + "$" + "{" + "password" + "}" + "\"" + "}"
                      
                      
                      api_put_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                      taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                      taskUpdateResource.pythonScript.setProperty("URL", api_put_url)
                      taskUpdateResource.pythonScript.setProperty("method", 'PUT')
                      taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                      taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                      taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                      taskUpdateResource.title = "Set credential " + " " + str(resource_name)
                      taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      if "socle" in '${deploy}':
                          playbook = 'deploy_wlc_socle_1T.yml'
                      else:
                          playbook = 'deploy_wlc_appli_1T.yml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "update " + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
                  from com.xebialabs.xlrelease.api.v1.forms import Variable
                  from com.xebialabs.xlrelease.api.v1 import PhaseApi
                  
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  ##get modules to deploy
                  sas_list=releaseVariables['modules_todeploy']
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  if '${deploy}' == "application":
                      myenv = phase_name
                      my_env = myenv[0:3]
                      if str(my_env) == "int" or str(my_env) == "rec":
                          releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper() + "-" + releaseVariables['ext_chainNum']
                      if str(my_env) == "ppd" :
                          releaseVariables['ext_sharedLibEnv'] = "shared-PPROD"
                      if str(my_env) == "prod" :
                          releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper()
                  
                      ## set isRelease variable dynamically
                      if "SNAPSHOT" in '${release_version}':
                          releaseVariables['ext_isRelease'] = "false"
                          releaseVariables['version'] = "SNAPSHOT"
                      else:
                          releaseVariables['ext_isRelease'] = "true"
                          releaseVariables['version'] = "RELEASE"
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  for component in sas_list:
                      ##Create task
                      extra_vars = str(component) + "_extra_vars"
                      print releaseVariables[extra_vars]
                  
                      myenv = phase_name
                      my_env = myenv[0:3]
                  
                      taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                  
                      ##delete deploy task if we are in a copied phase
                  
                      if ${previous_lane} != 0:
                         taskUpdateReleaseIds.title = 'deploy ' + '${deploy}' + " " + 'on ' + str(my_env) + '0${previous_lane}'
                         TaskToDel_list = getTasksByTitle(taskUpdateReleaseIds.title, phaseTitle = phase_name)
                         TaskToDel = TaskToDel_list[0]
                         taskApi.delete(TaskToDel.id)
                         releaseVariables['previous_lane'] = ${ext_chainNum}
                      else:
                          releaseVariables['previous_lane'] = ${ext_chainNum}
                  
                      #creation of deployment task
                      taskUpdateReleaseIds.title = 'deploy ' + '${deploy}' + " " + 'on ' + str(my_env) + '${ext_chainNum}'
                      taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                      taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                      taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                      taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables[extra_vars])
                      taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                      ##Add task in sequential group
                      taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöÄ DEPLOY GROUP
                type: xlrelease.SequentialGroup
          - name: Wanna do to deploy in other chain ?
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            team: Release User
            variables:
              - deployintonewchain
          - name: Duplicate Phase
            type: xlrelease.ScriptTask
            script: |-
              phase = getCurrentPhase()
              phase_name = phase.title
              
              
              if releaseVariables['deployintonewchain'] == 'yes':
              
                newphase = phaseApi.copyPhase(phase.id,releaseVariables['incrementation'] )
              
              
                listofdynamicsvars = taskApi.searchTasksByTitle('SET ENV & AAP VARIABLES', newphase.title , release.id)
                setVars = listofdynamicsvars[0]
                setVars.setProperty("script", releaseVariables['set_vars_script'])
                taskApi.updateTask(setVars)
              
              
                listofdynamicsvars = taskApi.searchTasksByTitle('Get AAP Resources Ids task generator', newphase.title , release.id)
                setVars = listofdynamicsvars[0]
                setVars.setProperty("script", releaseVariables['get_ressources_script'])
                taskApi.updateTask(setVars)
              
              
                ####get set cred artifacts
                listofsetCreds = taskApi.searchTasksByTitle('Set Credential task generator', newphase.title , release.id)
                setCreds = listofsetCreds[0]
                setCreds.setProperty("script", releaseVariables['set_creds_script'])
                taskApi.updateTask(setCreds)
              
                listofdynamicsvars = taskApi.searchTasksByTitle('Update AAP Resources task generator', newphase.title , release.id)
                setVars = listofdynamicsvars[0]
                setVars.setProperty("script", releaseVariables['update_ressources_script'])
                taskApi.updateTask(setVars)
              
                listofduplicatephase = taskApi.searchTasksByTitle('Deploy task generator', newphase.title , release.id)
                duplicatephase = listofduplicatephase[0]
                duplicatephase.setProperty("script", releaseVariables['deployment_script'])
                taskApi.updateTask(duplicatephase)
              
                ##update next phase
                newphase.title = phase.title
                phaseApi.updatePhase(newphase)
              
              
              
              
              else:
                releaseVariables['previous_lane'] = 0
              
              
              
              #current_phase = phaseApi.getPhase(phase.id)
              #current_phase.title = current_phase.title
              
              
              #  phase.title = phase.title + " " + ext_chainNum
              #phaseApi.updatePhase(current_phase)
              myenv = phase_name
              my_env = myenv[0:3]
              phase.title = my_env + " " + releaseVariables['ext_chainNum']
              phaseApi.updatePhase(phase)
        color: "#3d6c9e"
      - phase: ppd
        tasks:
          - name: üë®‚ÄçüöÄ SET COULOIR
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            team: Release Admin
            variables:
              - ext_chainNum
          - name: SET ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              ####get the environement variable : int / rec / ppd/ prd ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              
              releaseVariables['incrementation'] = releaseVariables['incrementation'] + 1
              
              myenv = phase_name
              
              if myenv == "ppd":
                  envc = "x"
              else:
              
              ##set envc variable from envir
                  envc = myenv[0]
              releaseVariables['ext_envc'] = envc
              envd = envc.upper()
              releaseVariables['ext_envd'] = envd
              
              ##set env variable from phase_name
              if str(myenv) == "int":
                  releaseVariables['ext_environnement'] = "Integration"
                  releaseVariables['env'] = "HORSPROD"
              if str(myenv) == "rec":
                  releaseVariables['ext_environnement'] = "Recette"
                  releaseVariables['env'] = "ISOPROD"
              if str(myenv) == "ppd":
                  releaseVariables['ext_environnement'] = "PreProduction"
                  releaseVariables['env'] = "PROD"
              if str(myenv) == "prd":
                  releaseVariables['ext_environnement'] = "Production"
                  releaseVariables['env'] = "PROD"
              
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              ## AAP Project
              project = "p-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}'
              var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
              var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
              releaseVariables[var_poject_name] = project
              releaseVariables[var_poject_id] = ""
              
              print str(myenv)
              ## Set AAP Inventories
              if str(myenv) == "rec":
                  rec_chainNum = '${ext_chainNum}'
                  if map(int,str(rec_chainNum))[0] == 0:
                      ext_chainNum = rec_chainNum[1]
                  else:
                      ext_chainNum = rec_chainNum
              
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(myenv).upper() + str(ext_chainNum)
              else:
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(myenv).upper()
              
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(myenv) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(myenv) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              my_env = myenv[0:3]
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = my_env + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: Deletion prod phase if snapshot
            type: xlrelease.ScriptTask
            precondition: "releaseVariables['ext_isRelease'] == 'false'"
            script: |-
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              
              release = getCurrentRelease()
              listofppdphases = phaseApi.searchPhasesByTitle('ppd',release.id)
              listofprodphases = phaseApi.searchPhasesByTitle('prod',release.id)
              
              
              if listofprodphases or listofppdphases :
               ###get the prod and pprod phase ##
               prodphase = listofprodphases[0]
               pprodphase = listofppdphases[0]
              
               ###delete those phases ####
               phaseApi.deletePhase(prodphase.id)
               phaseApi.deletePhase(pprodphase.id)
          - name: ‚ö° SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES IDs
                type: xlrelease.SequentialGroup
                tasks:
                  - name: Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                              taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                              taskCheckResource.pythonScript.setProperty("method", 'GET')
                              taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskCheckResource.setTaskFailureHandlerEnabled(True)
                              taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskCheckResource.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskCheckResource)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: Set Credential task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + "organizations":
                              organization_id = obj.value
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                              resource_id = obj.value
                              var_name = obj.key
                              resource_type = var_name.split('-')[-1]
                          if obj.key == "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                              resource_name = obj.value
                              credential_type = '24'
                      body = "\"" + "name" + "\"" + ": " + "\"" + str(resource_name) + "\"" + ", " + "\"" + "organization" + "\"" + ": " + str(organization_id) + ", " + "\"" + "credential_type" + "\"" + ": " + str(credential_type) + ", " + "\"" + "inputs" + "\"" + ": { " + "\"" + "artifact_user" + "\"" + ": " + "\"" + "$" + "{" + "user" + "}" + "\"" + ", " + "\"" + "artifact_password" + "\"" + ": " + "\"" + "$" + "{" + "password" + "}" + "\"" + "}"
                      
                      
                      api_put_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                      taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                      taskUpdateResource.pythonScript.setProperty("URL", api_put_url)
                      taskUpdateResource.pythonScript.setProperty("method", 'PUT')
                      taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                      taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                      taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                      taskUpdateResource.title = "Set credential " + " " + str(resource_name)
                      taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      if "socle" in '${deploy}':
                          playbook = 'deploy_wlc_socle_1T.yml'
                      else:
                          playbook = 'deploy_wlc_appli_1T.yml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "update " + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
                  from com.xebialabs.xlrelease.api.v1.forms import Variable
                  from com.xebialabs.xlrelease.api.v1 import PhaseApi
                  
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  ##get modules to deploy
                  sas_list=releaseVariables['modules_todeploy']
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  if '${deploy}' == "application":
                      myenv = phase_name
                      my_env = myenv[0:3]
                      if str(my_env) == "int" or str(my_env) == "rec":
                          releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper() + "-" + releaseVariables['ext_chainNum']
                      if str(my_env) == "ppd" :
                          releaseVariables['ext_sharedLibEnv'] = "shared-PPROD"
                      if str(my_env) == "prod" :
                          releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper()
                  
                      ## set isRelease variable dynamically
                      if "SNAPSHOT" in '${release_version}':
                          releaseVariables['ext_isRelease'] = "false"
                          releaseVariables['version'] = "SNAPSHOT"
                      else:
                          releaseVariables['ext_isRelease'] = "true"
                          releaseVariables['version'] = "RELEASE"
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  for component in sas_list:
                      ##Create task
                      extra_vars = str(component) + "_extra_vars"
                      print releaseVariables[extra_vars]
                  
                      myenv = phase_name
                      my_env = myenv[0:3]
                  
                      taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                  
                      ##delete deploy task if we are in a copied phase
                  
                      if ${previous_lane} != 0:
                         taskUpdateReleaseIds.title = 'deploy ' + '${deploy}' + " " + 'on ' + str(my_env) + '0${previous_lane}'
                         TaskToDel_list = getTasksByTitle(taskUpdateReleaseIds.title, phaseTitle = phase_name)
                         TaskToDel = TaskToDel_list[0]
                         taskApi.delete(TaskToDel.id)
                         releaseVariables['previous_lane'] = ${ext_chainNum}
                      else:
                          releaseVariables['previous_lane'] = ${ext_chainNum}
                  
                      #creation of deployment task
                      taskUpdateReleaseIds.title = 'deploy ' + '${deploy}' + " " + 'on ' + str(my_env) + '${ext_chainNum}'
                      taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                      taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                      taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                      taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables[extra_vars])
                      taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                      ##Add task in sequential group
                      taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöÄ DEPLOY GROUP
                type: xlrelease.SequentialGroup
          - name: Wanna do to deploy in other chain ?
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            team: Release Admin
            variables:
              - deployintonewchain
          - name: Duplicate Phase
            type: xlrelease.ScriptTask
            script: |-
              phase = getCurrentPhase()
              phase_name = phase.title
              
              
              if releaseVariables['deployintonewchain'] == 'yes':
              
                newphase = phaseApi.copyPhase(phase.id,releaseVariables['incrementation'] )
              
              
                listofdynamicsvars = taskApi.searchTasksByTitle('SET ENV & AAP VARIABLES', newphase.title , release.id)
                setVars = listofdynamicsvars[0]
                setVars.setProperty("script", releaseVariables['set_vars_script'])
                taskApi.updateTask(setVars)
              
              
                listofdynamicsvars = taskApi.searchTasksByTitle('Get AAP Resources Ids task generator', newphase.title , release.id)
                setVars = listofdynamicsvars[0]
                setVars.setProperty("script", releaseVariables['get_ressources_script'])
                taskApi.updateTask(setVars)
              
              
                ####get set cred artifacts
                listofsetCreds = taskApi.searchTasksByTitle('Set Credential task generator', newphase.title , release.id)
                setCreds = listofsetCreds[0]
                setCreds.setProperty("script", releaseVariables['set_creds_script'])
                taskApi.updateTask(setCreds)
              
                listofdynamicsvars = taskApi.searchTasksByTitle('Update AAP Resources task generator', newphase.title , release.id)
                setVars = listofdynamicsvars[0]
                setVars.setProperty("script", releaseVariables['update_ressources_script'])
                taskApi.updateTask(setVars)
              
                listofduplicatephase = taskApi.searchTasksByTitle('Deploy task generator', newphase.title , release.id)
                duplicatephase = listofduplicatephase[0]
                duplicatephase.setProperty("script", releaseVariables['deployment_script'])
                taskApi.updateTask(duplicatephase)
              
                ##update next phase
                newphase.title = phase.title
                phaseApi.updatePhase(newphase)
              
              
              
              
              else:
                releaseVariables['previous_lane'] = 0
              
              
              
              #current_phase = phaseApi.getPhase(phase.id)
              #current_phase.title = current_phase.title
              
              
              #  phase.title = phase.title + " " + ext_chainNum
              #phaseApi.updatePhase(current_phase)
              myenv = phase_name
              my_env = myenv[0:3]
              phase.title = my_env + " " + releaseVariables['ext_chainNum']
              phaseApi.updatePhase(phase)
        color: "#3d6c9e"
      - phase: prd
        tasks:
          - name: üë®‚ÄçüöÄ SET COULOIR
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            team: Release Admin
            variables:
              - ext_chainNum
          - name: SET ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              ####get the environement variable : int / rec / ppd/ prd ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              
              releaseVariables['incrementation'] = releaseVariables['incrementation'] + 1
              
              myenv = phase_name
              
              if myenv == "ppd":
                  envc = "x"
              else:
              
              ##set envc variable from envir
                  envc = myenv[0]
              releaseVariables['ext_envc'] = envc
              envd = envc.upper()
              releaseVariables['ext_envd'] = envd
              
              ##set env variable from phase_name
              if str(myenv) == "int":
                  releaseVariables['ext_environnement'] = "Integration"
                  releaseVariables['env'] = "HORSPROD"
              if str(myenv) == "rec":
                  releaseVariables['ext_environnement'] = "Recette"
                  releaseVariables['env'] = "ISOPROD"
              if str(myenv) == "ppd":
                  releaseVariables['ext_environnement'] = "PreProduction"
                  releaseVariables['env'] = "PROD"
              if str(myenv) == "prd":
                  releaseVariables['ext_environnement'] = "Production"
                  releaseVariables['env'] = "PROD"
              
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              ## AAP Project
              project = "p-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}'
              var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
              var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
              releaseVariables[var_poject_name] = project
              releaseVariables[var_poject_id] = ""
              
              print str(myenv)
              ## Set AAP Inventories
              if str(myenv) == "rec":
                  rec_chainNum = '${ext_chainNum}'
                  if map(int,str(rec_chainNum))[0] == 0:
                      ext_chainNum = rec_chainNum[1]
                  else:
                      ext_chainNum = rec_chainNum
              
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(myenv).upper() + str(ext_chainNum)
              else:
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(myenv).upper()
              
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(myenv) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(myenv) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              my_env = myenv[0:3]
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = my_env + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: ‚ö° SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES IDs
                type: xlrelease.SequentialGroup
                tasks:
                  - name: Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                              taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                              taskCheckResource.pythonScript.setProperty("method", 'GET')
                              taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskCheckResource.setTaskFailureHandlerEnabled(True)
                              taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskCheckResource.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskCheckResource)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: Set Credential task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + "organizations":
                              organization_id = obj.value
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                              resource_id = obj.value
                              var_name = obj.key
                              resource_type = var_name.split('-')[-1]
                          if obj.key == "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                              resource_name = obj.value
                              credential_type = '24'
                      body = "\"" + "name" + "\"" + ": " + "\"" + str(resource_name) + "\"" + ", " + "\"" + "organization" + "\"" + ": " + str(organization_id) + ", " + "\"" + "credential_type" + "\"" + ": " + str(credential_type) + ", " + "\"" + "inputs" + "\"" + ": { " + "\"" + "artifact_user" + "\"" + ": " + "\"" + "$" + "{" + "user" + "}" + "\"" + ", " + "\"" + "artifact_password" + "\"" + ": " + "\"" + "$" + "{" + "password" + "}" + "\"" + "}"
                      
                      
                      api_put_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                      taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                      taskUpdateResource.pythonScript.setProperty("URL", api_put_url)
                      taskUpdateResource.pythonScript.setProperty("method", 'PUT')
                      taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                      taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                      taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                      taskUpdateResource.title = "Set credential " + " " + str(resource_name)
                      taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      if "socle" in '${deploy}':
                          playbook = 'deploy_wlc_socle_1T.yml'
                      else:
                          playbook = 'deploy_wlc_appli_1T.yml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "update " + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
                  from com.xebialabs.xlrelease.api.v1.forms import Variable
                  from com.xebialabs.xlrelease.api.v1 import PhaseApi
                  
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  ##get modules to deploy
                  sas_list=releaseVariables['modules_todeploy']
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  if '${deploy}' == "application":
                      myenv = phase_name
                      my_env = myenv[0:3]
                      if str(my_env) == "int" or str(my_env) == "rec":
                          releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper() + "-" + releaseVariables['ext_chainNum']
                      if str(my_env) == "ppd" :
                          releaseVariables['ext_sharedLibEnv'] = "shared-PPROD"
                      if str(my_env) == "prod" :
                          releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper()
                  
                      ## set isRelease variable dynamically
                      if "SNAPSHOT" in '${release_version}':
                          releaseVariables['ext_isRelease'] = "false"
                          releaseVariables['version'] = "SNAPSHOT"
                      else:
                          releaseVariables['ext_isRelease'] = "true"
                          releaseVariables['version'] = "RELEASE"
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  for component in sas_list:
                      ##Create task
                      extra_vars = str(component) + "_extra_vars"
                      print releaseVariables[extra_vars]
                  
                      myenv = phase_name
                      my_env = myenv[0:3]
                  
                      taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                  
                      ##delete deploy task if we are in a copied phase
                  
                      if ${previous_lane} != 0:
                         taskUpdateReleaseIds.title = 'deploy ' + '${deploy}' + " " + 'on ' + str(my_env) + '0${previous_lane}'
                         TaskToDel_list = getTasksByTitle(taskUpdateReleaseIds.title, phaseTitle = phase_name)
                         TaskToDel = TaskToDel_list[0]
                         taskApi.delete(TaskToDel.id)
                         releaseVariables['previous_lane'] = ${ext_chainNum}
                      else:
                          releaseVariables['previous_lane'] = ${ext_chainNum}
                  
                      #creation of deployment task
                      taskUpdateReleaseIds.title = 'deploy ' + '${deploy}' + " " + 'on ' + str(my_env) + '${ext_chainNum}'
                      taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                      taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                      taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                      taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables[extra_vars])
                      taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                      ##Add task in sequential group
                      taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöÄ DEPLOY GROUP
                type: xlrelease.SequentialGroup
        color: "#3d6c9e"
    variables:
      - type: xlrelease.StringVariable
        key: AAP-name-organizations
        requiresValue: false
        showOnReleaseStart: false
        value: CARDIF_GDA-OPS
      - type: xlrelease.StringVariable
        key: pipeline
        requiresValue: false
        showOnReleaseStart: false
        value: cd_wlc_xlr
      - type: xlrelease.StringVariable
        key: scm_branch
        showOnReleaseStart: false
        value: del_index
      - type: xlrelease.StringVariable
        key: scm_url
        showOnReleaseStart: false
        label: Repo git url
        value: https://gitlab-dogen.group.echonet/Retail/cardif/moe_carat/e0511_carat/cd_wlc_xlr.git
      - type: xlrelease.StringVariable
        key: user
        label: UID
      - type: xlrelease.PasswordStringVariable
        key: password
        label: password
      - type: xlrelease.StringVariable
        key: deploy
        requiresValue: false
        showOnReleaseStart: false
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - socle
            - application
        value: application
      - type: xlrelease.StringVariable
        key: release_version
        label: Version
      - type: xlrelease.StringVariable
        key: ext_envc
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: env
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ext_appVersion
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.ListStringVariable
        key: modules_todeploy
        requiresValue: false
        showOnReleaseStart: false
        label: biz and/or prez
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - biz
        value:
          - biz
      - type: xlrelease.StringVariable
        key: ext_env
        requiresValue: false
        showOnReleaseStart: false
        label: Environment
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - int
            - ppd
            - prod
            - rec
      - type: xlrelease.StringVariable
        key: ext_chainNum
        showOnReleaseStart: false
        label: couloir
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "01"
            - "02"
            - "03"
            - "04"
            - "05"
            - "06"
            - "07"
            - "08"
      - type: xlrelease.StringVariable
        key: ext_isRelease
        requiresValue: false
        showOnReleaseStart: false
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "true"
            - "false"
      - type: xlrelease.StringVariable
        key: playbook
        showOnReleaseStart: false
        label: create socle or deploy application
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - deploy
        value: deploy
      - type: xlrelease.StringVariable
        key: other_lane
        showOnReleaseStart: false
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "yes"
            - "no"
      - type: xlrelease.StringVariable
        key: ext_environnement
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ext_appLayer
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ansible_python_interpreter
        requiresValue: false
        showOnReleaseStart: false
        value: /usr/bin/python3
      - type: xlrelease.StringVariable
        key: ext_appenv
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ap_code
        requiresValue: false
        showOnReleaseStart: false
        value: "AP${codeAP}"
      - type: xlrelease.StringVariable
        key: owner_uid
        showOnReleaseStart: false
        label: Release Owner
        value: "${user}"
      - type: xlrelease.StringVariable
        key: codeAP
        requiresValue: false
        showOnReleaseStart: false
        value: "23882"
      - type: xlrelease.StringVariable
        key: trigram
        requiresValue: false
        showOnReleaseStart: false
        value: rat
      - type: xlrelease.StringVariable
        key: code5car
        requiresValue: false
        showOnReleaseStart: false
        value: rat00
      - type: xlrelease.StringVariable
        key: ext_projectID
        requiresValue: false
        showOnReleaseStart: false
        value: "1212"
      - type: xlrelease.StringVariable
        key: ext_artifactPath
        requiresValue: false
        showOnReleaseStart: false
        value: com/bnpcardif
      - type: xlrelease.StringVariable
        key: ext_artifactId
        requiresValue: false
        showOnReleaseStart: false
        value: "maven-${version}"
      - type: xlrelease.StringVariable
        key: ext_ear_binary_url
        requiresValue: false
        showOnReleaseStart: false
        value: NONE
      - type: xlrelease.StringVariable
        key: ext_sharedLib_binary_url
        requiresValue: false
        showOnReleaseStart: false
        value: NONE
      - type: xlrelease.StringVariable
        key: ext_sharedLibEnv
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: biz_ModuleName
        requiresValue: false
        showOnReleaseStart: false
        value: carat_SERV_EAR
      - type: xlrelease.StringVariable
        key: biz_sharedModuleName
        requiresValue: false
        showOnReleaseStart: false
        value: carat_SERV_EAR
      - type: xlrelease.StringVariable
        key: biz_modlib
        requiresValue: false
        showOnReleaseStart: false
        value: carat
      - type: xlrelease.StringVariable
        key: biz_contextRoot
        requiresValue: false
        showOnReleaseStart: false
        value: /
      - type: xlrelease.StringVariable
        key: biz_jvmClassLoader
        requiresValue: false
        showOnReleaseStart: false
        value: ParentFirst
      - type: xlrelease.StringVariable
        key: biz_alterconfig
        requiresValue: false
        showOnReleaseStart: false
        value: "yes"
      - type: xlrelease.StringVariable
        key: biz_xcaliaResource
        requiresValue: false
        showOnReleaseStart: false
        value: "no"
      - type: xlrelease.StringVariable
        key: biz_autoExpand
        requiresValue: false
        showOnReleaseStart: false
        value: "false"
      - type: xlrelease.StringVariable
        key: biz_jndiEntry
        requiresValue: false
        showOnReleaseStart: false
        value: "no"
      - type: xlrelease.StringVariable
        key: biz_jndiEntryList
        requiresValue: false
        showOnReleaseStart: false
        value: "[{'name': 'string', 'value': 'string'}, {'name': 'string', 'value': 'string'}]"
      - type: xlrelease.StringVariable
        key: biz_safResource
        requiresValue: false
        showOnReleaseStart: false
        value: "no"
      - type: xlrelease.StringVariable
        key: biz_jvmEnabledFeaturesList
        requiresValue: false
        showOnReleaseStart: false
        value: "[{'name': 'localConnector-1.0'}, {'name': 'el-3.0'}, {'name': 'jdbc-4.1'},\
      \ {'name': 'jsp-2.3'}, {'name': 'jndi-1.0'}, {'name': 'servlet-3.1'}, {'name':\
      \ 'transportSecurity-1.0'}, {'name': 'concurrent-1.0'}, {'name': 'javaMail-1.5'},\
      \ {'name': 'beanValidation-1.1'}]"
      - type: xlrelease.StringVariable
        key: biz_ext_appLayer
        requiresValue: false
        showOnReleaseStart: false
        value: biz
      - type: xlrelease.MapStringStringVariable
        key: biz_extra_vars
        requiresValue: false
        showOnReleaseStart: false
        value:
          ext_artifactId: "${ext_artifactId}"
          biz_jvmClassLoader: "${biz_jvmClassLoader}"
          biz_alterconfig: "${biz_alterconfig}"
          biz_jvmEnabledFeaturesList: "${biz_jvmEnabledFeaturesList}"
          env: "${env}"
          ap_code: "${ap_code}"
          ext_environnement: "${ext_environnement}"
          ext_sharedLib_binary_url: "${ext_sharedLib_binary_url}"
          trigram: "${trigram}"
          ext_isRelease: "${ext_isRelease}"
          ext_ear_binary_url: "${ext_ear_binary_url}"
          ext_appVersion: "${release_version}"
          biz_autoExpand: "${biz_autoExpand}"
          ext_chainNum: "${ext_chainNum}"
          biz_modlib: "${biz_modlib}"
          ext_artifactPath: "${ext_artifactPath}"
          biz_jndiEntryList: "${biz_jndiEntryList}"
          ext_projectID: "${ext_projectID}"
          ext_appenv: "${ext_appenv}"
          ansible_python_interpreter: "${ansible_python_interpreter}"
          biz_jndiEntry: "${biz_jndiEntry}"
          code5car: "${code5car}"
          biz_safResource: "${biz_safResource}"
          ext_sharedLibEnv: "${ext_sharedLibEnv}"
          ext_appLayer: "${biz_ext_appLayer}"
          biz_contextRoot: "${biz_contextRoot}"
          biz_ModuleName: "${biz_ModuleName}"
          biz_xcaliaResource: "${biz_xcaliaResource}"
          biz_sharedModuleName: "${biz_sharedModuleName}"
          codeAP: "${codeAP}"
      - type: xlrelease.StringVariable
        key: version
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ext_envnew
        requiresValue: false
        showOnReleaseStart: false
        label: Script
        description: Script
      - type: xlrelease.StringVariable
        key: deployintonewchain
        showOnReleaseStart: false
        label: Deployer dans un autre couloir
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "yes"
            - "no"
      - type: xlrelease.StringVariable
        key: artifact_user
        showOnReleaseStart: false
        label: Owner
        description: The owner of the item.
      - type: xlrelease.IntegerVariable
        key: incrementation
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: set_vars_script
        requiresValue: false
        showOnReleaseStart: false
        value: |-
          #This action automatically generates create release tasks according to the number of delivery units to deploy
          
          
          
          from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
          from com.xebialabs.xlrelease.api.v1.forms import Variable
          from com.xebialabs.xlrelease.api.v1 import PhaseApi
          
          ####get the environement variable : int / rec / ppd/ prd ###
          phase = getCurrentPhase()
          current_phase = phaseApi.getPhase(phase.id)
          phase_name = current_phase.title
          
          releaseVariables['incrementation'] = releaseVariables['incrementation'] + 1
          
          myenv = phase_name
          
          if myenv == "ppd":
              envc = "x"
          else:
          
          ##set envc variable from envir
              envc = myenv[0]
          releaseVariables['ext_envc'] = envc
          envd = envc.upper()
          releaseVariables['ext_envd'] = envd
          
          ##set env variable from phase_name
          if str(myenv) == "int":
              releaseVariables['ext_environnement'] = "Integration"
              releaseVariables['env'] = "HORSPROD"
          if str(myenv) == "rec":
              releaseVariables['ext_environnement'] = "Recette"
              releaseVariables['env'] = "ISOPROD"
          if str(myenv) == "ppd":
              releaseVariables['ext_environnement'] = "PreProduction"
              releaseVariables['env'] = "PROD"
          if str(myenv) == "prd":
              releaseVariables['ext_environnement'] = "Production"
              releaseVariables['env'] = "PROD"
          
          
          
          ## Set AAP resources
          
          ## AAP Organization
          var_orga_id = "AAP-id-" + "organizations"
          releaseVariables[var_orga_id] = ""
          
          ## AAP Artifactory credential
          atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
          var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
          var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
          releaseVariables[var_cred_name] = atifactory_cred
          releaseVariables[var_cred_id] = ""
          
          ## AAP Job templates
          job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
          var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
          var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
          releaseVariables[var_job_template_name] = job_template
          releaseVariables[var_job_template_id] = ""
          
          ## AAP Project
          project = "p-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}'
          var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
          var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
          releaseVariables[var_poject_name] = project
          releaseVariables[var_poject_id] = ""
          
          print str(myenv)
          ## Set AAP Inventories
          if str(myenv) == "rec":
              rec_chainNum = '${ext_chainNum}'
              if map(int,str(rec_chainNum))[0] == 0:
                  ext_chainNum = rec_chainNum[1]
              else:
                  ext_chainNum = rec_chainNum
          
              inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(myenv).upper() + str(ext_chainNum)
          else:
              inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(myenv).upper()
          
          var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(myenv) + "-inventories"
          var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(myenv) + "-inventories"
          releaseVariables[var_inventory_name] = inventory
          releaseVariables[var_inventory_id] = ""
          
          ## Phase rename
          my_env = myenv[0:3]
          release = getCurrentRelease()
          phase = getCurrentPhase()
          phase.title = my_env
          phaseApi.updatePhase(phase)
        multiline: true
      - type: xlrelease.StringVariable
        key: get_ressources_script
        requiresValue: false
        showOnReleaseStart: false
        value: |-
          from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
          
          
          ## get id of sequential group to insert tasks into & Delete tasks if present
          sequentialGroupId = None
          parenttask = getCurrentTask().container
          for child in parenttask.getAllTasks():
              if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                  sequentialGroupId = child.id
              if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                  taskApi.delete(child.id)
          
          
          ## get all release variables into list
          varList = releaseApi.getVariables(release.id)
          
          ##create JsonWebhook tasks to get the ID of the AAP resources
          for obj in varList:
              if "AAP-name" in obj.key:
                 resource = obj.value
                 var_name = obj.key
                 type = var_name.split('-')[-1]
                 var_resourceId = var_name.replace("name", "id")
                 if releaseVariables[var_resourceId] == "":
                  api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                  taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                  taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                  taskCheckResource.pythonScript.setProperty("method", 'GET')
                  taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                  taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                  taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                  taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                  taskCheckResource.setTaskFailureHandlerEnabled(True)
                  taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                  taskCheckResource.title = "get " + str(type) + " " + str(resource)
                  taskApi.addTask(sequentialGroupId, taskCheckResource)
        multiline: true
      - type: xlrelease.StringVariable
        key: set_creds_script
        requiresValue: false
        showOnReleaseStart: false
        value: |-
          ## get id of sequential group to insert tasks into & Delete tasks if present
          sequentialGroupId = None
          parenttask = getCurrentTask().container
          for child in parenttask.getAllTasks():
              if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                  sequentialGroupId = child.id
              if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                  taskApi.delete(child.id)
          
          ## get all release variables into list
          varList = releaseApi.getVariables(release.id)
          
          
          for obj in varList:
              if obj.key == "AAP-id-" + "organizations":
                  organization_id = obj.value
              if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                  resource_id = obj.value
                  var_name = obj.key
                  resource_type = var_name.split('-')[-1]
              if obj.key == "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                  resource_name = obj.value
                  credential_type = '24'
          body = "\"" + "name" + "\"" + ": " + "\"" + str(resource_name) + "\"" + ", " + "\"" + "organization" + "\"" + ": " + str(organization_id) + ", " + "\"" + "credential_type" + "\"" + ": " + str(credential_type) + ", " + "\"" + "inputs" + "\"" + ": { " + "\"" + "artifact_user" + "\"" + ": " + "\"" + "$" + "{" + "user" + "}" + "\"" + ", " + "\"" + "artifact_password" + "\"" + ": " + "\"" + "$" + "{" + "password" + "}" + "\"" + "}"
          
          
          api_put_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
          taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
          taskUpdateResource.pythonScript.setProperty("URL", api_put_url)
          taskUpdateResource.pythonScript.setProperty("method", 'PUT')
          taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
          taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
          taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
          taskUpdateResource.title = "Set credential " + " " + str(resource_name)
          taskApi.addTask(sequentialGroupId, taskUpdateResource)
        multiline: true
      - type: xlrelease.StringVariable
        key: update_ressources_script
        requiresValue: false
        showOnReleaseStart: false
        value: |-
          ####get phase name ###
          phase = getCurrentPhase()
          current_phase = phaseApi.getPhase(phase.id)
          phase_name = current_phase.title
          
          
          ## get id of sequential group to insert tasks into & Delete tasks if present
          sequentialGroupId = None
          parenttask = getCurrentTask().container
          for child in parenttask.getAllTasks():
              if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                  sequentialGroupId = child.id
              if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                  taskApi.delete(child.id)
          
          ## Set variables for project update
          scm_url = '${scm_url}'
          scm_branch = '${scm_branch}'
          
          ## Set variables for job_templae update
          if "socle" in '${deploy}':
              playbook = 'deploy_wlc_socle_1T.yml'
          else:
              playbook = 'deploy_wlc_appli_1T.yml'
          
          ## get all release variables into list
          varList = releaseApi.getVariables(release.id)
          
          
          for obj in varList:
              if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                  resource_id = obj.value
                  resource_name = obj.key
                  resource_type = resource_name.split('-')[-1]
                  if "projects" in obj.key:
                      body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\""
                  if "job_templates" in obj.key:
                      body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
          
                  api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                  taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                  taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                  taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                  taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                  taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                  taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                  taskUpdateResource.title = "update " + " " + str(resource_name)
                  taskApi.addTask(sequentialGroupId, taskUpdateResource)
        multiline: true
      - type: xlrelease.StringVariable
        key: deployment_script
        requiresValue: false
        showOnReleaseStart: false
        value: "from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable,\
      \ MapStringStringVariable, PasswordStringVariable\nfrom com.xebialabs.xlrelease.api.v1.forms\
      \ import Variable\nfrom com.xebialabs.xlrelease.api.v1 import PhaseApi\n\nreleaseId\
      \ = getCurrentRelease().id\n\n## Set AAP Server env\nlistFolder = releaseId.split('/')\n\
      FolderId = listFolder[1]\nServerName = \"devopstc-ansibleAutomation-\" + '${env}'\n\
      aap_server_config = configurationApi.searchByTypeAndTitle(\"ansibletower.Server\"\
      ,str(ServerName), FolderId)[0]\n\n##get modules to deploy\nsas_list=releaseVariables['modules_todeploy']\n\
      \nphase = getCurrentPhase()\ncurrent_phase = phaseApi.getPhase(phase.id)\nphase_name\
      \ = current_phase.title\n\nif '${deploy}' == \"application\":\n    myenv = phase_name\n\
      \    my_env = myenv[0:3]\n    if str(my_env) == \"int\" or str(my_env) == \"\
      rec\":\n        releaseVariables['ext_sharedLibEnv'] = \"shared-\" + my_env.upper()\
      \ + \"-\" + releaseVariables['ext_chainNum']\n    if str(my_env) == \"ppd\"\
      \ :\n        releaseVariables['ext_sharedLibEnv'] = \"shared-PPROD\"\n    if\
      \ str(my_env) == \"prod\" :\n        releaseVariables['ext_sharedLibEnv'] =\
      \ \"shared-\" + my_env.upper()\n\n    ## set isRelease variable dynamically\n\
      \    if \"SNAPSHOT\" in '${release_version}':\n        releaseVariables['ext_isRelease']\
      \ = \"false\"\n        releaseVariables['version'] = \"SNAPSHOT\"\n    else:\n\
      \        releaseVariables['ext_isRelease'] = \"true\"\n        releaseVariables['version']\
      \ = \"RELEASE\"\n\n## get id of sequential group to insert tasks into\nsequentialGroupId\
      \ = None\nparenttask = getCurrentTask().container\nfor child in parenttask.getChildren():\n\
      \    if str(child.type).lower() == \"xlrelease.SequentialGroup\".lower():\n\
      \        sequentialGroupId = child.id\n    if str(child.type).lower() == \"\
      ansibletower.launchAndWait\".lower():\n        taskApi.delete(child.id)\n\n\
      #Set AAP resources Ids\nvarList = releaseApi.getVariables(release.id)\n\nfor\
      \ obj in varList:\n    if \"AAP-id\" in obj.key and \"credentials\" in obj.key:\n\
      \        credential_id = obj.value\n    if \"AAP-id\" in obj.key and \"job_templates\"\
      \ in obj.key:\n        job_template_id = obj.value\n    if \"AAP-id\" in obj.key\
      \ and \"inventories\" in obj.key:\n        inventory_id = obj.value\n\nfor component\
      \ in sas_list:\n    ##Create task\n    extra_vars = str(component) + \"_extra_vars\"\
      \n    print releaseVariables[extra_vars]\n    \n    myenv = phase_name\n   \
      \ my_env = myenv[0:3]\n    \n    taskUpdateReleaseIds = taskApi.newTask(\"ansibletower.launchAndWait\"\
      )\n    \n    ##delete deploy task if we are in a copied phase\n    \n    if\
      \ ${previous_lane} != 0:\n       taskUpdateReleaseIds.title = 'deploy ' + '${deploy}'\
      \ + \" \" + 'on ' + str(my_env) + '0${previous_lane}'\n       TaskToDel_list\
      \ = getTasksByTitle(taskUpdateReleaseIds.title, phaseTitle = phase_name)\n \
      \      TaskToDel = TaskToDel_list[0]\n       taskApi.delete(TaskToDel.id)\n\
      \       releaseVariables['previous_lane'] = ${ext_chainNum}\n    else:\n   \
      \     releaseVariables['previous_lane'] = ${ext_chainNum}\n        \n    #creation\
      \ of deployment task \n    taskUpdateReleaseIds.title = 'deploy ' + '${deploy}'\
      \ + \" \" + 'on ' + str(my_env) + '${ext_chainNum}'\n    taskUpdateReleaseIds.pythonScript.setProperty(\"\
      ansibletower\", aap_server_config)\n    taskUpdateReleaseIds.pythonScript.setProperty(\"\
      job_template_id\",job_template_id)\n    taskUpdateReleaseIds.pythonScript.setProperty(\"\
      inventory\",inventory_id)\n    taskUpdateReleaseIds.pythonScript.setProperty(\"\
      extra_vars\", releaseVariables[extra_vars])\n    taskUpdateReleaseIds.pythonScript.setProperty(\"\
      credentials\", credential_id)\n    \n    \n    ##Add task in sequential group\n\
      \    taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)"
        multiline: true
      - type: xlrelease.StringVariable
        key: previous_lane
        requiresValue: false
        showOnReleaseStart: false
        label: couloir precedent
        value: "0"
      - type: xlrelease.StringVariable
        key: duplicate_script
        requiresValue: false
        showOnReleaseStart: false
        value: "phase = getCurrentPhase()\nphase_name = phase.title\n\nnewphase = phaseApi.copyPhase(phase.id,releaseVariables['incrementation']\
      \ )\n\n\nif releaseVariables['deployintonewchain'] == 'yes':\n\n  newphase =\
      \ phaseApi.copyPhase(phase.id,releaseVariables['incrementation'] )\n  \n  \n\
      \  listofdynamicsvars = taskApi.searchTasksByTitle('SET ENV & AAP VARIABLES',\
      \ newphase.title , release.id)\n  setVars = listofdynamicsvars[0]\n  setVars.setProperty(\"\
      script\", releaseVariables['set_vars_script'])\n  taskApi.updateTask(setVars)\n\
      \  \n  \n  listofdynamicsvars = taskApi.searchTasksByTitle('Get AAP Resources\
      \ Ids task generator', newphase.title , release.id)\n  setVars = listofdynamicsvars[0]\n\
      \  setVars.setProperty(\"script\", releaseVariables['get_ressources_script'])\n\
      \  taskApi.updateTask(setVars)\n  \n  \n  ####get set cred artifacts\n  listofsetCreds\
      \ = taskApi.searchTasksByTitle('Set Credential task generator', newphase.title\
      \ , release.id)\n  setCreds = listofsetCreds[0]\n  setCreds.setProperty(\"script\"\
      , releaseVariables['set_creds_script'])\n  taskApi.updateTask(setCreds)\n\n\
      \  listofdynamicsvars = taskApi.searchTasksByTitle('Update AAP Resources task\
      \ generator', newphase.title , release.id)\n  setVars = listofdynamicsvars[0]\n\
      \  setVars.setProperty(\"script\", releaseVariables['update_ressources_script'])\n\
      \  taskApi.updateTask(setVars)\n\n  listofduplicatephase = taskApi.searchTasksByTitle('Deploy\
      \ task generator', newphase.title , release.id)\n  duplicatephase = listofduplicatephase[0]\n\
      \  duplicatephase.setProperty(\"script\", releaseVariables['deployment_script'])\n\
      \  taskApi.updateTask(duplicatephase)\n\n  ##update next phase\n  newphase.title\
      \ = phase.title\n  phaseApi.updatePhase(newphase)\n\n\n\n\nelse:\n  releaseVariables['previous_lane']\
      \ = 0\n\n\n\n#current_phase = phaseApi.getPhase(phase.id)\n#current_phase.title\
      \ = current_phase.title\n\n\n#  phase.title = phase.title + \" \" + ext_chainNum\n\
      #phaseApi.updatePhase(current_phase)\n\nphase.title = phase_name + \" \" + releaseVariables['ext_chainNum']\n\
      phaseApi.updatePhase(phase)"
        multiline: true
    allowPasswordsInAllFields: true
    disableNotifications: true
    scriptUsername: RunAsUser
    variableMapping:
      scriptUserPassword: "${global.RunAsUserPassword}"
    riskProfile: Default risk profile
  - template: cd-LibertyCore-AP23882-CARAT-DEPLOY EBX V6 deploy application - ok
    scheduledStartDate: 2023-07-26T09:00:00+02:00
    dueDate: 2023-07-26T10:00:00+02:00
    phases:
      - phase: "${ext_env}"
        tasks:
          - name: üë®‚ÄçüöÄ SET COULOIR
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            team: Release User
            variables:
              - ext_chainNum
          - name: üè≠ SET ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              ####get the environement variable : int / rec / ppd/ prd ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              
              myenv = '${ext_env}'
              if myenv == "ppd":
                  envc = "x"
              else:
              
              ##set envc variable from envir
                  envc = myenv[0]
              releaseVariables['ext_envc'] = envc
              envd = envc.upper()
              releaseVariables['ext_envd'] = envd
              
              ##set env variable from phase_name
              if str(myenv) == "int":
                  releaseVariables['ext_environnement'] = "Integration"
                  releaseVariables['env'] = "HORSPROD"
              if str(myenv) == "rec":
                  releaseVariables['ext_environnement'] = "Recette"
                  releaseVariables['env'] = "ISOPROD"
              if str(myenv) == "ppd":
                  releaseVariables['ext_environnement'] = "PreProduction"
                  releaseVariables['env'] = "PROD"
              if str(myenv) == "prd":
                  releaseVariables['ext_environnement'] = "Production"
                  releaseVariables['env'] = "PROD"
              
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              ## AAP Project
              project = "p-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}'
              var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
              var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
              releaseVariables[var_poject_name] = project
              releaseVariables[var_poject_id] = ""
              
              print str(myenv)
              ## Set AAP Inventories
              if str(myenv) == "rec":
                  rec_chainNum = '${ext_chainNum}'
                  if map(int,str(rec_chainNum))[0] == 0:
                      ext_chainNum = rec_chainNum[1]
                  else:
                      ext_chainNum = rec_chainNum
              
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(myenv).upper() + str(ext_chainNum)
              else:
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(myenv).upper()
              
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(myenv) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(myenv) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = str(phase_name) + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: ‚ö° SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES IDs
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                              taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                              taskCheckResource.pythonScript.setProperty("method", 'GET')
                              taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskCheckResource.setTaskFailureHandlerEnabled(True)
                              taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskCheckResource.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskCheckResource)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Set Credential task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + "organizations":
                              organization_id = obj.value
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                              resource_id = obj.value
                              var_name = obj.key
                              resource_type = var_name.split('-')[-1]
                          if obj.key == "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                              resource_name = obj.value
                              credential_type = '24'
                      body = "\"" + "name" + "\"" + ": " + "\"" + str(resource_name) + "\"" + ", " + "\"" + "organization" + "\"" + ": " + str(organization_id) + ", " + "\"" + "credential_type" + "\"" + ": " + str(credential_type) + ", " + "\"" + "inputs" + "\"" + ": { " + "\"" + "artifact_user" + "\"" + ": " + "\"" + "$" + "{" + "user" + "}" + "\"" + ", " + "\"" + "artifact_password" + "\"" + ": " + "\"" + "$" + "{" + "password" + "}" + "\"" + "}"
                      
                      
                      api_put_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                      taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                      taskUpdateResource.pythonScript.setProperty("URL", api_put_url)
                      taskUpdateResource.pythonScript.setProperty("method", 'PUT')
                      taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                      taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                      taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                      taskUpdateResource.title = "Set credential " + " " + str(resource_name)
                      taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      if "socle" in '${deploy}':
                          playbook = 'deploy_wlc_socle_1T.yml'
                      else:
                          playbook = 'deploy_wlc_appli_1T.yml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "update " + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Deploy task generator
                type: xlrelease.ScriptTask
                script: |-
                  from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
                  from com.xebialabs.xlrelease.api.v1.forms import Variable
                  from com.xebialabs.xlrelease.api.v1 import PhaseApi
                  
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  ##get modules to deploy
                  sas_list=releaseVariables['modules_todeploy']
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  if '${deploy}' == "application":
                      myenv = '${ext_env}'
                      my_env = myenv[0:3]
                      if str(my_env) == "int" or str(my_env) == "rec":
                          releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper() + "-" + releaseVariables['ext_chainNum']
                      if str(my_env) == "ppd" :
                          releaseVariables['ext_sharedLibEnv'] = "shared-PPROD"
                      if str(my_env) == "prod" :
                          releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper()
                  
                      ## set isRelease variable dynamically
                      if "SNAPSHOT" in '${release_version}':
                          releaseVariables['ext_isRelease'] = "false"
                          releaseVariables['version'] = "SNAPSHOT"
                      else:
                          releaseVariables['ext_isRelease'] = "true"
                          releaseVariables['version'] = "RELEASE"
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  for component in sas_list:
                      ##Create task
                      extra_vars = str(component) + "_extra_vars"
                      print releaseVariables[extra_vars]
                      taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                      taskUpdateReleaseIds.title = 'deploy ' + '${deploy}' + " " + 'on ' + '${ext_env}' + '${ext_chainNum}'
                      taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                      taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                      taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                      taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables[extra_vars])
                      taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                      ##Add task in sequential group
                      taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöÄ DEPLOY GROUP
                type: xlrelease.SequentialGroup
        color: "#3d6c9e"
    variables:
      - type: xlrelease.StringVariable
        key: AAP-name-organizations
        requiresValue: false
        showOnReleaseStart: false
        value: CARDIF_GDA-OPS
      - type: xlrelease.StringVariable
        key: pipeline
        requiresValue: false
        showOnReleaseStart: false
        value: cd_wlc_xlr
      - type: xlrelease.StringVariable
        key: scm_branch
        showOnReleaseStart: false
        value: del_index
      - type: xlrelease.StringVariable
        key: scm_url
        showOnReleaseStart: false
        label: Repo git url
        value: https://gitlab-dogen.group.echonet/Retail/cardif/moe_carat/e0511_carat/cd_wlc_xlr.git
      - type: xlrelease.StringVariable
        key: user
        label: UID
      - type: xlrelease.PasswordStringVariable
        key: password
        label: password
      - type: xlrelease.StringVariable
        key: deploy
        requiresValue: false
        showOnReleaseStart: false
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - socle
            - application
        value: application
      - type: xlrelease.StringVariable
        key: release_version
        label: Version
      - type: xlrelease.StringVariable
        key: ext_envc
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: env
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ext_appVersion
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.ListStringVariable
        key: modules_todeploy
        requiresValue: false
        showOnReleaseStart: false
        label: biz and/or prez
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - biz
        value:
          - biz
      - type: xlrelease.StringVariable
        key: ext_env
        label: Environment
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - int
            - ppd
            - prod
            - rec
      - type: xlrelease.StringVariable
        key: ext_chainNum
        showOnReleaseStart: false
        label: couloir
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "01"
            - "02"
            - "03"
            - "04"
      - type: xlrelease.StringVariable
        key: ext_isRelease
        requiresValue: false
        showOnReleaseStart: false
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "true"
            - "false"
      - type: xlrelease.StringVariable
        key: playbook
        showOnReleaseStart: false
        label: create socle or deploy application
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - deploy
        value: deploy
      - type: xlrelease.StringVariable
        key: other_lane
        showOnReleaseStart: false
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "yes"
            - "no"
      - type: xlrelease.StringVariable
        key: ext_environnement
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ext_appLayer
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ansible_python_interpreter
        requiresValue: false
        showOnReleaseStart: false
        value: /usr/bin/python3
      - type: xlrelease.StringVariable
        key: ext_appenv
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ap_code
        requiresValue: false
        showOnReleaseStart: false
        value: "AP${codeAP}"
      - type: xlrelease.StringVariable
        key: owner_uid
        showOnReleaseStart: false
        label: Release Owner
        value: "${user}"
      - type: xlrelease.StringVariable
        key: codeAP
        requiresValue: false
        showOnReleaseStart: false
        value: "23882"
      - type: xlrelease.StringVariable
        key: trigram
        requiresValue: false
        showOnReleaseStart: false
        value: rat
      - type: xlrelease.StringVariable
        key: code5car
        requiresValue: false
        showOnReleaseStart: false
        value: rat00
      - type: xlrelease.StringVariable
        key: ext_projectID
        requiresValue: false
        showOnReleaseStart: false
        value: "1212"
      - type: xlrelease.StringVariable
        key: ext_artifactPath
        requiresValue: false
        showOnReleaseStart: false
        value: com/bnpcardif
      - type: xlrelease.StringVariable
        key: ext_artifactId
        requiresValue: false
        showOnReleaseStart: false
        value: "maven-${version}"
      - type: xlrelease.StringVariable
        key: ext_ear_binary_url
        requiresValue: false
        showOnReleaseStart: false
        value: NONE
      - type: xlrelease.StringVariable
        key: ext_sharedLib_binary_url
        requiresValue: false
        showOnReleaseStart: false
        value: NONE
      - type: xlrelease.StringVariable
        key: ext_sharedLibEnv
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: biz_ModuleName
        requiresValue: false
        showOnReleaseStart: false
        value: carat_SERV_EAR
      - type: xlrelease.StringVariable
        key: biz_sharedModuleName
        requiresValue: false
        showOnReleaseStart: false
        value: carat_SERV_EAR
      - type: xlrelease.StringVariable
        key: biz_modlib
        requiresValue: false
        showOnReleaseStart: false
        value: carat
      - type: xlrelease.StringVariable
        key: biz_contextRoot
        requiresValue: false
        showOnReleaseStart: false
        value: /
      - type: xlrelease.StringVariable
        key: biz_jvmClassLoader
        requiresValue: false
        showOnReleaseStart: false
        value: ParentFirst
      - type: xlrelease.StringVariable
        key: biz_alterconfig
        requiresValue: false
        showOnReleaseStart: false
        value: "yes"
      - type: xlrelease.StringVariable
        key: biz_xcaliaResource
        requiresValue: false
        showOnReleaseStart: false
        value: "no"
      - type: xlrelease.StringVariable
        key: biz_autoExpand
        requiresValue: false
        showOnReleaseStart: false
        value: "false"
      - type: xlrelease.StringVariable
        key: biz_jndiEntry
        requiresValue: false
        showOnReleaseStart: false
        value: "no"
      - type: xlrelease.StringVariable
        key: biz_jndiEntryList
        requiresValue: false
        showOnReleaseStart: false
        value: "[{'name': 'string', 'value': 'string'}, {'name': 'string', 'value': 'string'}]"
      - type: xlrelease.StringVariable
        key: biz_safResource
        requiresValue: false
        showOnReleaseStart: false
        value: "no"
      - type: xlrelease.StringVariable
        key: biz_jvmEnabledFeaturesList
        requiresValue: false
        showOnReleaseStart: false
        value: "[{'name': 'localConnector-1.0'}, {'name': 'el-3.0'}, {'name': 'jdbc-4.1'},\
      \ {'name': 'jsp-2.3'}, {'name': 'jndi-1.0'}, {'name': 'servlet-3.1'}, {'name':\
      \ 'transportSecurity-1.0'}, {'name': 'concurrent-1.0'}, {'name': 'javaMail-1.5'},\
      \ {'name': 'beanValidation-1.1'}]"
      - type: xlrelease.StringVariable
        key: biz_ext_appLayer
        requiresValue: false
        showOnReleaseStart: false
        value: biz
      - type: xlrelease.MapStringStringVariable
        key: biz_extra_vars
        requiresValue: false
        showOnReleaseStart: false
        value:
          ext_artifactId: "${ext_artifactId}"
          biz_jvmClassLoader: "${biz_jvmClassLoader}"
          biz_alterconfig: "${biz_alterconfig}"
          biz_jvmEnabledFeaturesList: "${biz_jvmEnabledFeaturesList}"
          env: "${env}"
          ap_code: "${ap_code}"
          ext_environnement: "${ext_environnement}"
          ext_sharedLib_binary_url: "${ext_sharedLib_binary_url}"
          trigram: "${trigram}"
          ext_isRelease: "${ext_isRelease}"
          ext_ear_binary_url: "${ext_ear_binary_url}"
          ext_appVersion: "${release_version}"
          biz_autoExpand: "${biz_autoExpand}"
          ext_chainNum: "${ext_chainNum}"
          biz_modlib: "${biz_modlib}"
          ext_artifactPath: "${ext_artifactPath}"
          biz_jndiEntryList: "${biz_jndiEntryList}"
          ext_projectID: "${ext_projectID}"
          ext_appenv: "${ext_appenv}"
          ansible_python_interpreter: "${ansible_python_interpreter}"
          biz_jndiEntry: "${biz_jndiEntry}"
          code5car: "${code5car}"
          biz_safResource: "${biz_safResource}"
          ext_sharedLibEnv: "${ext_sharedLibEnv}"
          ext_appLayer: "${biz_ext_appLayer}"
          biz_contextRoot: "${biz_contextRoot}"
          biz_ModuleName: "${biz_ModuleName}"
          biz_xcaliaResource: "${biz_xcaliaResource}"
          biz_sharedModuleName: "${biz_sharedModuleName}"
          codeAP: "${codeAP}"
      - type: xlrelease.StringVariable
        key: version
        requiresValue: false
        showOnReleaseStart: false
    allowPasswordsInAllFields: true
    disableNotifications: true
    scriptUsername: RunAsUser
    variableMapping:
      scriptUserPassword: "${global.RunAsUserPassword}"
    riskProfile: Default risk profile
  - template: cd-LibertyCore-AP23882-CARAT-DEPLOY EBX V6 deploy socle
    scheduledStartDate: 2023-07-26T09:00:00+02:00
    dueDate: 2023-07-26T10:00:00+02:00
    phases:
      - phase: "${ext_env}"
        tasks:
          - name: üëâ SET COULOIR
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            team: Release User
            variables:
              - ext_chainNum
          - name: üè≠ SET ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
            team: Release User
            script: |-
              #This action automatically generates create release tasks according to the number of delivery units to deploy
              
              
              
              from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
              from com.xebialabs.xlrelease.api.v1.forms import Variable
              from com.xebialabs.xlrelease.api.v1 import PhaseApi
              
              ####get the environement variable : int / rec / ppd/ prd ###
              phase = getCurrentPhase()
              current_phase = phaseApi.getPhase(phase.id)
              phase_name = current_phase.title
              
              #myenv = phase_name
              env = '${ext_env}'
              myenv = str(env)[0:3]
              
              if myenv == "ppd":
                  envc = "x"
              else:
              
              ##set envc variable from envir
                  envc = myenv[0]
              releaseVariables['ext_envc'] = envc
              envd = envc.upper()
              releaseVariables['ext_envd'] = envd
              
              ##set env variable from phase_name
              if str(myenv) == "int":
                  releaseVariables['ext_environnement'] = "Integration"
                  releaseVariables['env'] = "HORSPROD"
              if str(myenv) == "rec":
                  releaseVariables['ext_environnement'] = "Recette"
                  releaseVariables['env'] = "ISOPROD"
              if str(myenv) == "ppd":
                  releaseVariables['ext_environnement'] = "PreProduction"
                  releaseVariables['env'] = "PROD"
              if str(myenv) == "prd":
                  releaseVariables['ext_environnement'] = "Production"
                  releaseVariables['env'] = "PROD"
              
              
              
              ## Set AAP resources
              
              ## AAP Organization
              var_orga_id = "AAP-id-" + "organizations"
              releaseVariables[var_orga_id] = ""
              
              ## AAP Artifactory credential
              atifactory_cred = "ca-" + '${ap_code}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_cred_name = "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              var_cred_id = "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials"
              releaseVariables[var_cred_name] = atifactory_cred
              releaseVariables[var_cred_id] = ""
              
              ## AAP Job templates
              job_template = "j-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}'
              var_job_template_name = "AAP-name-" + '${AAP-name-organizations}' + "-job_templates"
              var_job_template_id = "AAP-id-" + '${AAP-name-organizations}' + "-job_templates"
              releaseVariables[var_job_template_name] = job_template
              releaseVariables[var_job_template_id] = ""
              
              ## AAP Project
              project = "p-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}'
              var_poject_name = "AAP-name-" + '${AAP-name-organizations}' + "-projects"
              var_poject_id = "AAP-id-" + '${AAP-name-organizations}' + "-projects"
              releaseVariables[var_poject_name] = project
              releaseVariables[var_poject_id] = ""
              
              print str(myenv)
              
              if str(myenv) == "rec":
                  rec_chainNum = '${ext_chainNum}'
                  if map(int,str(rec_chainNum))[0] == 0:
                      ext_chainNum = rec_chainNum[1]
                  else:
                      ext_chainNum = rec_chainNum
                      print str(ext_chainNum)
              
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(myenv).upper() + str(ext_chainNum)
              else:
                  inventory = "i-" + '${ap_code}' + "-" + '${pipeline}' + "-" + '${ext_projectID}' + "-" + '${AAP-name-organizations}' + "-" + str(myenv).upper()
              
              var_inventory_name = "AAP-name-" + '${AAP-name-organizations}' + "-" + str(myenv) + "-inventories"
              var_inventory_id = "AAP-id-" + '${AAP-name-organizations}' + "-" + str(myenv) + "-inventories"
              releaseVariables[var_inventory_name] = inventory
              releaseVariables[var_inventory_id] = ""
              
              ## Phase rename
              release = getCurrentRelease()
              phase = getCurrentPhase()
              phase.title = str(phase_name) + " " + '${ext_chainNum}'
              phaseApi.updatePhase(phase)
          - name: üöß SETTINGS
            type: xlrelease.SequentialGroup
            tasks:
              - name: üõí GET AAP RESOURCES IDs
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Get AAP Resources Ids task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      from com.xebialabs.xlrelease.domain.recover import TaskRecoverOp
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      ##create JsonWebhook tasks to get the ID of the AAP resources
                      for obj in varList:
                          if "AAP-name" in obj.key:
                             resource = obj.value
                             var_name = obj.key
                             type = var_name.split('-')[-1]
                             var_resourceId = var_name.replace("name", "id")
                             if releaseVariables[var_resourceId] == "":
                              api_check_url = "https://ansible-devops.group.echonet/api/v2/" + str(type) + "/?search=" + str(resource)
                              taskCheckResource = taskApi.newTask("webhook.JsonWebhook")
                              taskCheckResource.pythonScript.setProperty("URL", api_check_url)
                              taskCheckResource.pythonScript.setProperty("method", 'GET')
                              taskCheckResource.pythonScript.setProperty("jsonPathExpression", "$" + ".results[0].id")
                              taskCheckResource.variableMapping = {"pythonScript.result" : "$" + "{" + str(var_resourceId) + "}"}
                              taskCheckResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskCheckResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskCheckResource.setTaskFailureHandlerEnabled(True)
                              taskCheckResource.setTaskRecoverOp(TaskRecoverOp.SKIP_TASK)
                              taskCheckResource.title = "get " + str(type) + " " + str(resource)
                              taskApi.addTask(sequentialGroupId, taskCheckResource)
                  - name: üöß GET AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
              - name: üîê SET AAP ARTIFACTORY CREDENTIAL
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Set Credential task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + "organizations":
                              organization_id = obj.value
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                              resource_id = obj.value
                              var_name = obj.key
                              resource_type = var_name.split('-')[-1]
                          if obj.key == "AAP-name-" + '${AAP-name-organizations}' + "-artifactory-credentials":
                              resource_name = obj.value
                              credential_type = '24'
                      body = "\"" + "name" + "\"" + ": " + "\"" + str(resource_name) + "\"" + ", " + "\"" + "organization" + "\"" + ": " + str(organization_id) + ", " + "\"" + "credential_type" + "\"" + ": " + str(credential_type) + ", " + "\"" + "inputs" + "\"" + ": { " + "\"" + "artifact_user" + "\"" + ": " + "\"" + "$" + "{" + "user" + "}" + "\"" + ", " + "\"" + "artifact_password" + "\"" + ": " + "\"" + "$" + "{" + "password" + "}" + "\"" + "}"
                      
                      
                      api_put_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                      taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                      taskUpdateResource.pythonScript.setProperty("URL", api_put_url)
                      taskUpdateResource.pythonScript.setProperty("method", 'PUT')
                      taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                      taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                      taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                      taskUpdateResource.title = "Set credential " + " " + str(resource_name)
                      taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß SET CREDENTIAL GROUP
                    type: xlrelease.SequentialGroup
              - name: ‚úç UPDATE AAP RESOURCES
                type: xlrelease.SequentialGroup
                tasks:
                  - name: üè≠ Update AAP Resources task generator
                    type: xlrelease.ScriptTask
                    script: |-
                      ####get phase name ###
                      phase = getCurrentPhase()
                      current_phase = phaseApi.getPhase(phase.id)
                      phase_name = current_phase.title
                      
                      
                      ## get id of sequential group to insert tasks into & Delete tasks if present
                      sequentialGroupId = None
                      parenttask = getCurrentTask().container
                      for child in parenttask.getAllTasks():
                          if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                              sequentialGroupId = child.id
                          if str(child.type).lower() == "xlrelease.CustomScriptTask".lower():
                              taskApi.delete(child.id)
                      
                      ## Set variables for project update
                      scm_url = '${scm_url}'
                      scm_branch = '${scm_branch}'
                      
                      ## Set variables for job_templae update
                      if "socle" in '${deploy}':
                          playbook = 'deploy_wlc_socle_1T.yml'
                      else:
                          playbook = 'deploy_wlc_appli_1T.yml'
                      
                      ## get all release variables into list
                      varList = releaseApi.getVariables(release.id)
                      
                      
                      for obj in varList:
                          if obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-projects" or obj.key == "AAP-id-" + '${AAP-name-organizations}' + "-job_templates":
                              resource_id = obj.value
                              resource_name = obj.key
                              resource_type = resource_name.split('-')[-1]
                              if "projects" in obj.key:
                                  body = "\"" + "scm_url" + "\"" + ": " + "\"" + str(scm_url) + "\"" + ", " + "\"" + "scm_branch" + "\"" + ": " + "\"" + str(scm_branch) + "\""
                              if "job_templates" in obj.key:
                                  body = "\"" + "playbook" + "\"" + ": " + "\"" + str(playbook) + "\""
                      
                              api_patch_url = "https://ansible-devops.group.echonet/api/v2/" + str(resource_type) + "/" + str(resource_id) + "/"
                              taskUpdateResource = taskApi.newTask("webhook.JsonWebhook")
                              taskUpdateResource.pythonScript.setProperty("URL", api_patch_url)
                              taskUpdateResource.pythonScript.setProperty("method", 'PATCH')
                              taskUpdateResource.pythonScript.setProperty("body", "{" + str(body) + "}")
                              taskUpdateResource.pythonScript.setProperty("username", "$" + "{" + "user" + "}")
                              taskUpdateResource.pythonScript.setProperty("password", "$" + "{" + "password" + "}")
                              taskUpdateResource.title = "update " + " " + str(resource_name)
                              taskApi.addTask(sequentialGroupId, taskUpdateResource)
                  - name: üöß UPDATE AAP RESOURCES GROUP
                    type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
            tasks:
              - name: üè≠ Deploy task generator
                type: xlrelease.ScriptTask
                owner: runasuser
                team: Release User
                script: |-
                  from com.xebialabs.xlrelease.domain.variables import StringVariable, ListStringVariable, MapStringStringVariable, PasswordStringVariable
                  from com.xebialabs.xlrelease.api.v1.forms import Variable
                  from com.xebialabs.xlrelease.api.v1 import PhaseApi
                  
                  releaseId = getCurrentRelease().id
                  
                  ## Set AAP Server env
                  listFolder = releaseId.split('/')
                  FolderId = listFolder[1]
                  ServerName = "devopstc-ansibleAutomation-" + '${env}'
                  aap_server_config = configurationApi.searchByTypeAndTitle("ansibletower.Server",str(ServerName), FolderId)[0]
                  
                  ##get modules to deploy
                  sas_list=releaseVariables['modules_todeploy']
                  
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  
                  if '${deploy}' == "application":
                      myenv = '${ext_env}'
                      my_env = myenv[0:3]
                      if str(my_env) == "int" or str(my_env) == "rec":
                          releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper() + "-" + releaseVariables['ext_chainNum']
                      if str(my_env) == "ppd" or str(my_env) == "prod" :
                          releaseVariables['ext_sharedLibEnv'] = "shared-" + my_env.upper()
                  
                      ## set isRelease variable dynamically
                      if "SNAPSHOT" in '${release_version}':
                          releaseVariables['ext_isRelease'] = "false"
                          releaseVariables['version'] = "SNAPSHOT"
                      else:
                          releaseVariables['ext_isRelease'] = "true"
                          releaseVariables['version'] = "RELEASE"
                  
                  ## get id of sequential group to insert tasks into
                  sequentialGroupId = None
                  parenttask = getCurrentTask().container
                  for child in parenttask.getChildren():
                      if str(child.type).lower() == "xlrelease.SequentialGroup".lower():
                          sequentialGroupId = child.id
                      if str(child.type).lower() == "ansibletower.launchAndWait".lower():
                          taskApi.delete(child.id)
                  
                  #Set AAP resources Ids
                  varList = releaseApi.getVariables(release.id)
                  
                  for obj in varList:
                      if "AAP-id" in obj.key and "credentials" in obj.key:
                          credential_id = obj.value
                      if "AAP-id" in obj.key and "job_templates" in obj.key:
                          job_template_id = obj.value
                      if "AAP-id" in obj.key and "inventories" in obj.key:
                          inventory_id = obj.value
                  
                  for component in sas_list:
                      ##Create task
                      extra_vars = str(component) + "_extra_vars"
                      print releaseVariables[extra_vars]
                      taskUpdateReleaseIds = taskApi.newTask("ansibletower.launchAndWait")
                      taskUpdateReleaseIds.title = 'deploy ' + '${deploy}' + " " + 'on ' + '${ext_env}' + '${ext_chainNum}'
                      taskUpdateReleaseIds.pythonScript.setProperty("ansibletower", aap_server_config)
                      taskUpdateReleaseIds.pythonScript.setProperty("job_template_id",job_template_id)
                      taskUpdateReleaseIds.pythonScript.setProperty("inventory",inventory_id)
                      taskUpdateReleaseIds.pythonScript.setProperty("extra_vars", releaseVariables[extra_vars])
                      taskUpdateReleaseIds.pythonScript.setProperty("credentials", credential_id)
                  
                  
                      ##Add task in sequential group
                      taskApi.addTask(sequentialGroupId, taskUpdateReleaseIds)
              - name: üöÄ DEPLOY GROUP
                type: xlrelease.SequentialGroup
                team: Release User
        color: "#3d6c9e"
    variables:
      - type: xlrelease.StringVariable
        key: AAP-name-organizations
        requiresValue: false
        showOnReleaseStart: false
        value: CARDIF_GDA-OPS
      - type: xlrelease.StringVariable
        key: pipeline
        requiresValue: false
        showOnReleaseStart: false
        value: cd_wlc_xlr
      - type: xlrelease.StringVariable
        key: scm_branch
        showOnReleaseStart: false
        label: branche
        value: del_index
      - type: xlrelease.StringVariable
        key: scm_url
        showOnReleaseStart: false
        label: Repo git url
        value: https://gitlab-dogen.group.echonet/Retail/cardif/moe_carat/e0511_carat/cd_wlc_xlr.git
      - type: xlrelease.StringVariable
        key: user
        label: UID
      - type: xlrelease.PasswordStringVariable
        key: password
        label: password
      - type: xlrelease.StringVariable
        key: deploy
        requiresValue: false
        showOnReleaseStart: false
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - socle
            - application
        value: socle
      - type: xlrelease.StringVariable
        key: release_version
        requiresValue: false
        showOnReleaseStart: false
        label: Version
      - type: xlrelease.StringVariable
        key: ext_envc
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: env
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ext_appVersion
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.ListStringVariable
        key: modules_todeploy
        requiresValue: false
        showOnReleaseStart: false
        label: biz and/or prez
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - biz
        value:
          - biz
      - type: xlrelease.StringVariable
        key: ext_env
        label: Environment
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - int
            - rec
            - ppd
            - prd
      - type: xlrelease.StringVariable
        key: ext_chainNum
        showOnReleaseStart: false
        label: couloir
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "01"
            - "02"
            - "03"
            - "04"
            - "05"
            - "06"
            - "07"
            - "08"
      - type: xlrelease.StringVariable
        key: ext_isRelease
        requiresValue: false
        showOnReleaseStart: false
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "true"
            - "false"
      - type: xlrelease.StringVariable
        key: playbook
        showOnReleaseStart: false
        label: create socle or deploy application
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - deploy
        value: deploy
      - type: xlrelease.StringVariable
        key: other_lane
        showOnReleaseStart: false
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "yes"
            - "no"
      - type: xlrelease.StringVariable
        key: ext_environnement
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ext_appLayer
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ansible_python_interpreter
        requiresValue: false
        showOnReleaseStart: false
        value: /usr/bin/python3
      - type: xlrelease.StringVariable
        key: ext_appenv
        requiresValue: false
        showOnReleaseStart: false
        value: "${ext_env}"
      - type: xlrelease.StringVariable
        key: ap_code
        requiresValue: false
        showOnReleaseStart: false
        value: "AP${codeAP}"
      - type: xlrelease.StringVariable
        key: owner_uid
        showOnReleaseStart: false
        label: Release Owner
        value: "${user}"
      - type: xlrelease.StringVariable
        key: codeAP
        requiresValue: false
        showOnReleaseStart: false
        value: "23882"
      - type: xlrelease.StringVariable
        key: trigram
        requiresValue: false
        showOnReleaseStart: false
        value: rat
      - type: xlrelease.StringVariable
        key: code5car
        requiresValue: false
        showOnReleaseStart: false
        value: rat00
      - type: xlrelease.StringVariable
        key: ext_projectID
        requiresValue: false
        showOnReleaseStart: false
        value: "1212"
      - type: xlrelease.StringVariable
        key: ext_artifactPath
        requiresValue: false
        showOnReleaseStart: false
        value: com/bnpcardif
      - type: xlrelease.StringVariable
        key: ext_artifactId
        requiresValue: false
        showOnReleaseStart: false
        value: "maven-${version}"
      - type: xlrelease.StringVariable
        key: ext_ear_binary_url
        requiresValue: false
        showOnReleaseStart: false
        value: NONE
      - type: xlrelease.StringVariable
        key: ext_sharedLib_binary_url
        requiresValue: false
        showOnReleaseStart: false
        value: NONE
      - type: xlrelease.StringVariable
        key: ext_sharedLibEnv
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: biz_ModuleName
        requiresValue: false
        showOnReleaseStart: false
        value: carat_SERV_EAR
      - type: xlrelease.StringVariable
        key: biz_sharedModuleName
        requiresValue: false
        showOnReleaseStart: false
        value: carat_SERV_EAR
      - type: xlrelease.StringVariable
        key: biz_modlib
        requiresValue: false
        showOnReleaseStart: false
        value: carat
      - type: xlrelease.StringVariable
        key: biz_contextRoot
        requiresValue: false
        showOnReleaseStart: false
        value: /
      - type: xlrelease.StringVariable
        key: biz_jvmClassLoader
        requiresValue: false
        showOnReleaseStart: false
        value: ParentFirst
      - type: xlrelease.StringVariable
        key: biz_alterconfig
        requiresValue: false
        showOnReleaseStart: false
        value: "yes"
      - type: xlrelease.StringVariable
        key: biz_xcaliaResource
        requiresValue: false
        showOnReleaseStart: false
        value: "no"
      - type: xlrelease.StringVariable
        key: biz_autoExpand
        requiresValue: false
        showOnReleaseStart: false
        value: "false"
      - type: xlrelease.StringVariable
        key: biz_jndiEntry
        requiresValue: false
        showOnReleaseStart: false
        value: "no"
      - type: xlrelease.StringVariable
        key: biz_jndiEntryList
        requiresValue: false
        showOnReleaseStart: false
        value: "[{'name': 'string', 'value': 'string'}, {'name': 'string', 'value': 'string'}]"
      - type: xlrelease.StringVariable
        key: biz_safResource
        requiresValue: false
        showOnReleaseStart: false
        value: "no"
      - type: xlrelease.StringVariable
        key: biz_jvmEnabledFeaturesList
        requiresValue: false
        showOnReleaseStart: false
        value: "[{'name': 'localConnector-1.0'}, {'name': 'el-3.0'}, {'name': 'jdbc-4.1'},\
      \ {'name': 'jsp-2.3'}, {'name': 'jndi-1.0'}, {'name': 'servlet-3.1'}, {'name':\
      \ 'transportSecurity-1.0'}, {'name': 'concurrent-1.0'}, {'name': 'javaMail-1.5'},\
      \ {'name': 'beanValidation-1.1'}]"
      - type: xlrelease.StringVariable
        key: biz_ext_appLayer
        requiresValue: false
        showOnReleaseStart: false
        value: biz
      - type: xlrelease.MapStringStringVariable
        key: biz_extra_vars
        requiresValue: false
        showOnReleaseStart: false
        value:
          ext_artifactId: "${ext_artifactId}"
          biz_jvmClassLoader: "${biz_jvmClassLoader}"
          biz_alterconfig: "${biz_alterconfig}"
          biz_jvmEnabledFeaturesList: "${biz_jvmEnabledFeaturesList}"
          env: "${env}"
          ap_code: "${ap_code}"
          ext_environnement: "${ext_environnement}"
          ext_sharedLib_binary_url: "${ext_sharedLib_binary_url}"
          trigram: "${trigram}"
          ext_isRelease: "${ext_isRelease}"
          ext_ear_binary_url: "${ext_ear_binary_url}"
          ext_appVersion: "${release_version}"
          ext_appOptArgs: "${ext_appOptArgs}"
          biz_autoExpand: "${biz_autoExpand}"
          ext_chainNum: "${ext_chainNum}"
          biz_modlib: "${biz_modlib}"
          ext_artifactPath: "${ext_artifactPath}"
          biz_jndiEntryList: "${biz_jndiEntryList}"
          ext_projectID: "${ext_projectID}"
          ext_appenv: "${ext_appenv}"
          ansible_python_interpreter: "${ansible_python_interpreter}"
          optArgs: "${optArgs}"
          biz_jndiEntry: "${biz_jndiEntry}"
          code5car: "${code5car}"
          biz_safResource: "${biz_safResource}"
          ext_sharedLibEnv: "${ext_sharedLibEnv}"
          ext_appLayer: "${biz_ext_appLayer}"
          biz_contextRoot: "${biz_contextRoot}"
          biz_ModuleName: "${biz_ModuleName}"
          biz_xcaliaResource: "${biz_xcaliaResource}"
          biz_sharedModuleName: "${biz_sharedModuleName}"
          codeAP: "${codeAP}"
      - type: xlrelease.StringVariable
        key: version
        requiresValue: false
        showOnReleaseStart: false
      - type: xlrelease.StringVariable
        key: ext_appOptArgs
        requiresValue: false
        showOnReleaseStart: false
        value: force
      - type: xlrelease.StringVariable
        key: optArgs
        requiresValue: false
        showOnReleaseStart: false
        value: "${ext_appOptArgs}"
    allowPasswordsInAllFields: true
    disableNotifications: true
    scriptUsername: runasuser
    variableMapping:
      scriptUserPassword: "${global.RunAsUserPassword}"
    riskProfile: Default risk profile
  - template: test infolivre 3.2
    scheduledStartDate: 2023-12-26T09:00:00+01:00
    dueDate: 2023-12-26T10:00:00+01:00
    phases:
      - phase: dev
        tasks:
          - name: Variables settings
            type: xlrelease.SequentialGroup
            tasks:
              - name: Choose lane
                type: xlrelease.UserInputTask
                description: "Choose on which lane you want to deploy:"
                variables:
                  - chainNum
              - name: Environment variables
                type: xlrelease.ScriptTask
                script: |-
                  #from com.xebialabs.xlrelease.api.v1
                  #import ReleaseApi
                  
                  # get phase name / environment
                  phase = getCurrentPhase()
                  current_phase = phaseApi.getPhase(phase.id)
                  phase_name = current_phase.title
                  releaseVariables['ext_env'] = phase_name
                  
                  ##set ap_code
                  releaseVariables['ap_code'] = "AP" + releaseVariables['codeAP']
                  
                  # Attribute phase name to env variable
                  if str(phase_name) == "dev" or str(phase_name) == 'int':
                      releaseVariables['env'] = "HORSPROD"
                  if str(phase_name) == "rec" or str(phase_name) == 'qualif':
                      releaseVariables['env'] = "ISOPROD"
                  if str(phase_name) == 'ppd' or str(phase_name) == 'prod':
                      releaseVariables['env'] = "PROD"
                  
                  #Attribute hosts according to environment
                  if str(phase_name) == "dev":
                    releaseVariables['hosts'] = releaseVariables['hosts_dev']
                  if str(phase_name) == "rec":
                    releaseVariables['hosts'] = releaseVariables['hosts_rec']
                  if str(phase_name) == "int":
                    releaseVariables['hosts'] = releaseVariables['hosts_int']
                  if str(phase_name) == "ppd":
                    releaseVariables['hosts'] = releaseVariables['hosts_ppd']
                  if str(phase_name) == "prd":
                    releaseVariables['hosts'] = releaseVariables['hosts_prd']
                  
                  
                  #Set if the version is release from url input
                  if "SNAPSHOT" in '${binary_url}':
                      releaseVariables['isRelease'] = "false"
                  else:
                      releaseVariables['isRelease'] = "true"
                  
                  # abort if snapshot in production environment
                  
                  #if (releaseVariables['env'] == "PROD" and releaseVariables['isRelease'] == "false"):
                  #   #comment = "Attention: You are deploying a SNAPSHOT in a PRODUCTION environment, Aborting phase..."
                  #   #task.getRelease().addComment(comment)
                  
                  #  # abort phase
                  #   current_phase = phaseApi.getPhase(phase.id)
                  #   releaseAp.abortCurrentPhase(current_phase, "Attention: You are deploying a SNAPSHOT in a PRODUCTION environment, Aborting phase..."
                  
                  ####Set envc /envd variables
                  #envc = phase_name[0].lower()
                  #releaseVariables['ext_envc'] = envc
                  #
                  #envd = phase_name[0].capitalize()
                  #releaseVariables['ext_envd'] = envd
                  #
                  ######>>>>>>
          - name: Deploy Infolivre
            type: ansibletower.launchAndWait
            ansibletower: devopstc-ansibleAutomation-HORSPROD
            job_template_id: j-AP06578-infolivre-HORSPROD
            extra_vars:
              isRelease: "${isRelease}"
              replace_and_delete: "${replace_and_delete}"
              appVersion: "${appVersion}"
              env: "${env}"
              etl: "${etl}"
              ap_code: "${ap_code}"
              projectID: "${projectID}"
              code5car: "${code5car}"
              rollback: "${rollback}"
              binary_url: "${binary_url}"
              ext_appRep: "${ext_appRep}"
              trigram: "${trigram}"
              ext_env: "${ext_env}"
              apCode: "${codeAP}"
              ext_nom_tns: '""'
              appName: "${appName}"
              chainNum: "${chainNum}"
              hosts: "${hosts}"
            credentials:
              - "${cred_artifact}"
          - name: Rollback
            type: xlrelease.SequentialGroup
            tasks:
              - name: Do you want to rollback?
                type: xlrelease.UserInputTask
                description: Please enter the required information below.
                variables:
                  - rollback
              - name: Rollback
                type: ansibletower.launchAndWait
                ansibletower: devopstc-ansibleAutomation-HORSPROD
                job_template_id: j-AP06578-infolivre-rollback-HORSPROD
                extra_vars:
                  isRelease: "${isRelease}"
                  replace_and_delete: "${replace_and_delete}"
                  appVersion: "${appVersion}"
                  env: "${env}"
                  etl: "${etl}"
                  ap_code: "${ap_code}"
                  projectID: "${projectID}"
                  code5car: "${code5car}"
                  rollback: "${rollback}"
                  binary_url: "${binary_url}"
                  ext_appRep: "${ext_appRep}"
                  trigram: "${trigram}"
                  ext_env: "${ext_env}"
                  apCode: "${codeAP}"
                  ext_nom_tns: '""'
                  appName: "${appName}"
                  chainNum: "${chainNum}"
                  hosts: "${hosts}"
                credentials:
                  - "${cred_artifact}"
                precondition: "releaseVariables['rollback'] == True"
        color: "#3d6c9e"
      - phase: int
        tasks:
          - name: üëâ CHOOSE LANE
            type: xlrelease.UserInputTask
            description: Please enter the required information below.
            variables:
              - chainNum
          - name: üè≠ ENV & AAP VARIABLES
            type: xlrelease.ScriptTask
          - name: ‚ö° SETTINGS
            type: xlrelease.SequentialGroup
          - name: üöÄ DEPLOY
            type: xlrelease.SequentialGroup
        color: "#3d6c9e"
    variables:
      - type: xlrelease.StringVariable
        key: codeAP
        showOnReleaseStart: false
        label: AP Code of the application
        description: set once
        value: "06758"
      - type: xlrelease.StringVariable
        key: projectID
        showOnReleaseStart: false
        label: Project ID of the devops space
        description: set once
        value: "1362"
      - type: xlrelease.StringVariable
        key: trigram
        showOnReleaseStart: false
        label: Trigram of the application
        description: set once
        value: das
      - type: xlrelease.StringVariable
        key: code5car
        showOnReleaseStart: false
        label: Pentagram of the application
        description: set once
        value: das01
      - type: xlrelease.StringVariable
        key: appName
        showOnReleaseStart: false
        label: Application name
        value: DAAS_INFOLIVRE
      - type: xlrelease.StringVariable
        key: cred_artifact
        showOnReleaseStart: false
        label: Credential used to execute the ansible playbook
        value: "7194"
      - type: xlrelease.StringVariable
        key: env
        showOnReleaseStart: false
        label: Ansible Environment
        description: set dynamically
      - type: xlrelease.StringVariable
        key: ext_env
        showOnReleaseStart: false
        label: Environment
        description: set dynamically
      - type: xlrelease.StringVariable
        key: binary_url
        label: Zip Url in Artifactory
      - type: xlrelease.StringVariable
        key: chainNum
        showOnReleaseStart: false
        label: Lane number
        description: Number of targeted lane
        valueProvider:
          type: xlrelease.ListOfStringValueProviderConfiguration
          values:
            - "01"
            - "02"
            - "03"
            - "04"
            - "05"
            - "06"
            - "07"
            - "08"
            - "09"
      - type: xlrelease.StringVariable
        key: isRelease
        showOnReleaseStart: false
        label: Is the version you are deploying a Release?
        description: set dynamically
      - type: xlrelease.BooleanVariable
        key: rollback
        showOnReleaseStart: false
        label: Check if you want to perform a rollback
        description: Variable to execute rollback
      - type: xlrelease.BooleanVariable
        key: replace_and_delete
        label: Do you want to perform a full delivery (replace and delete)
        description: Check this parameter if you want to make a full delivery
      - type: xlrelease.StringVariable
        key: appVersion
        label: Application Version
        description: Application Version
      - type: xlrelease.ListStringVariable
        key: hosts
        showOnReleaseStart: false
        label: List of hosts
        description: Add target host
      - type: xlrelease.ListStringVariable
        key: hosts_dev
        showOnReleaseStart: false
        label: Lists of hosts for dev environment
      - type: xlrelease.ListStringVariable
        key: hosts_int
        showOnReleaseStart: false
        label: List of hosts for int environment
      - type: xlrelease.ListStringVariable
        key: hosts_rec
        showOnReleaseStart: false
        label: Lists of hosts for rec environnement
      - type: xlrelease.ListStringVariable
        key: hosts_ppd
        requiresValue: false
        showOnReleaseStart: false
        label: List of hosts for ppd environment
      - type: xlrelease.ListStringVariable
        key: hosts_prd
        requiresValue: false
        showOnReleaseStart: false
        label: List of hosts for prd environment
      - type: xlrelease.BooleanVariable
        key: etl
        label: Check if ETL
        description: Check if the application is part of ETL
      - type: xlrelease.StringVariable
        key: ext_appRep
        requiresValue: false
        showOnReleaseStart: false
        label: application folder (only if etl)
      - type: xlrelease.StringVariable
        key: ap_code
        label: Extra vars
        description: "A map that represents a JSON or YAML formatted dictionary (with\
      \ escaped parentheses) which includes variables given by the user, including\
      \ answers to survey questions"
    allowPasswordsInAllFields: true
    scriptUsername: runasuser
    variableMapping:
      scriptUserPassword: "${global.RunAsUserPassword}"
    riskProfile: Default risk profile
  - name: tag trigger
    type: gitlab.TagTrigger
    enabled: false
    releaseTitle: "Deploy Draft Control-M ${tagName}"
    template: Control-M-AP23882-CARAT-DEPLOY EBX V6
    releaseFolder: ./
    gitlab_server: devopstc-gitlab
    project_id: 62849
